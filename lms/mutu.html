<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Penilai Mutu - LMS Nakula</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
  /* --- THEME VARIABLES (Royal Blue for Quality) --- */
  :root { 
    --primary: #2563eb; /* Royal Blue */
    --primary-light: #dbeafe; 
    --accent: #f59e0b; /* Amber */
    --bg-body: #f8fafc; 
    --surface: #ffffff;
    --text-main: #1e293b;
    --text-muted: #64748b;
    --radius: 16px;
    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  }

  body { 
    background-color: var(--bg-body); 
    font-family: 'Poppins', sans-serif; 
    color: var(--text-main);
    padding-bottom: 80px; 
  }

  .hidden { display: none !important; }
  .fw-medium { font-weight: 500; }
  
  /* --- COMPONENTS --- */
  .btn-gradient { 
    background: linear-gradient(135deg, var(--primary) 0%, #1d4ed8 100%); 
    color: white; border: none; border-radius: 50px; 
    padding: 12px 24px; font-weight: 600; width: 100%; 
    transition: all 0.3s ease; box-shadow: var(--shadow-md);
  }
  .btn-gradient:active { transform: scale(0.98); }
  
  .card-pro { 
    border: none; border-radius: var(--radius); 
    background: var(--surface); 
    box-shadow: var(--shadow-sm);
    transition: transform 0.2s;
    overflow: hidden; 
  }

  /* --- LOGIN --- */
  .login-wrapper {
    min-height: 100vh;
    background: linear-gradient(135deg, #eff6ff 0%, #f1f5f9 100%);
    display: flex; align-items: center; justify-content: center;
    padding: 20px;
  }
  .card-login {
    width: 100%; max-width: 400px;
    background: rgba(255, 255, 255, 0.95);
    padding: 2.5rem; border-radius: 24px; box-shadow: var(--shadow-md);
    text-align: center;
  }

  /* --- DASHBOARD --- */
  .header-card { 
    background: var(--surface); padding: 1rem 1.5rem; 
    border-radius: var(--radius); display: flex; justify-content: space-between; align-items: center; 
    margin-bottom: 2rem; box-shadow: var(--shadow-sm); border-bottom: 3px solid var(--primary-light);
  }

  .card-category {
    cursor: pointer; padding: 2rem; height: 100%;
    display: flex; flex-direction: column; align-items: center; text-align: center;
    border: 2px solid transparent; transition: all 0.3s;
    background: var(--surface);
  }
  .card-category:hover { border-color: var(--primary); transform: translateY(-5px); box-shadow: var(--shadow-md); }
  .cat-icon { font-size: 3rem; margin-bottom: 1rem; color: var(--primary); }

  /* List Item */
  .list-item { border-left: 4px solid transparent; transition: background 0.2s; cursor: pointer;}
  .list-item:hover { background-color: #f1f5f9; }
  .list-item.status-wait { border-left-color: var(--accent); }
  .list-item.status-done { border-left-color: var(--primary); }
  .list-item.status-rev { border-left-color: #ef4444; }

  .badge-soft-warning { background-color: #fffbeb; color: #b45309; border: 1px solid #fcd34d; }
  .badge-soft-success { background-color: #ecfdf5; color: #047857; border: 1px solid #6ee7b7; }
  .badge-soft-danger { background-color: #fef2f2; color: #b91c1c; border: 1px solid #fca5a5; }

  #loading { z-index: 9999; backdrop-filter: blur(2px); }
</style>
</head>
<body>

<div id="loading" class="position-fixed top-0 start-0 w-100 h-100 bg-white bg-opacity-75 d-none justify-content-center align-items-center">
    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
</div>

<div id="view-login" class="login-wrapper">
  <div class="card-login">
    <div class="bg-primary bg-opacity-10 text-primary rounded-4 d-inline-flex p-3 mb-3">
        <i class="bi bi-patch-check-fill fs-1"></i>
    </div>
    <h3 class="fw-bold mb-1" style="color:var(--primary)">Penilai Mutu</h3>
    <p class="text-muted small mb-4">Evaluasi Inovasi & Implementasi</p>
    
    <div class="form-floating mb-4">
      <input type="number" id="inputPIN" class="form-control fw-bold text-center" placeholder="PIN" style="letter-spacing: 4px; height: 60px; font-size: 1.5rem;">
      <label for="inputPIN" class="w-100 text-center">PIN AKSES</label>
    </div>
    
    <button onclick="doLogin()" class="btn-gradient">MASUK PANEL MUTU</button>
  </div>
</div>

<div id="view-main" class="hidden container mt-4">
    
    <div class="header-card">
      <div class="d-flex align-items-center gap-3">
        <div class="bg-primary-subtle text-primary rounded-circle d-flex align-items-center justify-content-center flex-shrink-0" style="width:45px;height:45px;">
            <i class="bi bi-shield-check fs-5"></i>
        </div>
        <div style="min-width: 0;">
            <div class="text-muted small lh-1">Validator Mutu,</div>
            <div class="fw-bold text-dark text-truncate" id="txtNama">...</div>
        </div>
      </div>
      <button onclick="doLogout()" class="btn btn-sm btn-outline-danger rounded-pill px-3 fw-medium">
        <i class="bi bi-box-arrow-right"></i> Keluar
      </button>
    </div>

    <div id="view-home">
       <h5 class="fw-bold mb-4 text-dark">Kategori Penilaian</h5>
       <div class="row g-4">
           <div class="col-md-6">
               <div class="card-pro card-category" onclick="openCategory('Implementasi KKG')">
                   <div class="cat-icon"><i class="bi bi-person-video3"></i></div>
                   <h4 class="fw-bold mb-2">Implementasi KKG</h4>
                   <p class="text-muted small mb-3">Laporan penerapan hasil materi diklat di kelas.</p>
                   <span class="badge rounded-pill bg-light text-dark border px-3 py-2" id="badge-imp">Memuat...</span>
               </div>
           </div>
           <div class="col-md-6">
               <div class="card-pro card-category" onclick="openCategory('Karya Inovasi')">
                   <div class="cat-icon"><i class="bi bi-lightbulb"></i></div>
                   <h4 class="fw-bold mb-2">Karya Inovasi</h4>
                   <p class="text-muted small mb-3">Karya orisinil, alat peraga, atau metode baru.</p>
                   <span class="badge rounded-pill bg-light text-dark border px-3 py-2" id="badge-inov">Memuat...</span>
               </div>
           </div>
       </div>
    </div>

    <div id="view-list" class="hidden">
       <div class="card-pro p-3 mb-4 d-flex align-items-center shadow-sm" style="border-left: 5px solid var(--primary);">
          <button onclick="backToHome()" class="btn btn-light rounded-circle me-3 shadow-sm border flex-shrink-0" style="width:40px;height:40px;">
            <i class="bi bi-arrow-left"></i>
          </button>
          <div style="min-width: 0;">
              <div class="text-muted small lh-1">Kategori Aktif</div>
              <div class="fw-bold text-dark text-truncate" id="lbl-active-cat">...</div>
          </div>
       </div>
       
       <div id="list-container"></div>
    </div>
</div>

<div class="modal fade" id="mdlNilai" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable"> 
        <div class="modal-content border-0 shadow-lg" style="border-radius: 20px; overflow: hidden;">
            
            <div class="modal-header text-white border-0" style="background: var(--primary);">
                <div style="min-width: 0;">
                    <h5 class="modal-title fw-bold"><i class="bi bi-award me-2"></i>Penilaian Mutu</h5>
                    <small class="opacity-75">Blind Review (Identitas Disembunyikan)</small>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body p-0">
                <div class="bg-light p-4 border-bottom">
                    <div class="d-flex align-items-center justify-content-between mb-2">
                        <span class="badge bg-white text-primary border shadow-sm px-2 py-1">ID PESERTA</span>
                        <small class="text-muted fw-bold" id="n_display_nama">#ID-XXXX</small>
                    </div>
                    
                    <h6 class="fw-bold text-dark mb-3 lh-base text-break" id="n_display_judul">Judul Karya...</h6>
                    
                    <div class="p-3 bg-white rounded border border-light shadow-sm">
                        <small class="text-muted d-block mb-1 fw-bold" style="font-size: 0.7rem;">DESKRIPSI KARYA / IMPLEMENTASI:</small>
                        <div id="n_display_desc" class="text-secondary small text-break" style="line-height: 1.6; max-height: 200px; overflow-y:auto; white-space: pre-wrap;">...</div>
                    </div>

                    <div id="n_display_link_container" class="mt-3 hidden">
                         <a href="#" target="_blank" id="n_display_link" class="btn btn-outline-primary btn-sm w-100 border-2 fw-medium text-truncate">
                            <i class="bi bi-box-arrow-up-right me-2"></i>Lihat Bukti Karya
                         </a>
                    </div>
                </div>

                <div class="p-4">
                    <input type="hidden" id="n_id">
                    
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-muted ls-1">KUALITAS KARYA</label>
                        <select id="n_huruf" class="form-select form-select-lg fw-bold border-2" style="color:var(--primary);">
                            <option value="A">A - Sangat Baik (Inovatif)</option>
                            <option value="B">B - Baik (Sesuai Standar)</option>
                            <option value="C">C - Cukup (Perlu Peningkatan)</option>
                            <option value="D" class="text-danger">D - Revisi (Belum Layak)</option>
                        </select>
                    </div>

                    <div class="mb-4">
                        <label class="form-label small fw-bold text-muted ls-1">UMPAN BALIK MUTU (WAJIB)</label>
                        <textarea id="n_feed" class="form-control bg-light" rows="3" placeholder="Berikan masukan konstruktif untuk pengembangan..."></textarea>
                    </div>

                    <button onclick="saveNilai()" class="btn btn-gradient py-3 shadow-md">
                        <i class="bi bi-send-check-fill me-2"></i>KIRIM HASIL
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// --- KONFIGURASI ---
const GAS_URL = "https://script.google.com/macros/s/AKfycbyk0nTT7ZTkH_5BOnjcpS8trcH_-gPtKgzy0PC6K5J93xUIBTUdx4gZ9VkvH2le3ftE/exec"; 

let USER={}, modalNi, ALL_TASKS=[];

window.onpopstate = function(event) {
    if (!document.getElementById('view-list').classList.contains('hidden')) backToHome();
};

window.onload = () => {
  modalNi = new bootstrap.Modal(document.getElementById('mdlNilai'));
  let s = localStorage.getItem('LMS_MUTU_PIN'); 
  if(s) { document.getElementById('inputPIN').value = s; doLogin(true); }
}

async function apiCall(a, p = {}) { 
    try { 
        let r = await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action: a, ...p }) }); 
        return await r.json(); 
    } catch(e) { console.error(e); return null; } 
}

function showLoad(x){ 
    const el = document.getElementById('loading');
    x ? (el.classList.remove('d-none'), el.classList.add('d-flex')) : (el.classList.add('d-none'), el.classList.remove('d-flex'));
}

/* --- AUTH --- */
async function doLogin(auto){
  let p = document.getElementById('inputPIN').value;
  if(!p) return Swal.fire('Perhatian', 'Masukkan PIN', 'warning');

  showLoad(true); 
  let r = await apiCall("login", { pin: p }); 
  showLoad(false);

  if(r && r.sukses && (r.role === 'PENILAI' || r.role === 'ADMIN')) {
    localStorage.setItem('LMS_MUTU_PIN', p); 
    USER = { nama: r.nama, pin: p };
    
    document.getElementById('view-login').classList.add('hidden');
    document.getElementById('view-main').classList.remove('hidden');
    document.getElementById('txtNama').innerText = r.nama; 
    loadData(); 
  } else if(!auto) { 
    Swal.fire('Akses Ditolak','PIN Tidak Valid','error'); 
  }
}

function doLogout(){ 
    if(confirm('Keluar dari panel mutu?')) { localStorage.removeItem('LMS_MUTU_PIN'); location.reload(); }
}

/* --- DATA LOGIC --- */
async function loadData() {
  showLoad(true); 
  let data = await apiCall("getDashboardPenilai"); 
  showLoad(false);

  if(data && data.tugas) {
    ALL_TASKS = data.tugas;
    updateBadges();
  } else { Swal.fire('Error', 'Gagal memuat data', 'error'); }
}

function updateBadges() {
    let imp = ALL_TASKS.filter(t => t.jenis === 'Implementasi KKG' && t.status === 'Menunggu').length;
    let inov = ALL_TASKS.filter(t => t.jenis === 'Karya Inovasi' && t.status === 'Menunggu').length;
    
    document.getElementById('badge-imp').innerText = imp > 0 ? `${imp} Menunggu` : 'Semua Dinilai';
    document.getElementById('badge-imp').className = imp > 0 ? "badge rounded-pill bg-danger border px-3 py-2" : "badge rounded-pill bg-light text-dark border px-3 py-2";
    
    document.getElementById('badge-inov').innerText = inov > 0 ? `${inov} Menunggu` : 'Semua Dinilai';
    document.getElementById('badge-inov').className = inov > 0 ? "badge rounded-pill bg-danger border px-3 py-2" : "badge rounded-pill bg-light text-dark border px-3 py-2";
}

function openCategory(cat) {
    history.pushState({page: 'list'}, '', '#list');
    document.getElementById('view-home').classList.add('hidden'); 
    document.getElementById('view-list').classList.remove('hidden');
    document.getElementById('lbl-active-cat').innerText = cat;
    
    // Filter hanya jenis yang sesuai
    let filtered = ALL_TASKS.filter(t => t.jenis === cat);
    renderList(filtered, 'list-container'); 
    window.scrollTo(0,0);
}

function backToHome() { 
    history.back(); 
    document.getElementById('view-list').classList.add('hidden'); 
    document.getElementById('view-home').classList.remove('hidden'); 
    updateBadges();
}

function renderList(data, id) {
  let el = document.getElementById(id); let html = "";
  // Sort: Menunggu paling atas
  data.sort((a,b) => (a.status==='Menunggu' ? -1 : 1));
  
  data.forEach(item => {
    let st = item.status;
    let badgeClass = st==='Menunggu' ? 'badge-soft-warning' : (st==='Diterima' ? 'badge-soft-success' : 'badge-soft-danger');
    let borderClass = st==='Menunggu' ? 'status-wait' : (st==='Diterima' ? 'status-done' : 'status-rev');
    let iconStatus = st==='Menunggu' ? '<i class="bi bi-hourglass-split me-1"></i>' : '<i class="bi bi-check-circle me-1"></i>';

    // BLIND REVIEW: Masking Nama
    let displayID = "Peserta #" + item.id.substring(0, 8);

    html += `
    <div class="card-pro p-3 mb-3 list-item ${borderClass}" onclick="popNilai('${item.id}')">
      <div class="d-flex justify-content-between align-items-start">
        <div class="pe-2 w-100" style="min-width:0;">
           <div class="d-flex align-items-center mb-2">
               <span class="badge ${badgeClass} rounded-pill py-1 px-2 d-flex align-items-center" style="font-size:0.65rem">${iconStatus} ${st.toUpperCase()}</span>
               <span class="text-muted ms-2 small fw-bold" style="font-size:0.7rem">${displayID}</span>
           </div>
           <div class="fw-bold text-dark mb-1 text-break" style="font-size: 0.95rem;">${item.judul}</div>
           <div class="text-muted small text-truncate">${item.catatan ? item.catatan : '<i>Tidak ada deskripsi</i>'}</div>
        </div>
        <button class="btn btn-light text-primary rounded-circle shadow-sm ms-2 flex-shrink-0" style="width:40px; height:40px;">
            <i class="bi bi-star"></i>
        </button>
      </div>
    </div>`;
  });
  el.innerHTML = html || `<div class="text-center py-5"><h6 class="text-muted">Tidak ada data di kategori ini.</h6></div>`;
}

function popNilai(id){ 
    let item = ALL_TASKS.find(t => t.id === id);
    if(!item) return;

    document.getElementById('n_display_nama').innerText = "Peserta #" + item.id.substring(0, 8);
    document.getElementById('n_display_judul').innerText = item.judul;
    document.getElementById('n_display_desc').innerText = item.catatan || "Tidak ada deskripsi.";

    let linkContainer = document.getElementById('n_display_link_container');
    let linkBtn = document.getElementById('n_display_link');
    if(item.link && item.link.length > 5) {
        linkContainer.classList.remove('hidden');
        linkBtn.href = item.link;
    } else { linkContainer.classList.add('hidden'); }

    document.getElementById('n_id').value = id; 
    document.getElementById('n_feed').value = ""; 
    document.getElementById('n_huruf').value = "A"; 
    modalNi.show(); 
}

async function saveNilai(){
  let id = document.getElementById('n_id').value;
  let h = document.getElementById('n_huruf').value;
  let note = document.getElementById('n_feed').value;
  
  if(!note && h === 'D') { Swal.fire('Wajib','Berikan alasan jika Revisi','warning'); return; }

  let st = (h==='D') ? 'Revisi' : 'Diterima';
  let feed = `[Kualitas: ${h}] ` + note;

  modalNi.hide(); 
  // Update UI lokal
  let idx = ALL_TASKS.findIndex(i => i.id === id); 
  if(idx !== -1) { ALL_TASKS[idx].status = st; }
  
  // Refresh List
  let currentCat = document.getElementById('lbl-active-cat').innerText;
  renderList(ALL_TASKS.filter(t => t.jenis === currentCat), 'list-container');
  
  Swal.fire({title:'Tersimpan', icon:'success', timer:1000, showConfirmButton: false, toast:true, position:'top-end'});
  
  await apiCall("simpanNilai", { id: id, status: st, feedback: feed, adminName: USER.nama });
}
</script>
</body>
</html>
