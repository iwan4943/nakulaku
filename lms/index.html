<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Portal Guru & KS - LMS Nakula</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
  :root {
    --primary: #B3261E; 
    --primary-container: #FFDAD6;
    --on-primary-container: #410E0B;
    --bg: #FFF8F6; 
    --card: #FFFFFF; 
    --text: #201A19;
  }

  body { background-color: var(--bg); font-family: 'Poppins', sans-serif; color: var(--text); padding-bottom: 80px; }
  .hidden { display: none !important; }

  /* Card Style */
  .card-pro { 
    border: none; border-radius: 24px; 
    background: var(--card); 
    box-shadow: 0 2px 8px rgba(0,0,0,0.04); 
    margin-bottom: 1rem; 
    transition: transform 0.2s;
  }
  
  /* HEADER ICON FIX (AGAR TIDAK LONJONG) */
  .header-icon {
    width: 50px; height: 50px; /* Ukuran Fix */
    min-width: 50px; /* Mencegah penyusutan */
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 1.5rem;
  }

  /* LOGO LOGIN FIX */
  .login-logo {
    width: 80px; height: 80px;
    min-width: 80px;
    border-radius: 20px; /* Rounded kotak */
    display: flex; align-items: center; justify-content: center;
    font-size: 2.5rem;
  }

  .header-card {
    background: var(--card); padding: 1rem 1.2rem; 
    border-radius: 24px; 
    display: flex; justify-content: space-between; align-items: center; 
    margin-bottom: 1.5rem; 
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  }

  /* Form Elements */
  .form-control-pro { background-color: #F3E5E5; border: 2px solid transparent; border-radius: 16px; padding: 12px; font-size: 0.95rem; }
  .form-control-pro:focus { background-color: #fff; border-color: var(--primary); box-shadow: none; }
  
  /* Buttons */
  .btn-gradient { 
    background: var(--primary); color: white; 
    border-radius: 50px; padding: 12px 24px; 
    font-weight: 600; border: none; width: 100%;
    box-shadow: 0 4px 10px rgba(179, 38, 30, 0.2); 
  }
  .btn-gradient:hover { background: #901B15; transform: translateY(-1px); }

  /* Navigation Pills */
  .nav-pills .nav-link { color: #524343; border-radius: 50px; padding: 10px 16px; font-weight: 600; font-size: 0.85rem; transition: all 0.2s; }
  .nav-pills .nav-link.active { background-color: var(--primary-container); color: var(--on-primary-container); }

  /* Badges & Status */
  .badge-role { padding: 6px 14px; border-radius: 12px; font-weight: 600; font-size: 0.7rem; text-transform: uppercase; }
  .role-guru { background: #E8DEF8; color: #1D192B; } 
  .role-ks { background: #FEE4C1; color: #744C00; } 
  
  .status-pill { padding: 5px 12px; border-radius: 50px; font-size: 0.7rem; font-weight: 700; display: inline-block;}
  .st-ok { background: #C3EED0; color: #0F5223; }
  .st-wait { background: #FEE4C1; color: #744C00; }
  .st-rev { background: #F9DEDC; color: #8C1D18; }
  
  .modal-content { border-radius: 28px; border: none; }
  .text-primary-custom { color: var(--primary) !important; }
</style>
</head>
<body>

<div id="loading" class="position-fixed top-0 start-0 w-100 h-100 bg-white bg-opacity-90 d-none justify-content-center align-items-center" style="z-index:9999;">
  <div class="spinner-border text-danger" role="status"></div>
</div>

<div id="view-login" class="container d-flex flex-column justify-content-center" style="min-height: 100vh;">
  <div class="row justify-content-center"><div class="col-md-5">
    <div class="text-center mb-5">
        <div class="login-logo bg-danger-subtle text-danger mx-auto mb-3">
            <i class="bi bi-mortarboard-fill"></i>
        </div>
        <h4 class="fw-bold" style="color: var(--text);">LMS GUGUS NAKULA</h4>
        <p class="small text-muted">Portal Kinerja Guru & KS</p>
    </div>
    <div class="card-pro px-4 py-5 mx-2">
      <label class="d-block text-center small fw-bold mb-3 text-primary-custom" style="letter-spacing: 1px;">MASUKKAN PIN ANDA</label>
      <input type="number" id="inputPIN" class="form-control form-control-pro text-center mb-4 fw-bold" placeholder="• • • • • •" style="letter-spacing: 5px; font-size: 1.5rem;">
      <button onclick="doLogin()" class="btn btn-gradient">MASUK APLIKASI</button>
    </div>
  </div></div>
</div>

<div id="view-main" class="hidden container mt-3">
    <div class="header-card">
      <div class="d-flex align-items-center">
        <div class="header-icon bg-danger-subtle text-danger me-3">
            <i class="bi bi-person-circle"></i>
        </div>
        <div style="line-height: 1.1;">
            <div class="fw-bold text-dark">LMS Nakula</div>
            <div class="text-muted small" id="txtNama">User</div>
        </div>
      </div>
      <div class="text-end">
        <span id="txtRoleBadge" class="badge-role role-guru mb-1 d-block">GURU</span>
        <a href="#" onclick="doLogout()" class="text-danger fw-bold small text-decoration-none" style="font-size: 0.7rem;">Keluar</a>
      </div>
    </div>
    <span id="txtSekolah" class="hidden"></span>
    
    <div id="panel-guru" class="hidden">
      <div class="card-pro p-4 mb-3" style="background-color: var(--primary); color: white;">
        <div class="row align-items-center">
          <div class="col-8">
            <span class="small fw-bold text-white-50 text-uppercase">CAPAIAN KINERJA</span>
            <h1 class="fw-bold mt-1 mb-0 display-4" id="txt-persen">0%</h1>
            <div class="progress mt-3 mb-3" style="height: 8px; border-radius: 20px; background-color: rgba(255,255,255,0.2);">
                <div id="bar-guru" class="progress-bar bg-white" role="progressbar" style="width: 0%; border-radius: 20px;"></div>
            </div>
            <div class="d-flex align-items-center"><span class="badge bg-white text-danger border-0 me-2 rounded-pill px-3" id="txt-target">0/0</span><small class="text-white-50">Selesai</small></div>
          </div>
          <div class="col-4 text-end opacity-25"><i class="bi bi-bar-chart-fill" style="font-size: 4rem; color: #fff;"></i></div>
        </div>
      </div>
      
      <ul class="nav nav-pills nav-fill mb-3 p-1">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#g-tab-tugas">Tugas</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#g-tab-implemen">Implemen</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#g-tab-inovasi">Inovasi</button></li>
      </ul>

      <div class="tab-content">
        <div class="tab-pane fade show active" id="g-tab-tugas"><div id="list-kegiatan-guru"></div></div>
        
        <div class="tab-pane fade" id="g-tab-implemen">
           <div class="card-pro p-4">
             <h6 class="fw-bold text-dark mb-4"><i class="bi bi-person-workspace me-2 text-primary"></i>Lapor Implementasi</h6>
             <form id="frmImplemen" onsubmit="submitPengembangan(event, 'Implementasi KKG')">
               <div class="mb-3"><label class="small fw-bold text-muted ms-1">PROGRAM KKG</label><select id="sel-prog-kkg" class="form-select form-control-pro"></select></div>
               <div class="mb-3"><input type="text" id="imp-nama" class="form-control form-control-pro" placeholder="Nama Kegiatan" required></div>
               <div class="mb-3"><input type="text" id="imp-kelas" class="form-control form-control-pro" placeholder="Kelas / Sasaran" required></div>
               <div class="mb-3"><input type="url" id="imp-link" class="form-control form-control-pro" placeholder="Link Bukti (Drive/Youtube)" required></div>
               <div class="mb-4"><textarea id="imp-desc" class="form-control form-control-pro" rows="3" placeholder="Deskripsi Singkat..." required></textarea></div>
               <button class="btn btn-gradient">KIRIM LAPORAN</button>
             </form>
           </div>
        </div>
        
        <div class="tab-pane fade" id="g-tab-inovasi">
           <div class="card-pro p-4">
             <h6 class="fw-bold text-dark mb-3"><i class="bi bi-lightbulb me-2 text-warning"></i>Karya Inovasi</h6>
             <div class="alert alert-light small border mb-3 text-muted">Kirimkan karya terbaik untuk poin tambahan.</div>
             <form id="frmInovasi" onsubmit="submitPengembangan(event, 'Karya Inovasi')">
               <div class="mb-3"><input type="text" id="ino-nama" class="form-control form-control-pro" placeholder="Judul Inovasi" required></div>
               <div class="mb-3"><input type="url" id="ino-link" class="form-control form-control-pro" placeholder="Link Karya" required></div>
               <div class="mb-4"><textarea id="ino-desc" class="form-control form-control-pro" rows="3" placeholder="Deskripsi Inovasi..." required></textarea></div>
               <button class="btn btn-success w-100 py-3 rounded-pill fw-bold">KIRIM KARYA</button>
             </form>
           </div>
        </div>
      </div>
    </div>

    <div id="panel-ks" class="hidden">
      <div class="card-pro p-4 mb-3">
        <div class="d-flex justify-content-between align-items-start">
          <div><span class="text-muted small fw-bold text-uppercase">Capaian Sekolah</span><h1 class="fw-bold mt-1 mb-0 display-4 text-danger" id="ks-persen">0%</h1></div>
          <div class="text-end bg-danger-subtle p-3 rounded-4">
              <h2 class="mb-0 fw-bold text-danger" id="ks-total-laporan">0</h2>
              <small class="fw-bold text-danger-emphasis">LAPORAN</small>
          </div>
        </div>
      </div>
      
      <div class="card-pro p-3 mb-4 bg-primary-subtle border border-primary-subtle">
        <div class="row text-center">
          <div class="col-6 border-end border-primary"><h3 class="fw-bold mb-0 text-primary" id="ks-count-imp">0</h3><small class="text-primary-emphasis">Implementasi</small></div>
          <div class="col-6"><h3 class="fw-bold mb-0 text-primary" id="ks-count-ino">0</h3><small class="text-primary-emphasis">Inovasi</small></div>
        </div>
      </div>
      
      <h6 class="fw-bold text-dark small mb-3 px-2">MANAJEMEN SEKOLAH</h6>
      <div class="row gx-2 mb-4">
        <div class="col-4"><button onclick="bukaModalPrestasi()" class="btn btn-warning w-100 h-100 py-3 text-white fw-bold d-flex flex-column align-items-center justify-content-center"><i class="bi bi-trophy-fill fs-3 mb-1"></i><span style="font-size:0.65rem">PRESTASI</span></button></div>
        <div class="col-4"><button onclick="bukaModalPembiasaan()" class="btn btn-success w-100 h-100 py-3 text-white fw-bold d-flex flex-column align-items-center justify-content-center"><i class="bi bi-calendar-check-fill fs-3 mb-1"></i><span style="font-size:0.65rem">BIAS</span></button></div>
        <div class="col-4"><button onclick="bukaModalEvent()" class="btn btn-primary w-100 h-100 py-3 text-white fw-bold d-flex flex-column align-items-center justify-content-center"><i class="bi bi-balloon-fill fs-3 mb-1"></i><span style="font-size:0.65rem">EVENT</span></button></div>
      </div>

      <div class="d-flex justify-content-between align-items-center mb-2 px-1">
         <ul class="nav nav-pills"><li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#ks-tab-rapor">Rapor Guru</button></li><li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#ks-tab-riwayat">Riwayat Saya</button></li></ul>
         <button onclick="loadKS()" class="btn btn-sm btn-light text-danger rounded-circle shadow-sm" style="width:36px;height:36px"><i class="bi bi-arrow-clockwise"></i></button>
      </div>

      <div class="tab-content mt-2">
        <div class="tab-pane fade show active" id="ks-tab-rapor"><div class="card-pro p-0 overflow-hidden"><div class="table-responsive"><table class="table table-hover align-middle mb-0" style="font-size: 0.85rem;"><thead class="table-light"><tr><th class="ps-3 py-3 border-0">Nama Guru</th><th style="width:35%" class="border-0">Progress</th><th class="text-end pe-4 border-0">Capaian</th></tr></thead><tbody id="tbl-ks" class="border-0"></tbody></table></div></div></div>
        <div class="tab-pane fade" id="ks-tab-riwayat"><div id="list-riwayat-ks"></div></div>
      </div>
    </div>
</div>

<div class="modal fade" id="mdlUpload"><div class="modal-dialog modal-dialog-centered"><div class="modal-content p-4"><h5 class="fw-bold mb-3">Lapor Tugas Gugus</h5><form id="frmUpload" onsubmit="submitTugas(event)"><div class="mb-3"><label class="small fw-bold text-muted ms-1 mb-1">KEGIATAN</label><input name="judul_dokumen" id="inpJudul" class="form-control form-control-pro bg-light fw-bold" readonly><input type="hidden" name="jenis_laporan" value="Kegiatan Gugus"></div><div class="mb-3"><label class="small fw-bold text-muted ms-1 mb-1">LINK BUKTI</label><input type="url" name="link_video" id="inpLink" class="form-control form-control-pro" placeholder="Google Drive / Youtube"></div><div class="mb-4"><label class="small fw-bold text-muted ms-1 mb-1">RANGKUMAN MATERI</label><textarea name="catatan" id="inpCatatan" class="form-control form-control-pro" rows="4" placeholder="Tuliskan rangkuman hasil kegiatan..."></textarea></div><button class="btn btn-gradient">KIRIM TUGAS</button></form></div></div></div>
<div class="modal fade" id="mdlPrestasi"><div class="modal-dialog modal-dialog-centered"><div class="modal-content p-4"><h5 class="fw-bold mb-3 text-warning">Input Prestasi</h5><form id="frmPrestasi" onsubmit="submitPrestasi(event)"><div class="mb-3"><select id="inpSekolahPrestasi" class="form-select form-control-pro"></select></div><div class="mb-3"><input type="text" name="nama_siswa" class="form-control form-control-pro" placeholder="Nama Siswa" required></div><div class="row mb-3"><div class="col-6"><input type="text" name="cabang" class="form-control form-control-pro" placeholder="Cabang" required></div><div class="col-6"><input type="text" name="penyelenggara" class="form-control form-control-pro" placeholder="Penyelenggara" required></div></div><div class="row mb-3"><div class="col-6"><select name="tingkat" class="form-select form-control-pro"><option value="Kecamatan">Kecamatan</option><option value="Kabupaten">Kabupaten</option><option value="Nasional">Nasional</option></select></div><div class="col-6"><select name="juara" class="form-select form-control-pro"><option value="1">Juara 1</option><option value="2">Juara 2</option><option value="3">Juara 3</option></select></div></div><div class="mb-4"><input type="text" name="no_piagam" class="form-control form-control-pro" placeholder="No Piagam" required></div><button class="btn btn-warning w-100 py-3 text-white fw-bold">KIRIM DATA</button></form></div></div></div>
<div class="modal fade" id="mdlPembiasaan"><div class="modal-dialog modal-dialog-centered"><div class="modal-content p-4"><h5 class="fw-bold mb-3 text-success">Lapor Pembiasaan</h5><form id="frmPembiasaan" onsubmit="submitPembiasaan(event)"><div class="mb-3"><select id="inpSekolahBias" class="form-select form-control-pro"></select></div><div class="mb-3"><input type="text" id="bias-nama" class="form-control form-control-pro" placeholder="Nama Program" required></div><div class="row mb-3"><div class="col-6"><select id="bias-freq" class="form-select form-control-pro"><option>Harian</option><option>Mingguan</option><option>Bulanan</option></select></div><div class="col-6"><input type="text" id="bias-karakter" class="form-control form-control-pro" placeholder="Karakter" required></div></div><div class="mb-3"><input type="url" id="bias-link" class="form-control form-control-pro" placeholder="Link Foto/Video" required></div><div class="mb-4"><textarea id="bias-desc" class="form-control form-control-pro" rows="3" placeholder="Keterangan..." required></textarea></div><button class="btn btn-success w-100 py-3 fw-bold">KIRIM DATA</button></form></div></div></div>
<div class="modal fade" id="mdlEvent"><div class="modal-dialog modal-dialog-centered"><div class="modal-content p-4"><h5 class="fw-bold mb-3 text-primary">Lapor Event Sekolah</h5><form id="frmEvent" onsubmit="submitEvent(event)"><div class="mb-3"><select id="inpSekolahEvent" class="form-select form-control-pro"></select></div><div class="mb-3"><input type="text" id="evt-nama" class="form-control form-control-pro" placeholder="Nama Event" required></div><div class="row mb-3"><div class="col-6"><input type="date" id="evt-date" class="form-control form-control-pro" required></div><div class="col-6"><select id="evt-scale" class="form-select form-control-pro"><option value="Internal">Internal</option><option value="Orang Tua">Orang Tua</option><option value="Umum">Umum/Pejabat</option></select></div></div><div class="mb-3"><input type="url" id="evt-link" class="form-control form-control-pro" placeholder="Link Dokumentasi" required></div><div class="mb-4"><textarea id="evt-desc" class="form-control form-control-pro" rows="3" placeholder="Dampak Kegiatan..." required></textarea></div><button class="btn btn-primary w-100 py-3 fw-bold">KIRIM DATA</button></form></div></div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// ==========================================
// 1. KONFIGURASI LINK GAS (WAJIB GANTI!)
// ==========================================
const GAS_URL = "https://script.google.com/macros/s/AKfycbyk0nTT7ZTkH_5BOnjcpS8trcH_-gPtKgzy0PC6K5J93xUIBTUdx4gZ9VkvH2le3ftE/exec"; 

// ==========================================
// 2. MAIN SCRIPT
// ==========================================
let USER={pin:"",nama:"",role:"",sekolah:""}, modalUp, modalPr, modalBs, modalEv;
function showLoad(x){ let el=document.getElementById('loading'); if(x){el.classList.remove('d-none');el.classList.add('d-flex')}else{el.classList.add('d-none');el.classList.remove('d-flex')} }

async function apiCall(action, params = {}) {
  try {
    let response = await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action, ...params }) });
    return await response.json();
  } catch (error) { Swal.fire('Error', 'Gagal koneksi server.', 'error'); showLoad(false); return null; }
}

window.onload = () => {
  modalUp = new bootstrap.Modal(document.getElementById('mdlUpload'));
  modalPr = new bootstrap.Modal(document.getElementById('mdlPrestasi'));
  modalBs = new bootstrap.Modal(document.getElementById('mdlPembiasaan'));
  modalEv = new bootstrap.Modal(document.getElementById('mdlEvent'));
  
  let savedPin = localStorage.getItem('LMS_PIN');
  if (savedPin) { document.getElementById('inputPIN').value = savedPin; doLogin(true); }
}

async function doLogin(isAuto){
  let p=document.getElementById('inputPIN').value; if(!p) return Swal.fire('Perhatian','Isi PIN!','warning');
  showLoad(true);
  let r = await apiCall("login", { pin: p });
  showLoad(false);
  
  if(r && r.sukses){
    if(r.role === 'ADMIN' || r.role === 'PENILAI') {
        if(!isAuto) { Swal.fire({ title: 'Salah Kamar!', text: 'Anda adalah Admin/Penilai. Login di halaman khusus.', icon: 'error', confirmButtonColor: '#d33' }); }
        return; 
    }
    localStorage.setItem('LMS_PIN', p);
    USER={pin:p, nama:r.nama, role:r.role, sekolah:r.sekolah};
    document.getElementById('view-login').classList.add('hidden');
    document.getElementById('view-main').classList.remove('hidden');
    ['panel-guru','panel-ks'].forEach(id=>document.getElementById(id).classList.add('hidden'));
    
    document.getElementById('txtNama').innerText = r.nama;
    document.getElementById('txtSekolah').innerText = r.sekolah;
    
    let bdg = document.getElementById('txtRoleBadge');
    if(r.role === 'KS') { 
        bdg.innerText = "Kepala Sekolah"; bdg.className="badge-role role-ks mb-1 d-block";
        document.getElementById('panel-ks').classList.remove('hidden'); loadKS();
    } else { 
        bdg.innerText = "Guru Kelas"; bdg.className="badge-role role-guru mb-1 d-block";
        document.getElementById('panel-guru').classList.remove('hidden'); loadGuru();
    }
  } else {
    if(isAuto) { localStorage.removeItem('LMS_PIN'); document.getElementById('inputPIN').value=""; }
    else { Swal.fire('Gagal', r.error || 'PIN Tidak Ditemukan', 'error'); }
  }
}

function doLogout(){ localStorage.removeItem('LMS_PIN'); location.reload(); }

// --- LOGIKA GURU (FIX NaN%) ---
async function loadGuru(){
  showLoad(true);
  let d = await apiCall("getDashboardGuru", { pin: USER.pin });
  showLoad(false);
  if(d) {
    let mapTugas={}; d.riwayat.forEach(r=>{mapTugas[String(r[6]).trim()]=r[10]});
    let acc=0, html="";
    let sel = document.getElementById('sel-prog-kkg'); sel.innerHTML="";
    d.agenda.forEach((a, index)=>{
       let n=String(a[1]).trim(); sel.innerHTML += `<option value="${n}">${n}</option>`;
       let t=a[2], st=mapTugas[n], ui="";
       if(st==='Diterima')acc++;
       
       if(st){
          let bg=st==='Diterima'?'st-ok':(st==='Revisi'?'st-rev':'st-wait'); 
          let btnRevisi = st==='Revisi' ? `<button onclick="bukaLapor('${n}', ${index})" class="btn btn-sm btn-outline-danger mt-2 w-100 rounded-pill"><i class="bi bi-pencil-square"></i> Revisi</button>` : '';
          ui=`<span class="status-pill ${bg}" id="status-${index}">${st}</span>${btnRevisi}`;
       } else ui=`<button id="btn-kerjakan-${index}" onclick="bukaLapor('${n}', ${index})" class="btn btn-sm btn-gradient shadow-sm" style="font-size:0.75rem">KERJAKAN</button>`;
       
       html+=`<div class="card-pro p-3 mb-3 border-start border-4 border-danger"><div class="d-flex justify-content-between align-items-center"><div><div class="fw-bold text-dark small">${n}</div><div class="text-muted small"><i class="bi bi-clock me-1"></i>${t}</div></div><div class="text-end ps-2">${ui}</div></div></div>`;
    });
    document.getElementById('list-kegiatan-guru').innerHTML=html;
    
    // Perbaikan Logika Persen (Cegah NaN)
    let target = d.target || 0;
    let pct = target > 0 ? Math.round((acc/target)*100) : 0;
    if(pct > 100) pct = 100;
    
    document.getElementById('txt-persen').innerText = pct + "%";
    document.getElementById('txt-target').innerText = acc + "/" + target;
    
    let bar = document.getElementById('bar-guru'); 
    bar.style.width = pct + "%"; 
    bar.className = pct < 50 ? "progress-bar bg-danger" : (pct < 80 ? "progress-bar bg-warning" : "progress-bar bg-success");
  }
}

// --- LOGIKA KS (FIX NaN%) ---
async function loadKS() {
  showLoad(true);
  let dataSekolah = await apiCall("getDataKS", { sekolah: USER.sekolah });
  let dataPribadi = await apiCall("getDashboardGuru", { pin: USER.pin });
  showLoad(false); 

  if(dataSekolah) {
    document.getElementById('ks-count-imp').innerText = dataSekolah.statsPengembangan.implemen;
    document.getElementById('ks-count-ino').innerText = dataSekolah.statsPengembangan.inovasi;
    
    let tb = document.getElementById('tbl-ks'); let html = "";
    let dG = dataSekolah.dataGuru; 
    let totalLaporanMasuk = 0;

    if (dG.length === 0) { tb.innerHTML = "<tr><td colspan='3' class='text-center py-4 text-muted small'>Data guru tidak ditemukan.</td></tr>"; }
    else {
        dG.forEach(guru => {
          totalLaporanMasuk += guru.selesai;
          let bgBar = "bg-danger"; if(guru.persen >= 50) bgBar = "bg-warning"; if(guru.persen >= 80) bgBar = "bg-success";
          html += `<tr><td class="ps-3"><div class="fw-bold text-dark small">${guru.nama}</div></td><td><div class="progress" style="height:6px;border-radius:10px;"><div class="progress-bar ${bgBar}" style="width: ${guru.persen}%"></div></div></td><td class="text-end pe-3"><span class="badge ${bgBar} rounded-pill" style="font-size:0.65rem">${guru.persen}%</span></td></tr>`;
        });
        tb.innerHTML = html;
        
        let avg = dataSekolah.rataRataSekolah || 0;
        let avgSekolah = Math.round(avg);
        document.getElementById('ks-persen').innerText = (isNaN(avgSekolah) ? 0 : avgSekolah) + "%";
        document.getElementById('ks-total-laporan').innerText = totalLaporanMasuk;
    }
  }
  
  let divRiwayat = document.getElementById('list-riwayat-ks'); let htmlR = "";
  if(dataPribadi && dataPribadi.riwayat.length > 0) {
    dataPribadi.riwayat.forEach(item => {
      let jenis = item[5], judul = item[6], status = item[10], waktu = item[1];
      let bgSt = status==='Menunggu' ? 'bg-secondary' : (status==='Diterima'?'bg-success':'bg-danger');
      let feedback = (status !== 'Menunggu' && item[11]) ? `<div class="mt-2 small text-success fst-italic border-top pt-1"><i class="bi bi-chat-quote-fill me-1"></i>${item[11]}</div>` : '';
      htmlR += `<div class="card-pro p-3 mb-2"><div class="d-flex justify-content-between"><div><span class="badge bg-light text-secondary border mb-1" style="font-size:0.6rem">${jenis}</span><div class="fw-bold text-dark small">${judul}</div><div class="text-muted small" style="font-size:0.65rem">${waktu}</div></div><span class="badge ${bgSt} rounded-pill align-self-start" style="font-size:0.6rem">${status}</span></div>${feedback}</div>`;
    });
    divRiwayat.innerHTML = htmlR;
  } else { divRiwayat.innerHTML = '<div class="text-center py-5 text-muted small">Belum ada riwayat.</div>'; }
}

// --- OPTIMISTIC SUBMIT (SAT SET!) ---
let activeTaskIndex = -1;
function bukaLapor(j, idx){ document.getElementById('frmUpload').reset(); document.getElementById('inpJudul').value=j; activeTaskIndex = idx; modalUp.show(); }

async function submitTugas(e){
  e.preventDefault();
  let f=document.getElementById('frmUpload');
  let obj={pin_user:USER.pin, nama_user:USER.nama, sekolah_user:document.getElementById('txtSekolah').innerText};
  Array.from(f.elements).forEach(el=>{if(el.name)obj[el.name]=el.value});
  
  modalUp.hide();
  Swal.fire({ title: 'Terkirim!', text: 'Sedang memproses...', icon: 'success', timer: 1000, showConfirmButton: false, toast: true, position: 'top-end' });

  if(activeTaskIndex >= 0) {
      let btn = document.getElementById(`btn-kerjakan-${activeTaskIndex}`);
      if(btn) btn.outerHTML = `<span class="status-pill st-wait">Menunggu</span>`;
  }

  try { await apiCall("simpanTugas", { data: obj }); } catch (e) { Swal.fire('Gagal', 'Koneksi terputus.', 'error'); }
}

async function submitPengembangan(e, jenis) {
  e.preventDefault();
  let data = {};
  if(jenis === 'Implementasi KKG') {
     data.judul_dokumen = "IMPLEMENTASI: " + document.getElementById('sel-prog-kkg').value;
     data.catatan = `[KEGIATAN: ${document.getElementById('imp-nama').value}] [KELAS: ${document.getElementById('imp-kelas').value}] ` + document.getElementById('imp-desc').value;
     data.link_video = document.getElementById('imp-link').value;
  } else {
     data.judul_dokumen = "INOVASI: " + document.getElementById('ino-nama').value;
     data.catatan = document.getElementById('ino-desc').value;
     data.link_video = document.getElementById('ino-link').value;
  }
  let objKirim = { pin_user: USER.pin, nama_user: USER.nama, sekolah_user: document.getElementById('txtSekolah').innerText, jenis_laporan: jenis, judul_dokumen: data.judul_dokumen, link_video: data.link_video, catatan: data.catatan };
  
  if(jenis==='Karya Inovasi') document.getElementById('frmInovasi').reset(); else document.getElementById('frmImplemen').reset();

  Swal.fire({ title: 'Terkirim!', text: 'Data disimpan.', icon: 'success', timer: 1500, showConfirmButton: false });
  await apiCall("simpanTugas", { data: objKirim });
}

function isiDropdownSekolah(idElement) {
  let listSekolah = document.getElementById('txtSekolah').innerText.split(',');
  let elSelect = document.getElementById(idElement); elSelect.innerHTML = "";
  listSekolah.forEach(s => { if(s.trim()) { let opt = document.createElement('option'); opt.value = s.trim(); opt.innerText = s.trim(); elSelect.appendChild(opt); } });
}

function bukaModalPrestasi(){ document.getElementById('frmPrestasi').reset(); isiDropdownSekolah('inpSekolahPrestasi'); modalPr.show(); }
function bukaModalPembiasaan(){ document.getElementById('frmPembiasaan').reset(); isiDropdownSekolah('inpSekolahBias'); modalBs.show(); }
function bukaModalEvent(){ document.getElementById('frmEvent').reset(); isiDropdownSekolah('inpSekolahEvent'); modalEv.show(); }

async function submitGenericKS(e, modal, obj) {
    e.preventDefault(); modal.hide();
    let counter = document.getElementById('ks-total-laporan');
    if(counter) counter.innerText = (parseInt(counter.innerText) || 0) + 1;
    Swal.fire({ title: 'Sukses!', text: 'Laporan ditambahkan.', icon: 'success', timer: 1000, showConfirmButton: false });
    await apiCall("simpanTugas", { data: obj });
}

async function submitPrestasi(e){
  let f = document.getElementById('frmPrestasi'); let dataRaw = {}; Array.from(f.elements).forEach(el=>{if(el.name) dataRaw[el.name]=el.value});
  let obj = { pin_user: USER.pin, nama_user: USER.nama, sekolah_user: document.getElementById('inpSekolahPrestasi').value, jenis_laporan: "Laporan Prestasi", judul_dokumen: "PRESTASI: " + dataRaw.cabang.toUpperCase(), link_video: "-", catatan: `[SISWA: ${dataRaw.nama_siswa}] [JUARA: ${dataRaw.juara}] [TINGKAT: ${dataRaw.tingkat}] [NO: ${dataRaw.no_piagam}] [OLEH: ${dataRaw.penyelenggara}]` };
  submitGenericKS(e, modalPr, obj);
}
async function submitPembiasaan(e){
  let obj = { pin_user: USER.pin, nama_user: USER.nama, sekolah_user: document.getElementById('inpSekolahBias').value, jenis_laporan: "Laporan Pembiasaan", judul_dokumen: "PEMBIASAAN: " + document.getElementById('bias-nama').value, link_video: document.getElementById('bias-link').value, catatan: `[FREQ: ${document.getElementById('bias-freq').value}] [KARAKTER: ${document.getElementById('bias-karakter').value}] ` + document.getElementById('bias-desc').value };
  submitGenericKS(e, modalBs, obj);
}
async function submitEvent(e){
  let obj = { pin_user: USER.pin, nama_user: USER.nama, sekolah_user: document.getElementById('inpSekolahEvent').value, jenis_laporan: "Laporan Event", judul_dokumen: "EVENT: " + document.getElementById('evt-nama').value, link_video: document.getElementById('evt-link').value, catatan: `[SKALA: ${document.getElementById('evt-scale').value}] [TGL: ${document.getElementById('evt-date').value}] ` + document.getElementById('evt-desc').value };
  submitGenericKS(e, modalEv, obj);
}
</script>
</body>
</html>
