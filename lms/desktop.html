<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
<title>LMS Nakula - Desktop Pro</title>
<style>
  /* --- 1. CORE VARIABLES --- */
  :root {
    --primary: #B3261E; --primary-dark: #901B15;
    --primary-light: #FFDAD6; --text-on-primary: #410E0B;
    --bg-body: #F5F7FA; --bg-sidebar: #FFFFFF; --card-bg: #FFFFFF;
    --text-main: #201A19; --text-muted: #757575;
    --border: #E0E0E0;
    --sidebar-width: 280px;
    --radius: 12px; --shadow: 0 4px 12px rgba(0,0,0,0.03);
    --success: #2e7d32; --warning: #ed6c02; --info: #0288d1;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg-body); color: var(--text-main); height: 100vh; overflow: hidden; display: flex; }

  /* --- 2. UTILITIES --- */
  .hidden { display: none !important; }
  .flex { display: flex; align-items: center; }
  .col { display: flex; flex-direction: column; }
  .between { justify-content: space-between; }
  .center { justify-content: center; text-align: center; }
  .fw-bold { font-weight: 600; }
  .w-100 { width: 100%; }
  .mb-3 { margin-bottom: 1rem; }
  .text-success { color: var(--success); } .text-warning { color: var(--warning); } .text-danger { color: var(--primary); }

  /* --- 3. LAYOUT --- */
  aside { width: var(--sidebar-width); background: var(--bg-sidebar); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 24px; transition: 0.3s; z-index: 10; }
  main { flex: 1; overflow-y: auto; padding: 32px; position: relative; }

  /* Login Screen */
  #view-login { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 999; display: flex; align-items: center; justify-content: center; }
  .login-card { width: 400px; padding: 40px; border-radius: 24px; background: #fff; box-shadow: 0 10px 40px rgba(0,0,0,0.08); text-align: center; border: 1px solid var(--border); }

  /* --- 4. COMPONENTS --- */
  input, select, textarea { width: 100%; padding: 14px 16px; border: 1px solid var(--border); border-radius: 8px; font-size: 0.95rem; margin-bottom: 16px; transition: 0.2s; background: #FAFAFA; }
  input:focus, select:focus, textarea:focus { border-color: var(--primary); background: #fff; box-shadow: 0 0 0 3px var(--primary-light); }

  .btn { padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; border: none; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
  .btn-primary { background: var(--primary); color: white; }
  .btn-light { background: #f0f0f0; color: #333; }
  .btn-light:hover { background: #e0e0e0; }
  
  .card { background: var(--card-bg); border-radius: var(--radius); padding: 24px; box-shadow: var(--shadow); border: 1px solid var(--border); margin-bottom: 20px; }
  
  .nav-item { padding: 14px 16px; border-radius: 8px; cursor: pointer; margin-bottom: 4px; color: var(--text-muted); font-weight: 500; display: flex; align-items: center; gap: 12px; transition: 0.2s; }
  .nav-item:hover { background: var(--bg-body); color: var(--text-main); }
  .nav-item.active { background: var(--primary-light); color: var(--text-on-primary); font-weight: 600; }
  
  .badge { padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
  .bg-ok { background: #E8F5E9; color: #1B5E20; border: 1px solid #C8E6C9; }
  .bg-wait { background: #FFF3E0; color: #E65100; border: 1px solid #FFE0B2; }
  .bg-rev { background: #FFEBEE; color: #B71C1C; border: 1px solid #FFCDD2; }

  /* Modal */
  .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
  .modal-box { background: #fff; width: 500px; max-width: 90%; padding: 32px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.1); animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); max-height: 90vh; overflow-y: auto; }
  @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

  #loader { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); z-index:3000; display:none; justify-content:center; align-items:center; }
  .spinner { width: 40px; height: 40px; border: 4px solid #ddd; border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }
  #toast { position: fixed; bottom: 30px; right: 30px; background: #323232; color: #fff; padding: 12px 24px; border-radius: 8px; z-index: 4000; font-size: 0.9rem; transform: translateY(100px); transition: 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
  #toast.show { transform: translateY(0); }

</style>
</head>
<body>

<div id="toast">Notifikasi</div>
<div id="loader"><div class="spinner"></div></div>

<div id="view-login">
    <div class="login-card">
        <div style="width:64px; height:64px; background:var(--primary-light); color:var(--primary); border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 20px; font-size:24px;">üéì</div>
        <h2 class="fw-bold mb-3">LMS Nakula</h2>
        <p class="text-muted mb-4">Silakan masukkan PIN Anda untuk mengakses dashboard desktop.</p>
        <input type="password" id="inputPIN" placeholder="Masukkan PIN" style="text-align:center; font-size:1.2rem; letter-spacing:4px;">
        <button onclick="handleLogin()" class="btn btn-primary w-100">MASUK DASHBOARD</button>
    </div>
</div>

<div id="view-dashboard" class="hidden w-100" style="height:100vh; display:flex;">
    
    <aside>
        <div class="flex mb-4" style="gap:12px;">
            <div style="width:40px; height:40px; background:var(--primary); color:#fff; border-radius:8px; display:flex; align-items:center; justify-content:center; font-weight:bold;">N</div>
            <div>
                <div class="fw-bold" style="font-size:1rem;">Gugus Nakula</div>
                <div class="text-muted" style="font-size:0.75rem;">LMS Portal V2.0</div>
            </div>
        </div>

        <div id="menu-guru" class="hidden">
            <div class="text-muted small fw-bold mb-2 uppercase" style="letter-spacing:1px; font-size:0.7rem;">MENU UTAMA</div>
            <div class="nav-item active" onclick="switchPage('page-tugas', this)">üìù Tugas Rutin</div>
            <div class="nav-item" onclick="switchPage('page-implemen', this)">üí° Implementasi</div>
            <div class="nav-item" onclick="switchPage('page-inovasi', this)">üöÄ Karya Inovasi</div>
        </div>

        <div id="menu-ks" class="hidden">
            <div class="text-muted small fw-bold mb-2 uppercase" style="letter-spacing:1px; font-size:0.7rem;">ADMINISTRASI</div>
            <div class="nav-item active" onclick="switchPage('page-ks-dash', this)">üìä Rapor Guru</div>
            <div class="nav-item" onclick="switchPage('page-ks-lapor', this)">üìÇ Input Laporan</div>
        </div>

        <div style="margin-top:auto;">
            <div class="card p-3 mb-3" style="background:#f8f9fa; border:none;">
                <div class="fw-bold small mb-1" id="txtNama">User Name</div>
                <div class="text-muted small text-truncate" id="txtSekolah">Sekolah</div>
                <span id="txtRole" class="badge bg-ok mt-2">ROLE</span>
            </div>
            <button onclick="doLogout()" class="btn btn-light w-100 text-danger fw-bold">Keluar Aplikasi</button>
        </div>
    </aside>

    <main>
        <div id="page-tugas" class="page-content">
            <h2 class="fw-bold mb-4">Tugas & Kegiatan Rutin</h2>
            <div class="row" style="display:grid; grid-template-columns: 2fr 1fr; gap:24px;">
                <div>
                    <h5 class="mb-3 text-muted">Daftar Agenda Aktif</h5>
                    <div id="list-tugas-desktop"></div>
                </div>
                <div>
                     <div class="card bg-primary text-white border-0">
                         <div class="flex between mb-2">
                             <span style="opacity:0.8">Capaian</span>
                             <span class="fw-bold fs-3" id="g-persen">0%</span>
                         </div>
                         <div style="background:rgba(255,255,255,0.2); height:6px; border-radius:10px; overflow:hidden;">
                             <div id="g-bar" style="background:#fff; height:100%; width:0%;"></div>
                         </div>
                         <div class="mt-2 small opacity-75"><span id="g-target">0/0</span> Tugas Selesai</div>
                     </div>

                     <h5 class="mb-3 text-muted mt-4">Riwayat Lainnya</h5>
                     <div id="list-tugas-extra" style="max-height: 400px; overflow-y: auto;">
                         </div>
                </div>
            </div>
        </div>

        <div id="page-implemen" class="page-content hidden">
            <div class="card" style="max-width:700px;">
                <h3 class="mb-4">Lapor Implementasi KKG</h3>
                <form onsubmit="submitDev(event, 'Implementasi KKG')">
                    <label class="fw-bold small mb-1">Topik Program KKG</label>
                    <select id="sel-prog-kkg"></select>
                    
                    <label class="fw-bold small mb-1">Nama Kegiatan</label>
                    <input id="imp-nama" placeholder="Contoh: Penerapan Metode X di Kelas 5" required>
                    
                    <div class="flex" style="gap:16px;">
                        <div class="w-100">
                             <label class="fw-bold small mb-1">Kelas / Sasaran</label>
                             <input id="imp-kelas" placeholder="Cth: Kelas 4" required>
                        </div>
                        <div class="w-100">
                             <label class="fw-bold small mb-1">Link Bukti (Drive/Youtube)</label>
                             <input id="imp-link" type="url" placeholder="https://..." required>
                        </div>
                    </div>
                    
                    <label class="fw-bold small mb-1">Deskripsi & Refleksi</label>
                    <textarea id="imp-desc" rows="4" placeholder="Ceritakan singkat pelaksanaan dan dampaknya..." required></textarea>
                    
                    <div class="text-end">
                        <button class="btn btn-primary px-5">Kirim Laporan</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="page-inovasi" class="page-content hidden">
             <div class="card" style="max-width:700px;">
                <h3 class="mb-4 text-warning">Karya Inovasi Guru</h3>
                <form onsubmit="submitDev(event, 'Karya Inovasi')">
                    <label class="fw-bold small mb-1">Judul Inovasi</label>
                    <input id="ino-nama" placeholder="Judul Karya..." required>
                    
                    <label class="fw-bold small mb-1">Link File / Video Karya</label>
                    <input id="ino-link" type="url" placeholder="https://..." required>
                    
                    <label class="fw-bold small mb-1">Deskripsi Inovasi</label>
                    <textarea id="ino-desc" rows="4" placeholder="Jelaskan kebaruan dan manfaat inovasi ini..." required></textarea>
                    
                    <div class="text-end">
                        <button class="btn btn-primary px-5" style="background:var(--warning)">Kirim Karya</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="page-ks-dash" class="page-content hidden">
            <div class="flex between mb-4">
                <h2 class="fw-bold">Rapor Kinerja Guru</h2>
                <button class="btn btn-light" onclick="loadKS(true)">üîÑ Segarkan Data</button>
            </div>
            
            <div class="row" style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:20px; margin-bottom:24px;">
                <div class="card text-center">
                    <h1 class="text-primary mb-0" id="ks-total">0</h1>
                    <small class="text-muted fw-bold">TOTAL LAPORAN</small>
                </div>
            </div>

            <div class="card">
                <table class="w-100" style="border-collapse: collapse;">
                    <thead style="border-bottom:2px solid #eee;">
                        <tr style="text-align:left; color:#888; font-size:0.85rem;">
                            <th class="p-3">NAMA GURU</th>
                            <th class="p-3">PERFORMA</th>
                            <th class="p-3 text-end">POIN</th>
                        </tr>
                    </thead>
                    <tbody id="list-guru-ks"></tbody>
                </table>
            </div>
        </div>

        <div id="page-ks-lapor" class="page-content hidden">
             <h2 class="fw-bold mb-4">Input Data Sekolah</h2>
             <div class="row" style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:24px;">
                 
                 <div class="card hover-card" onclick="openModal('mdl-pres')" style="cursor:pointer; border-top: 5px solid #FFD700;">
                     <h1 class="mb-2">üèÜ</h1>
                     <h5 class="fw-bold">Input Prestasi</h5>
                     <p class="text-muted small">Catat kejuaraan siswa tingkat kecamatan hingga nasional.</p>
                 </div>

                 <div class="card hover-card" onclick="openModal('mdl-bias')" style="cursor:pointer; border-top: 5px solid #4CAF50;">
                     <h1 class="mb-2">üìÖ</h1>
                     <h5 class="fw-bold">Pembiasaan</h5>
                     <p class="text-muted small">Laporan kegiatan rutin (Upacara, Ibadah, Senam).</p>
                 </div>

                 <div class="card hover-card" onclick="openModal('mdl-event')" style="cursor:pointer; border-top: 5px solid #2196F3;">
                     <h1 class="mb-2">üéà</h1>
                     <h5 class="fw-bold">Event Sekolah</h5>
                     <p class="text-muted small">Dokumentasi kegiatan besar atau perayaan sekolah.</p>
                 </div>
             </div>
        </div>

    </main>
</div>

<div id="mdl-upload" class="modal-overlay">
    <div class="modal-box">
        <h4 class="mb-4">Upload Tugas Rutin</h4>
        <form onsubmit="submitTugas(event)">
            <input type="hidden" id="tugas-idx">
            <label class="small fw-bold">Judul Kegiatan</label>
            <input id="t-judul" readonly style="background:#eee; border:none; font-weight:bold;">
            
            <label class="small fw-bold">Link Bukti (Google Drive)</label>
            <input id="t-link" type="url" placeholder="https://..." required>
            
            <label class="small fw-bold">Rangkuman / Catatan</label>
            <textarea id="t-cat" rows="4" placeholder="Tulis rangkuman materi..." required></textarea>
            
            <div class="flex" style="gap:10px; justify-content:flex-end; margin-top:20px;">
                <button type="button" onclick="closeModal('mdl-upload')" class="btn btn-light w-100">Batal</button>
                <button class="btn btn-primary w-100">Kirim Tugas</button>
            </div>
        </form>
    </div>
</div>

<div id="mdl-pres" class="modal-overlay">
    <div class="modal-box">
        <h4 class="mb-4">üèÜ Input Prestasi Siswa</h4>
        <form onsubmit="submitGeneric(event, 'Laporan Prestasi', 'mdl-pres')">
            <select class="sel-sekolah" name="sekolah"></select>
            <input name="nama_siswa" placeholder="Nama Siswa" required>
            <div class="flex" style="gap:10px">
                <input name="cabang" placeholder="Cabang Lomba" required>
                <select name="juara" required>
                    <option value="" disabled selected>Pilih Juara</option>
                    <option value="Juara 1">Juara 1</option>
                    <option value="Juara 2">Juara 2</option>
                    <option value="Juara 3">Juara 3</option>
                </select>
            </div>
            <input name="penyelenggara" placeholder="Penyelenggara" required>
            <div class="flex" style="gap:10px">
                 <select name="tingkat">
                    <option value="Kecamatan">Kecamatan</option>
                    <option value="Kabupaten">Kabupaten</option>
                    <option value="Provinsi">Provinsi</option>
                    <option value="Nasional">Nasional</option>
                 </select>
                 <input name="no_piagam" placeholder="No Piagam" required>
            </div>
            <input name="link_video" type="url" placeholder="Link Foto/Piagam (GDrive)" class="mt-2" required>
            
            <div class="flex mt-3" style="gap:10px">
                <button type="button" onclick="closeModal('mdl-pres')" class="btn btn-light w-100">Batal</button>
                <button class="btn btn-primary w-100">Simpan Data</button>
            </div>
        </form>
    </div>
</div>

<div id="mdl-bias" class="modal-overlay">
    <div class="modal-box">
        <h4 class="mb-4">üìÖ Laporan Pembiasaan</h4>
        <form onsubmit="submitGeneric(event, 'Laporan Pembiasaan', 'mdl-bias')">
            <select class="sel-sekolah" name="sekolah"></select>
            <input name="a" placeholder="Nama Program (Cth: Sholat Dhuha)" required>
            <div class="flex" style="gap:10px">
               <select name="freq" required>
                  <option value="Harian">Harian</option>
                  <option value="Mingguan">Mingguan</option>
                  <option value="Bulanan">Bulanan</option>
               </select>
               <input name="karakter" placeholder="Nilai Karakter" required>
            </div>
            <input name="link_video" placeholder="Link Foto Kegiatan" required>
            <textarea name="desc" placeholder="Keterangan pelaksanaan..."></textarea>
            
            <div class="flex mt-3" style="gap:10px">
                <button type="button" onclick="closeModal('mdl-bias')" class="btn btn-light w-100">Batal</button>
                <button class="btn btn-primary w-100">Simpan</button>
            </div>
        </form>
    </div>
</div>

<div id="mdl-event" class="modal-overlay">
    <div class="modal-box">
        <h4 class="mb-4">üéà Event Sekolah</h4>
        <form onsubmit="submitGeneric(event, 'Laporan Event', 'mdl-event')">
            <select class="sel-sekolah" name="sekolah"></select>
            <input name="a" placeholder="Nama Event" required>
            <div class="flex" style="gap:10px">
               <input name="b" type="date" required>
               <select name="scale" required>
                   <option value="Internal">Internal</option>
                   <option value="Orang Tua">Orang Tua</option>
                   <option value="Umum">Umum/Pejabat</option>
               </select>
            </div>
            <input name="link_video" placeholder="Link Dokumentasi" required>
            <textarea name="desc" placeholder="Dampak Kegiatan"></textarea>
            
            <div class="flex mt-3" style="gap:10px">
                <button type="button" onclick="closeModal('mdl-event')" class="btn btn-light w-100">Batal</button>
                <button class="btn btn-primary w-100">Simpan</button>
            </div>
        </form>
    </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbyk0nTT7ZTkH_5BOnjcpS8trcH_-gPtKgzy0PC6K5J93xUIBTUdx4gZ9VkvH2le3ftE/exec";
const $ = id => document.getElementById(id);
const ls = { get: k => JSON.parse(localStorage.getItem(k)||'null'), set: (k,v) => localStorage.setItem(k, JSON.stringify(v)) };
const show = (id, s=true) => $(id).classList.toggle('hidden', !s);
const toast = msg => { const t = $('toast'); t.innerText = msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 3000); };
const loading = s => $('loader').style.display = s ? 'flex' : 'none';

let USER = ls.get('LMS_USER') || {};
let GLOBAL_TASKS_MAP = {}; 

window.onload = () => {
    loading(false);
    if(USER.pin) { $('inputPIN').value = USER.pin; handleLogin(true); }
};

async function req(action, data={}) {
    try {
        const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action, ...data }) });
        return await res.json();
    } catch(e) { toast("Gagal koneksi server"); return null; }
}

async function handleLogin(auto=false) {
    const pin = $('inputPIN').value;
    if(!pin) return toast("Isi PIN dulu!");
    if(!auto) loading(true);

    const r = await req("login", { pin });
    loading(false);

    if(r && r.sukses) {
        if(r.role === 'ADMIN' || r.role === 'PENILAI') return toast("Akses Admin hanya via Web Admin!");
        
        USER = { ...r, pin }; 
        ls.set('LMS_USER', USER);
        
        show('view-login', false); show('view-dashboard', true); document.body.style.display = 'flex';
        $('txtNama').innerText = r.nama;
        $('txtSekolah').innerText = r.sekolah;
        $('txtRole').innerText = r.role === 'KS' ? 'Kepala Sekolah' : 'Guru Kelas';
        $('txtRole').className = `badge ${r.role === 'KS' ? 'bg-wait' : 'bg-ok'} mt-2`;

        document.querySelectorAll('.sel-sekolah').forEach(s => {
            s.innerHTML = r.sekolah.split(',').map(x=>`<option value="${x.trim()}">${x.trim()}</option>`).join('');
        });

        if(r.role === 'KS') { show('menu-ks'); switchPage('page-ks-dash', $('menu-ks').children[1]); loadKS(); }
        else { show('menu-guru'); switchPage('page-tugas', $('menu-guru').children[1]); loadGuru(); }
    } else {
        if(auto) { ls.set('LMS_USER', null); show('view-login'); }
        else toast(r?.msg || "PIN Tidak Ditemukan");
    }
}

function doLogout() { if(confirm("Keluar dari Desktop?")) { localStorage.clear(); location.reload(); } }

function switchPage(pageId, el) {
    document.querySelectorAll('.page-content').forEach(p => p.classList.add('hidden'));
    $(pageId).classList.remove('hidden');
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    el.classList.add('active');
}

/* --- LOGIC GURU --- */
async function loadGuru() {
    loading(true);
    const data = await req("getDashboardGuru", { pin: USER.pin });
    loading(false);
    if(data) renderGuru(data);
}

function renderGuru(d) {
    GLOBAL_TASKS_MAP = {}; 
    const submittedTitles = new Set();
    
    // Mapping Data Lengkap
    d.tugas.forEach(t => { 
        let cleanTitle = t.judul.trim();
        GLOBAL_TASKS_MAP[cleanTitle] = t; 
        submittedTitles.add(cleanTitle);
    });

    let done = 0;
    Object.values(GLOBAL_TASKS_MAP).forEach(t => { if(t.status==='Diterima'||t.status==='Menunggu'||t.status==='Revisi') done++; });
    const acc = Object.values(GLOBAL_TASKS_MAP).filter(t => t.status==='Diterima').length;

    // 1. Render Agenda
    const html = d.agenda.map((a, i) => {
        const judul = a.kegiatan.trim();
        const task = GLOBAL_TASKS_MAP[judul];
        const status = task ? task.status : null;
        let act = `<button onclick="openUpload('${judul}')" class="btn btn-primary btn-sm">Kerjakan</button>`;
        let stBadge = "", feedbackHTML = "";
        
        if(status) {
            let cls = status === 'Diterima' ? 'bg-ok' : (status === 'Revisi' ? 'bg-rev' : 'bg-wait');
            stBadge = `<span class="badge ${cls}">${status}</span>`;
            if(status === 'Revisi') {
                act = `<button onclick="openUpload('${judul}')" class="btn btn-warning btn-sm text-white">Perbaiki</button>`;
                if(task.feedback && task.feedback !== '-') {
                    feedbackHTML = `<div class="mt-2 p-2 bg-rev small" style="border-radius:8px; border:1px dashed red;">‚ö†Ô∏è ${task.feedback}</div>`;
                }
            } else {
                act = `<button class="btn btn-light btn-sm" disabled>Terkirim</button>`;
            }
        }
        
        return `<div class="card p-3 mb-3 border-0 shadow-sm">
            <div class="flex between">
                <div>
                    <div class="fw-bold mb-1">${judul}</div>
                    <div class="text-muted small">üìÖ ${a.tanggal} &bull; ${a.waktu}</div>
                    ${stBadge}
                </div>
                <div>${act}</div>
            </div>
            ${feedbackHTML}
        </div>`;
    }).join('');
    $('list-tugas-desktop').innerHTML = html;

    // 2. Render Riwayat Tambahan
    const agendaTitles = d.agenda.map(a => a.kegiatan.trim());
    const extraTasks = d.tugas.filter(t => !agendaTitles.includes(t.judul.trim()));
    
    if(extraTasks.length > 0) {
        $('list-tugas-extra').innerHTML = extraTasks.map(t => {
            let cls = t.status === 'Diterima' ? 'bg-ok' : (t.status === 'Revisi' ? 'bg-rev' : 'bg-wait');
            return `<div class="p-3 mb-2" style="background:#fff; border-radius:8px; border:1px solid #eee;">
                <div class="flex between mb-1">
                    <span class="badge bg-light text-muted" style="font-size:0.65rem">${t.jenis || 'Umum'}</span>
                    <span class="badge ${cls}">${t.status}</span>
                </div>
                <div class="fw-bold small">${t.judul}</div>
                ${t.feedback && t.feedback !== '-' ? `<div class="mt-2 small text-success fst-italic border-top pt-1">üí¨ ${t.feedback}</div>` : ''}
            </div>`;
        }).join('');
    } else {
        $('list-tugas-extra').innerHTML = "<div class='text-center text-muted small py-3'>Belum ada riwayat tambahan</div>";
    }

    $('sel-prog-kkg').innerHTML = d.agenda.map(a => `<option>${a.kegiatan}</option>`).join('');

    let target = d.agenda.length;
    const pct = target > 0 ? Math.min(100, Math.round((acc / target) * 100)) : 0;
    $('g-persen').innerText = pct + "%"; 
    $('g-bar').style.width = pct + "%"; 
    $('g-target').innerText = `${acc}/${target}`;
}

/* --- LOGIC KS (FIXED: Show All Teachers) --- */
async function loadKS(force=false) {
    loading(true);
    const [ds, dp] = await Promise.all([
        req("getDataKS", { sekolah: USER.sekolah }),
        req("getDashboardGuru", { pin: USER.pin })
    ]);
    loading(false);
    if(ds) renderKS(ds);
}

function renderKS(d) {
    let guruMap = {};
    // 1. Init Data Guru (Nilai 0)
    if (d.master_guru) {
        d.master_guru.forEach(nama => {
            guruMap[nama] = { nama: nama, poin: 0, tugas: 0 };
        });
    }
    // 2. Isi Poin
    if (d.data_tugas) {
        d.data_tugas.forEach(x => {
            if(guruMap[x.nama]) {
                if(x.status === 'Diterima') { guruMap[x.nama].poin += x.skor; guruMap[x.nama].tugas++; }
            } else {
                // Guru tidak di master tapi ada tugas (kasus khusus)
                guruMap[x.nama] = { nama: x.nama, poin: (x.status==='Diterima'?x.skor:0), tugas: (x.status==='Diterima'?1:0) };
            }
        });
    }

    let listGuru = Object.values(guruMap).sort((a,b) => b.poin - a.poin);
    $('ks-total').innerText = d.data_tugas ? d.data_tugas.length : 0;
    
    if(listGuru.length === 0) $('list-guru-ks').innerHTML = "<tr><td colspan='3' class='p-3 text-center text-muted'>Belum ada data guru.</td></tr>";
    else {
        $('list-guru-ks').innerHTML = listGuru.map(g => {
            let pct = Math.min(100, g.tugas * 10);
            let color = '#ed6c02'; // Default Orange
            let statusText = `<span style="font-size:0.75rem; color:${color}">${g.tugas} Tugas</span>`;
            
            if (g.tugas === 0) {
                color = '#B71C1C'; // Merah
                statusText = `<span style="font-size:0.75rem; color:${color}; font-weight:bold;">BELUM SETOR</span>`;
                pct = 5;
            } else if (pct >= 80) {
                color = '#2e7d32'; // Hijau
            }

            return `<tr style="border-bottom:1px solid #f0f0f0;">
                <td class="p-3">
                    <div class="fw-bold">${g.nama}</div>
                    ${statusText}
                </td>
                <td class="p-3">
                    <div style="height:6px; background:#eee; border-radius:10px; width:100px;">
                        <div style="height:100%; width:${pct}%; background:${color}; border-radius:10px;"></div>
                    </div>
                </td>
                <td class="p-3 text-end fw-bold text-dark">${g.poin}</td>
            </tr>`;
        }).join('');
    }
}

/* --- MODAL ACTIONS --- */
function openModal(id) { $(id).style.display = 'flex'; }
function closeModal(id) { $(id).style.display = 'none'; }

// FIX: Auto-Fill saat Revisi
function openUpload(judul) { 
    $('mdl-upload').querySelector('form').reset(); 
    $('t-judul').value=judul; 
    
    // Cek Data Lama
    let existingTask = GLOBAL_TASKS_MAP[judul];
    if (existingTask) {
        $('t-link').value = existingTask.link && existingTask.link !== '-' ? existingTask.link : '';
        $('t-cat').value = existingTask.catatan && existingTask.catatan !== '-' ? existingTask.catatan : '';
        toast("Mode Edit: Data lama dimuat");
    }
    openModal('mdl-upload'); 
}

/* --- SUBMIT LOGIC --- */
async function submitTugas(e) {
    e.preventDefault(); closeModal('mdl-upload'); toast("Mengirim data...");
    await req("simpanTugas", { 
        pin_user: USER.pin, nama_user: USER.nama, sekolah_user: USER.sekolah, 
        jenis_laporan: "Kegiatan Gugus", judul_dokumen: $('t-judul').value, 
        link_video: $('t-link').value, catatan: $('t-cat').value 
    });
    toast("Tugas terkirim!"); loadGuru();
}

async function submitDev(e, jenis) {
    e.preventDefault();
    const isImp = jenis.includes('Implementasi');
    const nama = $(isImp?'imp-nama':'ino-nama').value;
    const extra = isImp ? `[PROG: ${$('sel-prog-kkg').value}] [KELAS: ${$('imp-kelas').value}] ` : '';
    
    // Reset Form
    if(isImp) $('imp-nama').value = ""; else $('ino-nama').value = "";
    toast("Mengirim...");

    await req("simpanTugas", {
        pin_user: USER.pin, nama_user: USER.nama, sekolah_user: USER.sekolah,
        jenis_laporan: jenis, judul_dokumen: (isImp?"IMPL: ":"INOV: ")+nama,
        link_video: $(isImp?'imp-link':'ino-link').value, 
        catatan: extra + $(isImp?'imp-desc':'ino-desc').value 
    });
    toast("Berhasil disimpan!"); loadGuru();
}

async function submitGeneric(e, jenis, modalId) {
    e.preventDefault(); closeModal(modalId); toast("Menyimpan...");
    const fd = new FormData(e.target); const obj = Object.fromEntries(fd.entries());
    
    let judul = jenis.toUpperCase(), catatan = "";
    if(jenis === 'Laporan Prestasi') {
        judul = "PRESTASI: " + obj.cabang.toUpperCase();
        catatan = `[SISWA: ${obj.nama_siswa}] [JUARA: ${obj.juara}] [TINGKAT: ${obj.tingkat}] [NO: ${obj.no_piagam}] [OLEH: ${obj.penyelenggara}]`;
    } else if(jenis === 'Laporan Pembiasaan') {
        judul = "PEMBIASAAN: " + obj.a;
        catatan = `[FREQ: ${obj.freq}] [KARAKTER: ${obj.karakter}] ${obj.desc}`;
    } else {
        judul = "EVENT: " + obj.a;
        catatan = `[SKALA: ${obj.scale}] [TGL: ${obj.b}] ${obj.desc}`;
    }

    await req("simpanTugas", {
        pin_user: USER.pin, nama_user: USER.nama, sekolah_user: obj.sekolah,
        jenis_laporan: jenis, judul_dokumen: judul, link_video: obj.link_video || "-", catatan: catatan 
    });
    toast("Data tersimpan!"); loadKS(true);
}
</script>
</body>
</html>
