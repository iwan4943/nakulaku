<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
<title>LMS Nakula - Desktop</title>
<style>
  /* --- 1. CORE VARIABLES & RESET --- */
  :root {
    --primary: #B3261E; --primary-dark: #901B15;
    --primary-light: #FFDAD6; --text-on-primary: #410E0B;
    --bg-body: #F5F7FA; --bg-sidebar: #FFFFFF; --card-bg: #FFFFFF;
    --text-main: #201A19; --text-muted: #757575;
    --border: #E0E0E0;
    --sidebar-width: 260px;
    --radius: 12px; --shadow: 0 4px 12px rgba(0,0,0,0.03);
    --success: #2e7d32; --warning: #ed6c02; --info: #0288d1;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg-body); color: var(--text-main); height: 100vh; overflow: hidden; display: flex; font-size: 14px; line-height: 1.5; }

  /* --- 2. UTILITIES --- */
  .hidden { display: none !important; }
  .flex { display: flex; align-items: center; }
  .flex-col { display: flex; flex-direction: column; }
  .between { justify-content: space-between; }
  .center { justify-content: center; align-items: center; }
  .fw-bold { font-weight: 600; }
  .text-muted { color: var(--text-muted); font-size: 0.85rem; }
  .text-primary { color: var(--primary); }
  .w-100 { width: 100%; }
  .mb-3 { margin-bottom: 1rem; } .mb-4 { margin-bottom: 1.5rem; }
  
  /* --- 3. COMPONENTS --- */
  /* Buttons */
  .btn { border: none; padding: 10px 20px; border-radius: 50px; font-weight: 600; cursor: pointer; transition: 0.2s; font-size: 0.9rem; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
  .btn:hover { opacity: 0.9; transform: translateY(-1px); }
  .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(179,38,30,0.2); }
  .btn-outline { border: 1px solid var(--border); background: white; color: var(--text-main); }
  .btn-outline:hover { border-color: var(--primary); color: var(--primary); }
  .btn-sm { padding: 6px 12px; font-size: 0.8rem; }
  
  /* Inputs */
  input, select, textarea { width: 100%; padding: 10px 14px; border: 1px solid var(--border); background: #fff; border-radius: 8px; font-size: 0.95rem; font-family: inherit; margin-bottom: 1rem; transition: 0.2s; }
  input:focus, select:focus, textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(179,38,30,0.1); }

  /* Cards */
  .card { background: var(--card-bg); border-radius: var(--radius); padding: 24px; box-shadow: var(--shadow); height: 100%; border: 1px solid rgba(0,0,0,0.02); }
  
  /* Badges */
  .badge { padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; }
  .bg-ok { background: #C3EED0; color: #0F5223; }
  .bg-wait { background: #FEE4C1; color: #744C00; }
  .bg-rev { background: #F9DEDC; color: #8C1D18; }

  /* Table (Desktop Specific) */
  .table-container { overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; font-size: 0.95rem; }
  th { text-align: left; padding: 12px; border-bottom: 2px solid var(--border); color: var(--text-muted); font-size: 0.8rem; text-transform: uppercase; }
  td { padding: 12px; border-bottom: 1px solid #f0f0f0; vertical-align: middle; }
  tr:last-child td { border-bottom: none; }
  tr:hover td { background: #fafafa; }

  /* Icons (SVG) */
  svg { width: 20px; height: 20px; fill: currentColor; }
  .icon-lg { width: 48px; height: 48px; }

  /* --- 4. LAYOUT STRUCTURE --- */
  /* Sidebar */
  #sidebar { width: var(--sidebar-width); background: var(--bg-sidebar); border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 10; transition: 0.3s; flex-shrink: 0; }
  .sidebar-header { padding: 24px; border-bottom: 1px solid var(--border); }
  .nav-menu { flex: 1; padding: 20px 12px; list-style: none; }
  .nav-item { margin-bottom: 4px; }
  .nav-link { display: flex; align-items: center; padding: 12px 16px; color: #555; text-decoration: none; border-radius: 8px; transition: 0.2s; font-weight: 500; cursor: pointer; }
  .nav-link svg { margin-right: 12px; opacity: 0.7; }
  .nav-link:hover { background: #FFF0EE; color: var(--primary); }
  .nav-link.active { background: var(--primary-light); color: var(--text-on-primary); }
  .nav-link.active svg { opacity: 1; }
  .sidebar-footer { padding: 20px; border-top: 1px solid var(--border); }

  /* Main Content */
  #content { flex: 1; overflow-y: auto; padding: 30px; position: relative; }
  .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
  .user-badge { background: white; padding: 6px 12px 6px 6px; border-radius: 50px; border: 1px solid var(--border); display: flex; align-items: center; gap: 10px; font-weight: 600; font-size: 0.85rem; }
  .avatar { width: 32px; height: 32px; background: var(--primary-light); color: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; }

  /* Grids */
  .grid-guru { display: grid; grid-template-columns: 2fr 1fr; gap: 24px; margin-bottom: 24px; }
  .grid-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 24px; }
  .grid-split { display: grid; grid-template-columns: 2fr 1fr; gap: 24px; }

  /* Login Screen */
  .login-wrapper { position: fixed; inset: 0; background: linear-gradient(135deg, var(--primary), #601410); z-index: 100; display: flex; align-items: center; justify-content: center; }
  .login-card { background: white; width: 400px; padding: 40px; border-radius: 24px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }

  /* Modal Overlay */
  .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
  .modal-box { background: white; width: 500px; max-width: 90%; max-height: 90vh; overflow-y: auto; border-radius: 20px; padding: 30px; animation: popUp 0.2s; }
  @keyframes popUp { from{transform: scale(0.95); opacity: 0;} to{transform: scale(1); opacity: 1;} }

  /* Loading & Toast */
  #loader { position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 3000; display: flex; align-items: center; justify-content: center; }
  .spinner { width: 40px; height: 40px; border: 4px solid #ddd; border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }
  #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 12px 24px; border-radius: 50px; z-index: 4000; opacity: 0; pointer-events: none; transition: 0.3s; font-size: 0.9rem; }
  #toast.show { opacity: 1; top: 40px; }

</style>
</head>
<body>

<div id="loader"><div class="spinner"></div></div>
<div id="toast">Notifikasi</div>

<div id="view-login" class="login-wrapper">
  <div class="login-card">
    <div style="color: var(--primary); margin-bottom: 20px;">
       <svg style="width: 64px; height: 64px;" viewBox="0 0 16 16"><path d="M8.211 2.047a.5.5 0 0 0-.422 0l-7.5 3.5a.5.5 0 0 0 .025.917l7.5 3a.5.5 0 0 0 .372 0L14 7.14V13a1 1 0 0 0-1 1v2h3v-2a1 1 0 0 0-1-1V6.739l.686-.275a.5.5 0 0 0 .025-.917l-7.5-3.5ZM8 8.46 1.758 5.965 8 3.052l6.242 2.913L8 8.46Z"/></svg>
    </div>
    <h2 class="fw-bold" style="margin-bottom: 5px;">LMS NAKULA</h2>
    <p class="text-muted mb-4">Portal Kinerja Desktop</p>
    <label class="text-muted fw-bold" style="font-size: 0.75rem; display: block; text-align: left; margin-bottom: 8px;">MASUKKAN PIN</label>
    <input type="tel" id="inputPIN" style="text-align: center; font-size: 1.5rem; letter-spacing: 5px; font-weight: bold;" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="6">
    <button onclick="handleLogin()" class="btn btn-primary w-100" style="padding: 14px;">MASUK DASHBOARD</button>
  </div>
</div>

<div id="view-main" class="hidden" style="display: flex; width: 100%;">
  <nav id="sidebar">
    <div class="sidebar-header flex">
      <div style="color: var(--primary); margin-right: 10px;">
        <svg viewBox="0 0 16 16"><path d="M8.211 2.047a.5.5 0 0 0-.422 0l-7.5 3.5a.5.5 0 0 0 .025.917l7.5 3a.5.5 0 0 0 .372 0L14 7.14V13a1 1 0 0 0-1 1v2h3v-2a1 1 0 0 0-1-1V6.739l.686-.275a.5.5 0 0 0 .025-.917l-7.5-3.5ZM8 8.46 1.758 5.965 8 3.052l6.242 2.913L8 8.46Z"/></svg>
      </div>
      <div><div class="fw-bold">LMS NAKULA</div><div style="font-size: 0.7rem; color: #888;">Versi Desktop</div></div>
    </div>
    <ul class="nav-menu">
      <li class="nav-item"><a class="nav-link active"><svg viewBox="0 0 16 16"><path d="M1 2.5A1.5 1.5 0 0 1 2.5 1h3A1.5 1.5 0 0 1 7 2.5v3A1.5 1.5 0 0 1 5.5 7h-3A1.5 1.5 0 0 1 1 5.5v-3zm8 0A1.5 1.5 0 0 1 10.5 1h3A1.5 1.5 0 0 1 15 2.5v3A1.5 1.5 0 0 1 13.5 7h-3A1.5 1.5 0 0 1 9 5.5v-3zm-8 8A1.5 1.5 0 0 1 2.5 9h3A1.5 1.5 0 0 1 7 10.5v3A1.5 1.5 0 0 1 5.5 15h-3A1.5 1.5 0 0 1 1 13.5v-3zm8 0A1.5 1.5 0 0 1 10.5 9h3A1.5 1.5 0 0 1 15 10.5v3A1.5 1.5 0 0 1 13.5 15h-3A1.5 1.5 0 0 1 9 13.5v-3z"/></svg> Dashboard</a></li>
      <li class="nav-item" style="margin-top: 15px; padding-left: 16px; font-size: 0.75rem; color: #aaa; font-weight: bold; text-transform: uppercase;">Menu Utama</li>
      <li class="nav-item hidden" id="menu-guru"><a class="nav-link"><svg viewBox="0 0 16 16"><path d="M14 1a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1H4.414A2 2 0 0 0 3 11.586l-2 2V2a1 1 0 0 1 1-1h12zM2 0a2 2 0 0 0-2 2v12.793a.5.5 0 0 0 .854.353l2.853-2.853A1 1 0 0 1 4.414 12H14a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z"/></svg> Tugas Saya</a></li>
      <li class="nav-item hidden" id="menu-ks"><a class="nav-link"><svg viewBox="0 0 16 16"><path d="M1 11a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1v-3zm5-4a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v7a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V7zm5-5a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1V2z"/></svg> Rapor Guru</a></li>
    </ul>
    <div class="sidebar-footer">
      <button onclick="doLogout()" class="btn btn-outline w-100" style="color: var(--primary); border-color: var(--primary);">
        <svg viewBox="0 0 16 16"><path d="M10 12.5a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v2a.5.5 0 0 0 1 0v-2A1.5 1.5 0 0 0 9.5 2h-8A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-2a.5.5 0 0 0-1 0v2z"/><path d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L14.293 7.5H5.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3z"/></svg> Keluar
      </button>
    </div>
  </nav>

  <div id="content">
    <div class="top-bar">
      <div>
        <h2 class="fw-bold mb-0">Selamat Datang, <span id="txtNama">User</span></h2>
        <p class="text-muted mb-0" id="txtSekolah">Sekolah</p>
      </div>
      <div class="user-badge">
        <div class="avatar"><svg viewBox="0 0 16 16"><path d="M3 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1H3Zm5-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z"/></svg></div>
        <div class="flex-col" style="align-items: flex-start; line-height: 1.1;">
            <span style="font-size: 0.7rem; color: #888;">Akun Aktif</span>
            <span id="txtRole" class="text-primary">GURU</span>
        </div>
      </div>
    </div>

    <div id="panel-guru" class="hidden">
      <div class="grid-guru">
        <div class="card" style="background: var(--primary); color: white; position: relative; overflow: hidden; border: none;">
          <div style="position: absolute; right: -20px; top: -20px; opacity: 0.15;">
            <svg style="width: 200px; height: 200px;" viewBox="0 0 16 16"><path d="M6 1v3a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V1a1 1 0 0 1 1-1h3a1 1 0 0 1 1 1zm9 0v3a1 1 0 0 1-1 1h-3a1 1 0 0 1-1-1V1a1 1 0 0 1 1-1h3a1 1 0 0 1 1 1zm-9 8v3a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V9a1 1 0 0 1 1-1h3a1 1 0 0 1 1 1zm9 0v3a1 1 0 0 1-1 1h-3a1 1 0 0 1-1-1V9a1 1 0 0 1 1-1h3a1 1 0 0 1 1 1z"/></svg>
          </div>
          <div style="position: relative; z-index: 2;">
            <div style="font-size: 0.9rem; font-weight: 600; opacity: 0.8; margin-bottom: 10px;">CAPAIAN KINERJA ANDA</div>
            <div class="flex" style="align-items: baseline;">
                <h1 style="font-size: 4rem; margin: 0; line-height: 1;" id="g-persen">0%</h1>
                <span id="g-target" style="background: rgba(255,255,255,0.2); padding: 5px 15px; border-radius: 50px; margin-left: 20px; font-weight: 600;">0/0 Selesai</span>
            </div>
            <div style="background: rgba(255,255,255,0.3); height: 8px; border-radius: 10px; margin-top: 20px; overflow: hidden;">
                <div id="g-bar" style="width: 0%; height: 100%; background: white;"></div>
            </div>
          </div>
        </div>
        <div class="card flex-col center" style="border-left: 5px solid var(--warning);">
          <h4 class="fw-bold mb-3" style="color: var(--text-main);">Lapor Pengembangan</h4>
          <button onclick="openModal('mdl-imp')" class="btn btn-primary w-100 mb-3" style="background: var(--warning);">Implementasi</button>
          <button onclick="openModal('mdl-ino')" class="btn btn-primary w-100" style="background: var(--success);">Karya Inovasi</button>
        </div>
      </div>

      <div class="card">
        <h4 class="fw-bold mb-4" style="border-bottom: 1px solid #eee; padding-bottom: 15px;">Daftar Tugas & Agenda</h4>
        <div class="table-container">
            <table>
                <thead><tr><th>No</th><th>Nama Kegiatan</th><th>Tenggat</th><th>Status</th><th style="text-align: right;">Aksi</th></tr></thead>
                <tbody id="tbl-tugas"></tbody>
            </table>
        </div>
      </div>
    </div>

    <div id="panel-ks" class="hidden">
      <div class="grid-stats">
        <div class="card flex between">
            <div><h2 class="fw-bold mb-0" id="ks-total">0</h2><span class="text-muted">Total Laporan</span></div>
            <div style="background: #FFF0EE; color: var(--primary); padding: 15px; border-radius: 12px;"><svg class="icon-lg" viewBox="0 0 16 16"><path d="M14.5 3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-13a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h13zm-13-1A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h13a1.5 1.5 0 0 0 1.5-1.5v-9A1.5 1.5 0 0 0 14.5 2h-13z"/><path d="M3 5.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zM3 8a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9A.5.5 0 0 1 3 8zm0 2.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5z"/></svg></div>
        </div>
        <div class="card flex between">
            <div><h2 class="fw-bold mb-0" id="ks-imp">0</h2><span class="text-muted">Implementasi</span></div>
            <div style="background: #E3F2FD; color: var(--info); padding: 15px; border-radius: 12px;"><svg class="icon-lg" viewBox="0 0 16 16"><path d="M6 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm-5 6s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1H1zM11 3.5a.5.5 0 0 1 .5-.5h4a.5.5 0 0 1 0 1h-4a.5.5 0 0 1-.5-.5zm.5 2.5a.5.5 0 0 0 0 1h4a.5.5 0 0 0 0-1h-4zm2 3a.5.5 0 0 0 0 1h2a.5.5 0 0 0 0-1h-2zm0 3a.5.5 0 0 0 0 1h2a.5.5 0 0 0 0-1h-2z"/></svg></div>
        </div>
        <div class="card flex between">
            <div><h2 class="fw-bold mb-0" id="ks-ino">0</h2><span class="text-muted">Inovasi</span></div>
            <div style="background: #E8F5E9; color: var(--success); padding: 15px; border-radius: 12px;"><svg class="icon-lg" viewBox="0 0 16 16"><path d="M2 6a6 6 0 1 1 10.174 4.31c-.203.196-.359.4-.453.619l-.762 1.769A.5.5 0 0 1 10.5 13a.5.5 0 0 1 0 1 .5.5 0 0 1 0 1l-.224.447a1 1 0 0 1-.894.553H6.618a1 1 0 0 1-.894-.553L5.5 15a.5.5 0 0 1 0-1 .5.5 0 0 1 0-1 .5.5 0 0 1-.46-.302l-.761-1.77a1.964 1.964 0 0 0-.453-.618A5.984 5.984 0 0 1 2 6zm6-5a5 5 0 0 0-3.479 8.592c.263.254.514.564.676.941L5.83 12h4.342l.632-1.467c.162-.377.413-.687.676-.941A5 5 0 0 0 8 1z"/></svg></div>
        </div>
      </div>
      
      <div class="card mb-4" style="padding: 20px;">
        <h6 class="fw-bold text-muted mb-3" style="text-transform: uppercase; font-size: 0.8rem;">Manajemen Sekolah</h6>
        <div class="grid-stats" style="margin-bottom: 0;">
            <button onclick="openModal('mdl-pres')" class="btn btn-outline" style="border-width: 2px;">üèÜ Input Prestasi</button>
            <button onclick="openModal('mdl-bias')" class="btn btn-outline" style="border-width: 2px;">üìÖ Lapor Pembiasaan</button>
            <button onclick="openModal('mdl-event')" class="btn btn-outline" style="border-width: 2px;">üéà Event Sekolah</button>
        </div>
      </div>

      <div class="grid-split">
         <div class="card">
            <div class="flex between mb-4">
                <h4 class="fw-bold">Rapor Kinerja Guru</h4>
                <div><span class="text-muted">Rata-rata: </span><span id="ks-avg" class="badge bg-rev" style="font-size: 1rem;">0%</span></div>
            </div>
            <div class="table-container">
                <table>
                    <thead><tr><th>Nama Guru</th><th>Progress</th><th style="text-align: right;">%</th></tr></thead>
                    <tbody id="tbl-ks"></tbody>
                </table>
            </div>
         </div>
         <div class="card">
            <div class="flex between mb-3">
                <h4 class="fw-bold">Riwayat</h4>
                <button onclick="loadKS(true)" class="btn btn-sm btn-outline">Refresh</button>
            </div>
            <div id="list-riwayat" style="max-height: 400px; overflow-y: auto;"></div>
         </div>
      </div>
    </div>
  </div>
</div>

<div id="mdl-up" class="modal-overlay">
  <div class="modal-box">
    <div class="flex between mb-3"><h3 class="fw-bold">Kirim Tugas</h3><button onclick="closeModal('mdl-up')" class="btn btn-sm">‚úï</button></div>
    <form onsubmit="submitTugas(event)">
      <input type="hidden" id="t-idx">
      <label class="text-muted small">KEGIATAN</label>
      <input id="t-judul" readonly style="background: #f0f0f0; font-weight: bold;">
      <label class="text-muted small">LINK BUKTI</label>
      <input id="t-link" type="url" placeholder="Paste link Drive/Youtube..." required>
      <label class="text-muted small">RANGKUMAN</label>
      <textarea id="t-cat" rows="4" placeholder="Tulis rangkuman..." required></textarea>
      <div style="text-align: right;"><button class="btn btn-primary">Kirim Tugas</button></div>
    </form>
  </div>
</div>

<div id="mdl-imp" class="modal-overlay">
  <div class="modal-box">
    <div class="flex between mb-3"><h3 class="fw-bold text-primary">Implementasi KKG</h3><button onclick="closeModal('mdl-imp')" class="btn btn-sm">‚úï</button></div>
    <form onsubmit="submitDev(event, 'Implementasi KKG')">
      <div class="grid-guru" style="gap: 10px; margin-bottom: 0;">
        <div><select id="sel-prog-kkg"></select></div>
        <div><input id="imp-kelas" placeholder="Kelas/Sasaran" required></div>
      </div>
      <input id="imp-nama" placeholder="Nama Kegiatan" required>
      <input id="imp-link" type="url" placeholder="Link Dokumentasi" required>
      <textarea id="imp-desc" rows="3" placeholder="Deskripsi..." required></textarea>
      <button class="btn btn-primary w-100">Kirim Laporan</button>
    </form>
  </div>
</div>

<div id="mdl-ino" class="modal-overlay">
  <div class="modal-box">
    <div class="flex between mb-3"><h3 class="fw-bold" style="color: var(--success);">Karya Inovasi</h3><button onclick="closeModal('mdl-ino')" class="btn btn-sm">‚úï</button></div>
    <p class="text-muted mb-3" style="background: #E8F5E9; padding: 10px; border-radius: 8px;">Karya dapat berupa Video, Alat Peraga, atau Artikel.</p>
    <form onsubmit="submitDev(event, 'Karya Inovasi')">
      <input id="ino-nama" placeholder="Judul Inovasi" required>
      <input id="ino-link" type="url" placeholder="Link Karya" required>
      <textarea id="ino-desc" rows="4" placeholder="Deskripsi Singkat..." required></textarea>
      <button class="btn btn-primary w-100" style="background: var(--success);">Kirim Karya</button>
    </form>
  </div>
</div>

<div id="mdl-pres" class="modal-overlay">
  <div class="modal-box">
    <div class="flex between mb-3"><h3 class="fw-bold" style="color: var(--warning);">Input Prestasi</h3><button onclick="closeModal('mdl-pres')" class="btn btn-sm">‚úï</button></div>
    <form onsubmit="submitGeneric(event, 'Laporan Prestasi', 'mdl-pres')">
      <select class="sel-sekolah" name="sekolah"></select>
      <input name="nama_siswa" placeholder="Nama Siswa" required>
      <div class="flex" style="gap: 10px;">
         <input name="cabang" placeholder="Cabang Lomba" required>
         <select name="juara" required><option value="" disabled selected>Juara</option><option value="Juara 1">Juara 1</option><option value="Juara 2">Juara 2</option><option value="Juara 3">Juara 3</option></select>
      </div>
      <input name="penyelenggara" placeholder="Penyelenggara" required>
      <div class="flex" style="gap: 10px;">
         <select name="tingkat"><option>Kecamatan</option><option>Kabupaten</option><option>Nasional</option></select>
         <input name="no_piagam" placeholder="No Piagam" required>
      </div>
      <button class="btn btn-primary w-100" style="background: var(--warning);">Simpan Data</button>
    </form>
  </div>
</div>

<div id="mdl-bias" class="modal-overlay">
  <div class="modal-box">
    <div class="flex between mb-3"><h3 class="fw-bold" style="color: var(--success);">Pembiasaan</h3><button onclick="closeModal('mdl-bias')" class="btn btn-sm">‚úï</button></div>
    <form onsubmit="submitGeneric(event, 'Laporan Pembiasaan', 'mdl-bias')">
      <select class="sel-sekolah" name="sekolah"></select>
      <input name="a" placeholder="Nama Program" required>
      <div class="flex" style="gap: 10px;">
        <select name="freq" required><option value="" disabled selected>Frekuensi</option><option>Harian</option><option>Mingguan</option><option>Bulanan</option></select>
        <input name="karakter" placeholder="Karakter" required>
      </div>
      <input name="link_video" placeholder="Link Foto" required>
      <textarea name="desc" placeholder="Keterangan"></textarea>
      <button class="btn btn-primary w-100" style="background: var(--success);">Simpan</button>
    </form>
  </div>
</div>

<div id="mdl-event" class="modal-overlay">
  <div class="modal-box">
    <div class="flex between mb-3"><h3 class="fw-bold text-primary">Event Sekolah</h3><button onclick="closeModal('mdl-event')" class="btn btn-sm">‚úï</button></div>
    <form onsubmit="submitGeneric(event, 'Laporan Event', 'mdl-event')">
      <select class="sel-sekolah" name="sekolah"></select>
      <input name="a" placeholder="Nama Event" required>
      <div class="flex" style="gap: 10px;">
        <input name="b" type="date" required>
        <select name="scale" required><option value="Internal">Internal</option><option value="Orang Tua">Orang Tua</option><option value="Umum">Umum</option></select>
      </div>
      <input name="link_video" placeholder="Link Dokumentasi" required>
      <textarea name="desc" placeholder="Dampak Kegiatan"></textarea>
      <button class="btn btn-primary w-100">Simpan</button>
    </form>
  </div>
</div>

<script>
/* --- 1. CONFIG --- */
const API_URL = "https://script.google.com/macros/s/AKfycbyk0nTT7ZTkH_5BOnjcpS8trcH_-gPtKgzy0PC6K5J93xUIBTUdx4gZ9VkvH2le3ftE/exec";

/* --- 2. HELPERS --- */
const $ = id => document.getElementById(id);
const ls = { get: k => JSON.parse(localStorage.getItem(k)||'null'), set: (k,v) => localStorage.setItem(k, JSON.stringify(v)) };
const show = (id, s=true) => $(id).classList.toggle('hidden', !s);
const toast = msg => { const t = $('toast'); t.innerText = msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 3000); };
const loading = s => $('loader').style.display = s ? 'flex' : 'none';

/* --- 3. STATE --- */
let USER = ls.get('LMS_USER') || {};

/* --- 4. INIT --- */
window.onload = () => {
    loading(false);
    if(USER.pin) { $('inputPIN').value = USER.pin; handleLogin(true); }
};

/* --- 5. API --- */
async function req(action, data={}) {
    try {
        const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action, ...data }) });
        return await res.json();
    } catch(e) { toast("Gagal koneksi server"); return null; }
}

/* --- 6. AUTH --- */
async function handleLogin(auto=false) {
    const pin = $('inputPIN').value;
    if(!pin) return toast("Isi PIN!");
    if(!auto) loading(true);

    const r = await req("login", { pin });
    loading(false);

    if(r && r.sukses) {
        if(r.role === 'ADMIN') return toast("Akses ditolak (Admin).");
        USER = { ...r, pin }; ls.set('LMS_USER', USER);
        
        show('view-login', false); show('view-main', true);
        $('txtNama').innerText = r.nama; $('txtSekolah').innerText = r.sekolah;
        $('txtRole').innerText = r.role === 'KS' ? 'KEPALA SEKOLAH' : 'GURU KELAS';
        
        // Setup Dropdowns
        document.querySelectorAll('.sel-sekolah').forEach(s => {
            s.innerHTML = r.sekolah.split(',').map(x=>`<option value="${x.trim()}">${x.trim()}</option>`).join('');
        });

        if(r.role === 'KS') { 
            show('panel-ks'); show('menu-ks'); loadKS(); 
        } else { 
            show('panel-guru'); show('menu-guru'); loadGuru(); 
        }
    } else {
        if(auto) { ls.set('LMS_USER', null); show('view-login'); }
        else toast(r?.error || "PIN Salah");
    }
}

function doLogout() { if(confirm("Keluar aplikasi?")) { localStorage.clear(); location.reload(); } }

/* --- 7. LOGIC GURU (TABLE VIEW) --- */
async function loadGuru() {
    const c = ls.get('CACHE_GURU'); if(c) renderGuru(c); else loading(true);
    const d = await req("getDashboardGuru", { pin: USER.pin });
    loading(false);
    if(d) { ls.set('CACHE_GURU', d); renderGuru(d); }
}

function renderGuru(d) {
    const map = {}; d.riwayat.forEach(r => map[r[6].trim()] = r[10]); 
    let done = 0;
    
    // Render Table
    const html = d.agenda.map((a, i) => {
        const judul = a[1].trim();
        const status = map[judul];
        if(status === 'Diterima') done++;
        
        let stBadge = `<span class="badge" style="background:#eee; color:#666;">Belum</span>`;
        let actBtn = `<button onclick="openUpload('${judul}', ${i})" class="btn btn-sm btn-primary">Kerjakan</button>`;
        
        if(status) {
            let color = status==='Diterima'?'bg-ok':(status==='Revisi'?'bg-rev':'bg-wait');
            stBadge = `<span class="badge ${color}">${status}</span>`;
            if(status === 'Revisi') actBtn = `<button onclick="openUpload('${judul}', ${i})" class="btn btn-sm btn-outline" style="color:red; border-color:red;">Revisi</button>`;
            else actBtn = `<span class="text-primary fw-bold" style="font-size:0.8rem">‚úî Selesai</span>`;
        }
        
        return `<tr>
            <td style="width:50px; text-align:center;">${i+1}</td>
            <td class="fw-bold">${judul}</td>
            <td class="text-muted">${a[2]}</td>
            <td>${stBadge}</td>
            <td style="text-align:right;">${actBtn}</td>
        </tr>`;
    }).join('');
    
    $('tbl-tugas').innerHTML = html;
    $('sel-prog-kkg').innerHTML = d.agenda.map(a => `<option>${a[1]}</option>`).join('');
    
    const pct = Math.min(100, Math.round((done / (d.target||1)) * 100));
    $('g-persen').innerText = pct + "%"; $('g-bar').style.width = pct + "%"; $('g-target').innerText = `${done}/${d.target} Selesai`;
}

/* --- 8. LOGIC KS (SPLIT VIEW) --- */
async function loadKS(force=false) {
    if(!force) { const c = ls.get('CACHE_KS'); if(c) renderKS(c); else loading(true); } else loading(true);
    
    // Fetch parallel
    const [ds, dp] = await Promise.all([
        req("getDataKS", { sekolah: USER.sekolah }),
        req("getDashboardGuru", { pin: USER.pin })
    ]);
    
    loading(false);
    if(ds) { ls.set('CACHE_KS', ds); renderKS(ds); }
    if(dp) { renderHistoryKS(dp); }
}

function renderKS(d) {
    $('ks-avg').innerText = Math.round(d.rataRataSekolah||0) + "%";
    $('ks-total').innerText = d.dataGuru.reduce((a,b) => a + b.selesai, 0);
    $('ks-imp').innerText = d.statsPengembangan.implemen;
    $('ks-ino').innerText = d.statsPengembangan.inovasi;

    if(d.dataGuru.length === 0) $('tbl-ks').innerHTML = "<tr><td colspan='3' class='text-center p-3'>Belum ada data.</td></tr>";
    else {
        $('tbl-ks').innerHTML = d.dataGuru.map(g => {
            let color = g.persen >= 80 ? 'var(--success)' : (g.persen >= 50 ? 'var(--warning)' : 'var(--primary)');
            return `<tr>
                <td class="fw-bold">${g.nama}</td>
                <td><div style="background:#eee; height:8px; border-radius:10px;"><div style="width:${g.persen}%; height:100%; background:${color}; border-radius:10px;"></div></div></td>
                <td style="text-align:right; font-weight:bold; color:${color}">${g.persen}%</td>
            </tr>`;
        }).join('');
    }
}

function renderHistoryKS(dp) {
    if(dp && dp.riwayat && dp.riwayat.length > 0) {
        $('list-riwayat').innerHTML = dp.riwayat.map(r => {
             let st = r[10];
             let color = st==='Diterima'?'bg-ok':(st==='Revisi'?'bg-rev':'bg-wait');
             return `<div style="padding: 12px; border-bottom: 1px solid #f0f0f0;">
                <div class="flex between mb-1">
                    <span class="badge" style="background:#f5f5f5; color:#555;">${r[5]}</span>
                    <span class="badge ${color}">${st}</span>
                </div>
                <div class="fw-bold" style="font-size:0.9rem;">${r[6]}</div>
                <div class="text-muted" style="font-size:0.75rem;">${r[1]}</div>
             </div>`;
        }).join('');
    } else {
        $('list-riwayat').innerHTML = "<div class='text-muted text-center p-3'>Belum ada aktivitas.</div>";
    }
}

/* --- 9. MODALS & SUBMITS --- */
function openModal(id) { $(id).style.display = 'flex'; }
function closeModal(id) { $(id).style.display = 'none'; }
function openUpload(judul, idx) { $('mdl-up').querySelector('form').reset(); $('t-judul').value=judul; $('t-idx').value=idx; openModal('mdl-up'); }

async function submitTugas(e) {
    e.preventDefault(); closeModal('mdl-up'); toast("Mengirim...");
    await req("simpanTugas", { 
        data: { pin_user: USER.pin, nama_user: USER.nama, sekolah_user: USER.sekolah, jenis_laporan: "Kegiatan Gugus", judul_dokumen: $('t-judul').value, link_video: $('t-link').value, catatan: $('t-cat').value }
    });
    toast("Tugas terkirim!"); loadGuru();
}

async function submitDev(e, jenis) {
    e.preventDefault();
    const isImp = jenis.includes('Implementasi');
    const nama = $(isImp?'imp-nama':'ino-nama').value;
    const extra = isImp ? `[PROG: ${$('sel-prog-kkg').value}] [KELAS: ${$('imp-kelas').value}] ` : '';
    closeModal(isImp?'mdl-imp':'mdl-ino'); toast("Mengirim...");
    
    await req("simpanTugas", {
        data: {
            pin_user: USER.pin, nama_user: USER.nama, sekolah_user: USER.sekolah,
            jenis_laporan: jenis, judul_dokumen: (isImp?"IMPL: ":"INOV: ")+nama,
            link_video: $(isImp?'imp-link':'ino-link').value, catatan: extra + $(isImp?'imp-desc':'ino-desc').value
        }
    });
    toast("Tersimpan!"); 
    if(isImp) $('imp-nama').value=""; else $('ino-nama').value="";
    loadGuru();
}

async function submitGeneric(e, jenis, modalId) {
    e.preventDefault(); closeModal(modalId); toast("Menyimpan...");
    const fd = new FormData(e.target); const obj = Object.fromEntries(fd.entries());
    
    let judul = jenis.toUpperCase(), catatan = "";
    if(jenis === 'Laporan Prestasi') {
        judul = "PRESTASI: " + obj.cabang.toUpperCase();
        catatan = `[SISWA: ${obj.nama_siswa}] [JUARA: ${obj.juara}] [TINGKAT: ${obj.tingkat}] [NO: ${obj.no_piagam}] [OLEH: ${obj.penyelenggara}]`;
    } else if(jenis === 'Laporan Pembiasaan') {
        judul = "PEMBIASAAN: " + obj.a;
        catatan = `[FREQ: ${obj.freq}] [KARAKTER: ${obj.karakter}] ${obj.desc}`;
    } else {
        judul = "EVENT: " + obj.a;
        catatan = `[SKALA: ${obj.scale}] [TGL: ${obj.b}] ${obj.desc}`;
    }

    await req("simpanTugas", {
        data: { pin_user: USER.pin, nama_user: USER.nama, sekolah_user: obj.sekolah, jenis_laporan: jenis, judul_dokumen: judul, link_video: obj.link_video || "-", catatan: catatan }
    });
    toast("Data tersimpan!"); loadKS(true);
}
</script>
</body>
</html>
