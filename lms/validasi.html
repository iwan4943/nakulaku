<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Validator Sekolah - LMS Nakula</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
  :root { --primary: #6610f2; --bg: #F3E5F5; --card: #FFFFFF; }
  body { background-color: var(--bg); font-family: 'Poppins', sans-serif; padding-bottom: 80px; }
  .hidden { display: none !important; }
  .card-pro { border: none; border-radius: 20px; background: var(--card); box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
  .header-card { background: var(--card); padding: 1rem; border-radius: 20px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
  .nav-pills .nav-link.active { background-color: var(--primary); }
</style>
</head>
<body>

<div id="loading" class="position-fixed top-0 start-0 w-100 h-100 bg-white bg-opacity-90 d-none justify-content-center align-items-center" style="z-index:9999;"><div class="spinner-border text-primary"></div></div>

<div id="view-login" class="container d-flex flex-column justify-content-center" style="min-height: 100vh;">
  <div class="text-center mb-4"><i class="bi bi-patch-check-fill text-primary display-1"></i><h4 class="fw-bold mt-3 text-primary">VALIDATOR</h4></div>
  <div class="card-pro p-4 mx-auto" style="max-width: 400px; width: 100%;">
    <input type="number" id="inputPIN" class="form-control text-center mb-3" placeholder="PIN ANDA">
    <button onclick="doLogin()" class="btn btn-primary w-100 rounded-pill py-2 fw-bold" style="background-color: var(--primary)">MASUK</button>
  </div>
</div>

<div id="view-main" class="hidden container mt-3">
    <div class="header-card">
      <div class="d-flex align-items-center"><i class="bi bi-shield-check text-primary fs-3 me-3"></i><div><div class="fw-bold">Validator Data</div><div class="text-muted small" id="txtNama">...</div></div></div>
      <button onclick="doLogout()" class="btn btn-sm btn-outline-danger rounded-pill px-3">Keluar</button>
    </div>

    <ul class="nav nav-pills mb-3 justify-content-center">
      <li class="nav-item"><button class="nav-link active rounded-pill px-3 me-1" data-bs-toggle="pill" data-bs-target="#tab-pres">PRESTASI</button></li>
      <li class="nav-item"><button class="nav-link rounded-pill px-3 me-1" data-bs-toggle="pill" data-bs-target="#tab-evt">EVENT</button></li>
      <li class="nav-item"><button class="nav-link rounded-pill px-3" data-bs-toggle="pill" data-bs-target="#tab-bias">BIAS</button></li>
    </ul>

    <div class="tab-content">
      <div class="tab-pane fade show active" id="tab-pres"><div id="list-pres"></div></div>
      <div class="tab-pane fade" id="tab-evt"><div id="list-evt"></div></div>
      <div class="tab-pane fade" id="tab-bias"><div id="list-bias"></div></div>
    </div>
</div>

<div class="modal fade" id="mdlNilai"><div class="modal-dialog modal-dialog-centered"><div class="modal-content p-4">
  <input type="hidden" id="n_id"><input type="hidden" id="n_type">
  <h5 class="fw-bold text-center mb-4 text-primary">Validasi Bukti</h5>
  <label class="small fw-bold text-muted">KEPUTUSAN VALIDASI</label>
  <select id="n_valid" class="form-select mb-3 text-center fw-bold fs-5">
    <option value="VALID" class="text-success">✅ DITERIMA / VALID</option>
    <option value="INVALID" class="text-danger">❌ REVISI / INVALID</option>
  </select>
  <label class="small fw-bold text-muted">CATATAN</label>
  <textarea id="n_feed" class="form-control mb-4" rows="3" placeholder="Alasan jika invalid..."></textarea>
  <button onclick="saveNilai()" class="btn btn-primary w-100 rounded-pill fw-bold" style="background-color: var(--primary)">KIRIM VALIDASI</button>
</div></div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbyk0nTT7ZTkH_5BOnjcpS8trcH_-gPtKgzy0PC6K5J93xUIBTUdx4gZ9VkvH2le3ftE/exec"; 
let USER={}, modalNi, DATA_PRES=[], DATA_EVT=[], DATA_BIAS=[];

window.onload = () => {
  modalNi = new bootstrap.Modal(document.getElementById('mdlNilai'));
  let s = localStorage.getItem('LMS_VALID_PIN'); if(s) { document.getElementById('inputPIN').value = s; doLogin(true); }
}

async function apiCall(a, p = {}) { try { let r = await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action: a, ...p }) }); return await r.json(); } catch(e) { return null; } }
function showLoad(x){ document.getElementById('loading').className = x ? 'position-fixed top-0 start-0 w-100 h-100 bg-white bg-opacity-90 d-flex justify-content-center align-items-center' : 'd-none'; }

async function doLogin(auto){
  let p = document.getElementById('inputPIN').value;
  showLoad(true); let r = await apiCall("login", { pin: p }); showLoad(false);
  if(r && r.sukses && r.role === 'PENILAI') {
    localStorage.setItem('LMS_VALID_PIN', p); USER = { nama: r.nama };
    document.getElementById('view-login').classList.add('hidden'); document.getElementById('view-main').classList.remove('hidden');
    document.getElementById('txtNama').innerText = r.nama; loadPenilai();
  } else if(!auto) { Swal.fire('Error','Akses Ditolak','error'); }
}
function doLogout(){ localStorage.removeItem('LMS_VALID_PIN'); location.reload(); }

async function loadPenilai() {
  showLoad(true); let data = await apiCall("getDashboardPenilai"); showLoad(false);
  if(data) {
    DATA_PRES = data.prestasi; 
    DATA_EVT = data.sekolah.filter(i => i.jenis === 'Laporan Event');
    DATA_BIAS = data.sekolah.filter(i => i.jenis === 'Laporan Pembiasaan');
    renderList(DATA_PRES, 'list-pres', 'PRES'); renderList(DATA_EVT, 'list-evt', 'EVT'); renderList(DATA_BIAS, 'list-bias', 'BIAS');
  }
}

function renderList(data, id, type) {
  let el = document.getElementById(id); let html = "";
  data.sort((a,b) => (a.status==='Menunggu' ? -1 : 1));
  data.forEach(item => {
    let st = item.status, bg = st==='Menunggu'?'bg-warning':(st==='Diterima'?'bg-success':'bg-danger');
    let link = (item.link && item.link.length>5) ? `<a href="${item.link}" target="_blank" class="btn btn-sm btn-outline-secondary rounded-pill py-0 px-2 mt-1" style="font-size:0.7rem">Cek Bukti</a>` : "";
    html += `<div class="card-pro p-3 mb-2 border-start border-4 border-info"><div class="d-flex justify-content-between align-items-start">
      <div class="pe-2"><span class="badge ${bg} mb-1" style="font-size:0.65rem">${st}</span><div class="fw-bold small">${item.judul}</div><div class="small text-muted mb-1">${item.catatan || 'No Note'}</div>${link}</div>
      <button onclick="popNilai('${item.id}', '${type}')" class="btn btn-sm btn-info text-white rounded-pill px-3 shadow-sm" style="font-size:0.8rem">Validasi</button>
    </div></div>`;
  });
  el.innerHTML = html || "<div class='text-center py-4 small text-muted'>Tidak ada data</div>";
}

function popNilai(id, type){ document.getElementById('n_id').value = id; document.getElementById('n_type').value = type; document.getElementById('n_feed').value = ""; modalNi.show(); }

async function saveNilai(){
  let id = document.getElementById('n_id').value, type = document.getElementById('n_type').value, val = document.getElementById('n_valid').value, note = document.getElementById('n_feed').value;
  let st = val === 'VALID' ? 'Diterima' : 'Revisi', feed = (val==='VALID'?'[ACC] ':'[REVISI] ') + note;
  modalNi.hide(); Swal.fire({title:'Tersimpan', icon:'success', timer:1000, toast:true, position:'top-end'});
  
  let targetArr = type==='PRES'? DATA_PRES : (type==='EVT'? DATA_EVT : DATA_BIAS);
  let idx = targetArr.findIndex(i => i.id === id); if(idx !== -1) { targetArr[idx].status = st; }
  renderList(targetArr, type==='PRES'?'list-pres':(type==='EVT'?'list-evt':'list-bias'), type);

  await apiCall("simpanNilai", { id: id, status: st, feedback: feed, adminName: USER.nama });
}
</script>
</body>
</html>
