<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Panel Narasumber - LMS Guru</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
  /* --- THEME VARIABLES (Professional Teal) --- */
  :root { 
    --primary: #0f766e; /* Deep Teal */
    --primary-light: #ccfbf1; 
    --accent: #d97706; /* Amber Darker */
    --bg-body: #f8fafc; /* Slate 50 */
    --surface: #ffffff;
    --text-main: #0f172a;
    --text-muted: #64748b;
    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    --radius: 16px;
  }

  /* --- GLOBAL STYLES --- */
  body { 
    background-color: var(--bg-body); 
    font-family: 'Poppins', sans-serif; 
    color: var(--text-main);
    padding-bottom: 80px; 
    -webkit-font-smoothing: antialiased;
  }

  .hidden { display: none !important; }
  .fw-medium { font-weight: 500; }
  
  /* --- COMPONENTS --- */
  .btn-gradient { 
    background: linear-gradient(135deg, var(--primary) 0%, #0d9488 100%); 
    color: white; border: none; border-radius: 50px; 
    padding: 12px 24px; font-weight: 600; width: 100%; 
    transition: all 0.3s ease; box-shadow: var(--shadow-md);
  }
  .btn-gradient:active { transform: scale(0.98); }
  
  .card-pro { 
    border: none; border-radius: var(--radius); 
    background: var(--surface); 
    box-shadow: var(--shadow-sm);
    transition: transform 0.2s;
    overflow: hidden; 
  }

  /* --- LOGIN STYLES --- */
  .login-wrapper {
    min-height: 100vh;
    background: linear-gradient(135deg, #e2e8f0 0%, #f1f5f9 100%);
    display: flex; align-items: center; justify-content: center;
    padding: 20px;
  }
  .card-login {
    width: 100%; max-width: 400px;
    background: rgba(255, 255, 255, 0.95);
    padding: 2.5rem; border-radius: 24px; box-shadow: var(--shadow-md);
    text-align: center;
  }

  /* --- DASHBOARD STYLES --- */
  .header-card { 
    background: var(--surface); padding: 1rem 1.5rem; 
    border-radius: var(--radius); display: flex; justify-content: space-between; align-items: center; 
    margin-bottom: 2rem; box-shadow: var(--shadow-sm); border-bottom: 3px solid var(--primary-light);
  }

  /* Folder Grid */
  .card-materi {
    cursor: pointer; padding: 1.5rem; height: 100%;
    display: flex; flex-direction: column; border: 1px solid rgba(0,0,0,0.05);
  }
  .card-materi:hover { transform: translateY(-4px); border-color: var(--primary-light); box-shadow: var(--shadow-md); }
  
  .folder-icon {
    width: 48px; height: 48px; border-radius: 12px;
    background: var(--primary-light); color: var(--primary);
    display: flex; align-items: center; justify-content: center; font-size: 1.4rem;
    margin-bottom: 1rem; flex-shrink: 0;
  }

  /* List Item */
  .list-item { border-left: 4px solid transparent; transition: background 0.2s; cursor: pointer;}
  .list-item:hover { background-color: #f1f5f9; }
  .list-item.status-wait { border-left-color: var(--accent); }
  .list-item.status-done { border-left-color: var(--primary); }
  .list-item.status-rev { border-left-color: #ef4444; }

  .badge-soft-warning { background-color: #fffbeb; color: #b45309; border: 1px solid #fcd34d; }
  .badge-soft-success { background-color: #ecfdf5; color: #047857; border: 1px solid #6ee7b7; }
  .badge-soft-danger { background-color: #fef2f2; color: #b91c1c; border: 1px solid #fca5a5; }

  #loading { z-index: 9999; backdrop-filter: blur(2px); }
</style>
</head>
<body>

<div id="loading" class="position-fixed top-0 start-0 w-100 h-100 bg-white bg-opacity-75 d-none justify-content-center align-items-center">
    <div class="spinner-border text-success" role="status" style="width: 3rem; height: 3rem;"></div>
</div>

<div id="view-login" class="login-wrapper">
  <div class="card-login">
    <div class="bg-success bg-opacity-10 text-success rounded-4 d-inline-flex p-3 mb-3">
        <i class="bi bi-person-workspace fs-1"></i>
    </div>
    <h3 class="fw-bold mb-1" style="color:var(--primary)">Akses Narasumber</h3>
    <p class="text-muted small mb-4">Panel Validasi LMS Guru</p>
    
    <div class="form-floating mb-4">
      <input type="number" id="inputPIN" class="form-control fw-bold text-center" placeholder="PIN" style="letter-spacing: 4px; height: 60px; font-size: 1.5rem;">
      <label for="inputPIN" class="w-100 text-center">PIN AKSES</label>
    </div>
    
    <button onclick="doLogin()" class="btn-gradient">MASUK DASHBOARD</button>
  </div>
</div>

<div id="view-main" class="hidden container mt-4">
    
    <div class="header-card">
      <div class="d-flex align-items-center gap-3">
        <div class="bg-success-subtle text-success rounded-circle d-flex align-items-center justify-content-center flex-shrink-0" style="width:45px;height:45px;">
            <i class="bi bi-person-badge fs-5"></i>
        </div>
        <div style="min-width: 0;">
            <div class="text-muted small lh-1">Narasumber Aktif,</div>
            <div class="fw-bold text-dark text-truncate" id="txtNama">...</div>
        </div>
      </div>
      <button onclick="doLogout()" class="btn btn-sm btn-outline-danger rounded-pill px-3 fw-medium">
        <i class="bi bi-box-arrow-right"></i> Keluar
      </button>
    </div>

    <div id="view-inbox-grid">
       <div class="d-flex justify-content-between mb-4 align-items-center">
           <div>
               <h5 class="fw-bold m-0 text-dark">Topik Diklat</h5>
               <small class="text-muted">Pilih folder untuk menilai</small>
           </div>
           <span class="badge rounded-pill bg-light text-dark border px-3 py-2" id="badge-inbox-pending">Syncing...</span>
       </div>
       <div class="row g-3" id="grid-inbox"></div>
    </div>

    <div id="view-inbox-list" class="hidden">
       <div class="card-pro p-3 mb-4 d-flex align-items-center shadow-sm" style="border-left: 5px solid var(--accent);">
          <button onclick="backToInboxGrid()" class="btn btn-light rounded-circle me-3 shadow-sm border flex-shrink-0" style="width:40px;height:40px;">
            <i class="bi bi-arrow-left"></i>
          </button>
          <div style="min-width: 0;">
              <div class="text-muted small lh-1">Topik Aktif</div>
              <div class="fw-bold text-dark text-truncate" id="lbl-inbox-active">...</div>
          </div>
       </div>
       
       <div id="list-inbox-container"></div>
    </div>
</div>

<div class="modal fade" id="mdlNilai" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable"> 
        <div class="modal-content border-0 shadow-lg" style="border-radius: 20px; overflow: hidden;">
            
            <div class="modal-header text-white border-0" style="background: var(--primary);">
                <div style="min-width: 0;">
                    <h5 class="modal-title fw-bold"><i class="bi bi-clipboard-check me-2"></i>Form Validasi</h5>
                    <small class="opacity-75">Penilaian Objektif (Blind Review)</small>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body p-0">
                
                <div class="bg-light p-4 border-bottom">
                    <div class="d-flex align-items-center justify-content-between mb-2">
                        <span class="badge bg-white text-primary border shadow-sm px-2 py-1">ID PESERTA</span>
                        <small class="text-muted fw-bold" id="n_display_nama">#ID-XXXX</small>
                    </div>
                    
                    <h6 class="fw-bold text-dark mb-3 lh-base text-break" id="n_display_judul">Judul Laporan...</h6>
                    
                    <div class="p-3 bg-white rounded border border-light shadow-sm">
                        <small class="text-muted d-block mb-1 fw-bold" style="font-size: 0.7rem;">CATATAN / URAIAN PESERTA:</small>
                        <div id="n_display_desc" class="text-secondary small text-break" style="line-height: 1.6; max-height: 200px; overflow-y:auto; white-space: pre-wrap;">
                            Memuat data...
                        </div>
                    </div>

                    <div id="n_display_link_container" class="mt-3 hidden">
                         <a href="#" target="_blank" id="n_display_link" class="btn btn-outline-primary btn-sm w-100 border-2 fw-medium text-truncate">
                            <i class="bi bi-file-earmark-pdf me-2"></i>Buka Dokumen/Video Bukti
                         </a>
                    </div>
                </div>

                <div class="p-4">
                    <input type="hidden" id="n_id">
                    
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-muted ls-1">PREDIKAT KELULUSAN</label>
                        <select id="n_huruf" class="form-select form-select-lg fw-bold border-2" style="color:var(--primary); background-color: var(--surface);">
                            <option value="A">A - Sangat Baik</option>
                            <option value="B">B - Baik</option>
                            <option value="C">C - Cukup</option>
                            <option value="D" class="text-danger">D - Perlu Revisi</option>
                            <option value="E" class="text-danger">E - Belum Lengkap</option>
                        </select>
                        <div class="form-text small">*D & E status akan menjadi <b>Revisi</b>.</div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label small fw-bold text-muted ls-1">UMPAN BALIK NARASUMBER</label>
                        <textarea id="n_feed" class="form-control bg-light" rows="2" placeholder="Tuliskan apresiasi atau poin perbaikan..."></textarea>
                    </div>

                    <button onclick="saveNilai()" class="btn btn-gradient py-3 shadow-md">
                        <i class="bi bi-check-circle-fill me-2"></i>KIRIM VALIDASI
                    </button>
                </div>

            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// --- KONFIGURASI ---
// Pastikan URL ini sama dengan URL Deployment Terbaru Anda
const GAS_URL = "https://script.google.com/macros/s/AKfycbyk0nTT7ZTkH_5BOnjcpS8trcH_-gPtKgzy0PC6K5J93xUIBTUdx4gZ9VkvH2le3ftE/exec"; 

let USER={}, modalNi, GLOBAL_DATA_TUGAS=[], GLOBAL_DATA_AGENDA=[];

// --- HISTORY NAVIGATION ---
window.onpopstate = function(event) {
    if (!document.getElementById('view-inbox-list').classList.contains('hidden')) {
        forceBackToGrid();
    }
};

// --- INITIALIZATION ---
window.onload = () => {
  modalNi = new bootstrap.Modal(document.getElementById('mdlNilai'));
  let s = localStorage.getItem('LMS_NARASUMBER_PIN'); 
  if(s) { document.getElementById('inputPIN').value = s; doLogin(true); }
}

// --- API ---
async function apiCall(a, p = {}) { 
    try { 
        let r = await fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action: a, ...p }) }); 
        return await r.json(); 
    } catch(e) { console.error(e); return null; } 
}

function showLoad(x){ 
    const el = document.getElementById('loading');
    x ? (el.classList.remove('d-none'), el.classList.add('d-flex')) : (el.classList.add('d-none'), el.classList.remove('d-flex'));
}

// --- AUTHENTICATION ---
async function doLogin(auto){
  let p = document.getElementById('inputPIN').value;
  if(!p) return Swal.fire('Perhatian', 'Masukkan PIN Narasumber', 'warning');

  showLoad(true); 
  let r = await apiCall("login", { pin: p }); 
  showLoad(false);

  if(r && r.sukses && (r.role === 'PENILAI' || r.role === 'ADMIN')) {
    localStorage.setItem('LMS_NARASUMBER_PIN', p); 
    USER = { nama: r.nama, pin: p };
    
    document.getElementById('view-login').classList.add('hidden');
    document.getElementById('view-main').classList.remove('hidden');
    document.getElementById('txtNama').innerText = r.nama; 
    loadPenilai(); 
  } else if(!auto) { 
    Swal.fire('Akses Ditolak','PIN Tidak Valid / Bukan Narasumber','error'); 
  }
}

function doLogout(){ 
    Swal.fire({
        title: 'Akhiri Sesi?', text: "Keluar dari panel narasumber.", icon: 'question', 
        showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Ya'
    }).then((r) => { if (r.isConfirmed) { localStorage.removeItem('LMS_NARASUMBER_PIN'); location.reload(); } })
}

// --- DASHBOARD LOGIC ---
async function loadPenilai() {
  showLoad(true); 
  let data = await apiCall("getDashboardPenilai"); 
  showLoad(false);

  if(data) {
    GLOBAL_DATA_TUGAS = data.tugas; 
    GLOBAL_DATA_AGENDA = data.agenda;
    renderFolders(GLOBAL_DATA_AGENDA, GLOBAL_DATA_TUGAS); 
  } else { Swal.fire('Gagal', 'Koneksi Error', 'error'); }
}

function renderFolders(agenda, allTasks) {
    let grid = document.getElementById('grid-inbox'); grid.innerHTML = ""; 
    let total = 0;
    
    agenda.forEach(a => {
        let tasks = allTasks.filter(t => t.judul === a.materi || t.judul.includes(a.materi));
        let pending = tasks.filter(t => t.status === 'Menunggu').length; 
        total += pending;
        let narsum = a.narsum || "Tim Narasumber";

        grid.innerHTML += `
        <div class="col-6 col-md-4 col-xl-3">
            <div class="card-pro card-materi position-relative h-100" onclick="openInboxFolder('${a.materi}')">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <div class="folder-icon"><i class="bi bi-journal-text"></i></div>
                    ${pending > 0 ? `<span class="badge bg-danger rounded-pill shadow-sm py-1 px-2" style="font-size:0.6rem">${pending} Baru</span>` : ''}
                </div>
                <div class="mb-3">
                    <div class="fw-bold text-dark lh-sm mb-2 text-truncate" style="font-size: 0.95rem;">${a.materi}</div>
                    <div class="progress" style="height: 4px; width: 40px;"><div class="progress-bar bg-success" style="width: 100%"></div></div>
                </div>
                <div class="mt-auto pt-3 border-top border-light">
                    <div class="d-flex align-items-center gap-2 text-muted small mb-1"><i class="bi bi-person-video3"></i> <span class="text-truncate fw-medium">${narsum}</span></div>
                </div>
            </div>
        </div>`;
    });
    
    let elBadge = document.getElementById('badge-inbox-pending');
    if(total > 0) {
        elBadge.className = "badge bg-danger rounded-pill shadow-sm px-3 py-2";
        elBadge.innerText = `${total} Perlu Validasi`;
    } else {
        elBadge.className = "badge bg-success bg-opacity-10 text-success border border-success rounded-pill px-3 py-2";
        elBadge.innerText = "Semua Tervalidasi";
    }
}

function openInboxFolder(m) {
    history.pushState({page: 'folder'}, '', '#topic');
    document.getElementById('view-inbox-grid').classList.add('hidden'); 
    document.getElementById('view-inbox-list').classList.remove('hidden');
    document.getElementById('lbl-inbox-active').innerText = m;
    renderList(GLOBAL_DATA_TUGAS.filter(t => t.judul.includes(m)), 'list-inbox-container'); 
    window.scrollTo(0,0);
}

function backToInboxGrid() { history.back(); }
function forceBackToGrid() {
    document.getElementById('view-inbox-list').classList.add('hidden'); 
    document.getElementById('view-inbox-grid').classList.remove('hidden'); 
    renderFolders(GLOBAL_DATA_AGENDA, GLOBAL_DATA_TUGAS);
}

function renderList(data, id) {
  let el = document.getElementById(id); let html = "";
  // Sort: Menunggu paling atas
  data.sort((a,b) => (a.status==='Menunggu' ? -1 : 1));
  
  data.forEach(item => {
    let st = item.status;
    let badgeClass = st==='Menunggu' ? 'badge-soft-warning' : (st==='Diterima' ? 'badge-soft-success' : 'badge-soft-danger');
    let borderClass = st==='Menunggu' ? 'status-wait' : (st==='Diterima' ? 'status-done' : 'status-rev');
    let iconStatus = st==='Menunggu' ? '<i class="bi bi-hourglass-split me-1"></i>' : '<i class="bi bi-check-circle me-1"></i>';

    // UPDATE: Menampilkan ID Peserta (Masking Name)
    let displayID = "Peserta #" + item.id.substring(0, 8);

    html += `
    <div class="card-pro p-3 mb-3 list-item ${borderClass}" onclick="popNilai('${item.id}')">
      <div class="d-flex justify-content-between align-items-start">
        <div class="pe-2 w-100" style="min-width:0;">
           <div class="d-flex align-items-center mb-2">
               <span class="badge ${badgeClass} rounded-pill py-1 px-2 d-flex align-items-center" style="font-size:0.65rem">${iconStatus} ${st.toUpperCase()}</span>
               <span class="text-muted ms-2 small" style="font-size:0.7rem">${displayID}</span>
           </div>
           <div class="fw-bold text-dark mb-1 text-break" style="font-size: 0.95rem;">${item.judul}</div>
           <div class="text-muted small text-truncate">${item.catatan ? item.catatan : '<i>Tidak ada deskripsi singkat</i>'}</div>
        </div>
        <button class="btn btn-light text-primary rounded-circle shadow-sm ms-2 flex-shrink-0" style="width:40px; height:40px;">
            <i class="bi bi-pencil-square"></i>
        </button>
      </div>
    </div>`;
  });
  el.innerHTML = html || `<div class="text-center py-5"><h6 class="text-muted">Tidak ada laporan masuk di topik ini.</h6></div>`;
}

function popNilai(id){ 
    let item = GLOBAL_DATA_TUGAS.find(t => t.id === id);
    if(!item) { Swal.fire('Error', 'Data laporan tidak ditemukan', 'error'); return; }

    // UPDATE: Tampilkan ID di Header Modal
    document.getElementById('n_display_nama').innerText = "Peserta #" + item.id.substring(0, 8);
    
    document.getElementById('n_display_judul').innerText = item.judul;
    
    // FIX: Menggunakan 'catatan' dari backend
    document.getElementById('n_display_desc').innerText = item.catatan || "Tidak ada catatan dari guru.";

    let linkContainer = document.getElementById('n_display_link_container');
    let linkBtn = document.getElementById('n_display_link');
    if(item.link && item.link.length > 5) {
        linkContainer.classList.remove('hidden');
        linkBtn.href = item.link;
    } else { linkContainer.classList.add('hidden'); }

    document.getElementById('n_id').value = id; 
    document.getElementById('n_feed').value = ""; 
    document.getElementById('n_huruf').value = "A"; 
    modalNi.show(); 
}

async function saveNilai(){
  let id = document.getElementById('n_id').value;
  let h = document.getElementById('n_huruf').value;
  let note = document.getElementById('n_feed').value;
  let st = (h==='D'||h==='E') ? 'Revisi' : 'Diterima';
  let feed = `[Nilai: ${h}] ` + note;

  modalNi.hide(); 
  // Update UI lokal biar cepat
  let idx = GLOBAL_DATA_TUGAS.findIndex(i => i.id === id); 
  if(idx !== -1) { GLOBAL_DATA_TUGAS[idx].status = st; }
  
  // Refresh List
  renderList(GLOBAL_DATA_TUGAS.filter(t => t.judul.includes(document.getElementById('lbl-inbox-active').innerText)), 'list-inbox-container');
  
  Swal.fire({title:'Tervalidasi', icon:'success', timer:1000, showConfirmButton: false, toast:true, position:'top-end'});
  
  // Kirim ke Backend
  await apiCall("simpanNilai", { id: id, status: st, feedback: feed, adminName: USER.nama });
}
</script>
</body>
</html>
