<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
  <title>Akses Pengamat</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  
  <style>
    /* --- CSS SYSTEM: Mobile Optimized --- */
    :root {
      --primary: #B3261E;
      --on-primary: #FFFFFF;
      --surface: #FFF8F7;
      --surface-variant: #F2DEDC;
      --on-surface: #201A1A;
      --outline: #857372;
      --container-low: #FCEAE9;
      --container-high: #FFFFFF;
      --radius-xl: 24px;
      --radius-lg: 16px;
      --touch-target: 56px; /* Tinggi minimal tombol */
    }

    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    body { font-family: 'Roboto', sans-serif; background-color: var(--surface); color: var(--on-surface); line-height: 1.5; min-height: 100vh; font-size: 16px; }
    h1, h2, h3, .font-head { font-family: 'Google Sans', sans-serif; }

    /* Container HP */
    .app-container {
      width: 100%; max-width: 500px; margin: 0 auto; background: var(--surface); min-height: 100vh; display: flex; flex-direction: column; position: relative;
    }

    /* HEADER */
    .header-bar { 
      background: var(--surface); padding: 1rem 1.5rem; 
      display: flex; justify-content: space-between; align-items: center; 
      position: sticky; top: 0; z-index: 20;
      border-bottom: 1px solid var(--surface-variant);
    }
    .header-title h2 { font-size: 1.25rem; font-weight: 700; color: var(--on-surface); }
    .header-title p { font-size: 0.8rem; color: var(--primary); font-weight: 700; letter-spacing: 0.5px; text-transform: uppercase; }
    
    .btn-logout { 
      background: var(--container-low); color: var(--primary); padding: 8px 16px; 
      border-radius: 50px; font-size: 0.8rem; font-weight: 700; text-decoration: none; 
    }

    /* TABS NAVIGASI (Sticky di bawah Header) */
    .tabs-wrapper { position: sticky; top: 73px; z-index: 19; background: var(--surface); padding: 0 1rem; border-bottom: 1px solid var(--surface-variant); }
    .tabs { display: flex; gap: 1rem; }
    .tab-btn { 
      flex: 1; padding: 1rem 0; background: transparent; border: none; 
      font-family: 'Google Sans', sans-serif; font-weight: 700; color: var(--outline); 
      border-bottom: 4px solid transparent; cursor: pointer; transition: 0.2s; font-size: 1rem;
    }
    .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }

    /* AREA KONTEN */
    .content-area { flex: 1; padding: 1.5rem; padding-bottom: 100px; /* Space untuk tombol floating */ overflow-y: auto; }
    
    .card { background: var(--container-high); border-radius: var(--radius-xl); padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }

    /* INPUT FIELDS (Jumbo) */
    .form-group { margin-bottom: 1.5rem; }
    .form-label { display: block; font-size: 0.9rem; font-weight: 700; color: var(--on-surface); margin-bottom: 0.5rem; }
    .input-jumbo { 
      width: 100%; height: var(--touch-target); padding: 0 1rem; 
      background: var(--container-low); border: 2px solid transparent; border-radius: 12px; 
      font-size: 1rem; font-weight: 500; color: var(--on-surface); outline: none; transition: 0.2s; appearance: none;
    }
    .input-jumbo:focus { background: #FFF; border-color: var(--primary); }

    /* ACTION GRID (Tiles) */
    .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .action-card input { display: none; }
    .action-box { 
      height: 80px; display: flex; align-items: center; justify-content: center; 
      border: 2px solid var(--surface-variant); border-radius: 16px; 
      font-weight: 700; color: var(--outline); cursor: pointer; transition: 0.2s; 
      font-family: 'Google Sans', sans-serif; font-size: 0.95rem;
    }
    
    /* Warna Aktif Tiles */
    .action-card input:checked + .action-box { border-color: transparent; transform: scale(1.02); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .act-1 input:checked + .action-box { background: #FFDAD6; color: #410002; } /* Bertanya */
    .act-2 input:checked + .action-box { background: #C4EED0; color: #074E23; } /* Menjawab */
    .act-3 input:checked + .action-box { background: #E8DEF8; color: #1D192B; } /* Presentasi */
    .act-4 input:checked + .action-box { background: #FFD8E4; color: #31111D; } /* Ice Breaking */

    /* TOMBOL UTAMA (Floating Bottom) */
    .fab-wrapper { 
      position: fixed; bottom: 0; left: 0; width: 100%; 
      background: linear-gradient(to top, var(--surface) 80%, transparent); 
      padding: 1.5rem; display: flex; justify-content: center; pointer-events: none; z-index: 30;
    }
    .btn-main { 
      pointer-events: auto; width: 100%; max-width: 500px; height: 56px; 
      background: var(--primary); color: white; border: none; border-radius: 50px; 
      font-size: 1.1rem; font-weight: 700; box-shadow: 0 4px 12px rgba(179, 38, 30, 0.4); 
      cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;
    }
    .btn-main:active { transform: scale(0.98); }
    .btn-main:disabled { background: var(--outline); cursor: not-allowed; opacity: 0.7; }

    /* LIST HISTORY */
    .hist-item { 
      display: flex; justify-content: space-between; align-items: center; 
      padding: 1rem; border-bottom: 1px solid var(--surface-variant); 
    }
    .hist-badge { padding: 6px 12px; border-radius: 8px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; }

    /* STAR RATING (Besar) */
    .rating-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
    .rating-label { font-size: 0.9rem; font-weight: 500; color: var(--outline); }
    .star-lg-wrapper { display: inline-flex; flex-direction: row-reverse; gap: 8px; }
    .star-lg-wrapper input { display: none; }
    .star-lg-wrapper label { color: #E0E0E0; font-size: 2rem; cursor: pointer; transition: 0.2s; line-height: 1; }
    .star-lg-wrapper label:hover, .star-lg-wrapper label:hover ~ label, .star-lg-wrapper input:checked ~ label { color: #F9AB00; transform: scale(1.1); }

    /* AUTH MODAL */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 100; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
    .modal-box { background: var(--surface); width: 85%; max-width: 340px; padding: 2rem; border-radius: 28px; text-align: center; }
    .pass-input { width: 100%; padding: 1rem; font-size: 1.5rem; text-align: center; letter-spacing: 0.5rem; font-weight: 700; border-radius: 16px; border: none; background: var(--container-low); margin-bottom: 1.5rem; outline: none; }

    /* UTILS */
    .hidden { display: none !important; }
    svg { fill: currentColor; }
    #toast { position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%) translateY(20px); background: #322F35; color: #F5EFF7; padding: 12px 24px; border-radius: 50px; font-weight: 700; opacity: 0; transition: 0.3s; z-index: 100; font-size: 0.9rem; white-space: nowrap; }
    #toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
  </style>
</head>
<body>

  <div id="modal-auth" class="modal-overlay">
    <div class="modal-box">
      <div style="width: 56px; height: 56px; background: var(--container-low); color: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem;">
         <svg viewBox="0 0 24 24" width="28" height="28"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-9-2c0-1.66 1.34-3 3-3s3 1.34 3 3v2H9V6zm9 14H6V10h12v10zm-6-3c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2z"/></svg>
      </div>
      <h3 class="font-head" style="font-size: 1.4rem; margin-bottom: 0.5rem;">PIN Pengamat</h3>
      <p style="color: var(--outline); margin-bottom: 1.5rem;">Masukkan kode akses.</p>
      <input type="password" id="auth-pass" class="pass-input" placeholder="••••" inputmode="numeric" maxlength="6">
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
         <a href="index.html" class="btn-main" style="background: transparent; color: var(--primary); border: 2px solid var(--surface-variant); box-shadow: none; font-size: 1rem; text-decoration: none;">Batal</a>
         <button onclick="submitAuth()" id="btn-auth" class="btn-main" style="font-size: 1rem;">Masuk</button>
      </div>
    </div>
  </div>

  <div id="app-view" class="app-container hidden">
    
    <div class="header-bar">
       <div class="header-title">
          <h2>Pengamat</h2>
          <p>Gugus Nakula</p>
       </div>
       <a href="index.html" class="btn-logout">Keluar</a>
    </div>

    <div class="tabs-wrapper">
       <div class="tabs">
          <button onclick="switchTab('tab-aktif')" id="btn-tab-aktif" class="tab-btn active">Keaktifan</button>
          <button onclick="switchTab('tab-kompak')" id="btn-tab-kompak" class="tab-btn">Kekompakan</button>
       </div>
    </div>

    <div id="tab-aktif" class="content-area">
       <div class="card">
          <div class="form-group">
             <label class="form-label">Nama Personil</label>
             <input type="text" id="log-nama" class="input-jumbo" placeholder="Ketik nama...">
          </div>
          
          <div class="form-group">
             <label class="form-label">Asal Sekolah</label>
             <select id="log-sekolah" class="input-jumbo"><option value="" disabled selected>Memuat data...</option></select>
          </div>

          <div class="form-group">
             <label class="form-label" style="margin-bottom: 12px;">Jenis Aktivitas</label>
             <div class="action-grid">
                <label class="action-card act-1"><input type="radio" name="aksi" value="Bertanya"><div class="action-box">Bertanya</div></label>
                <label class="action-card act-2"><input type="radio" name="aksi" value="Menjawab"><div class="action-box">Menjawab</div></label>
                <label class="action-card act-3"><input type="radio" name="aksi" value="Presentasi"><div class="action-box">Presentasi</div></label>
                <label class="action-card act-4"><input type="radio" name="aksi" value="Ice Breaking"><div class="action-box">Ice Breaking</div></label>
             </div>
          </div>
       </div>

       <h3 class="font-head" style="font-size: 1rem; color: var(--outline); margin: 0 0 1rem 0.5rem;">Riwayat Sesi Ini</h3>
       <div id="log-history" style="background: #FFF; border-radius: 16px; overflow: hidden; border: 1px solid var(--surface-variant);">
          <div style="padding: 2rem; text-align: center; color: var(--outline); font-style: italic;">Belum ada catatan.</div>
       </div>
       
       <div style="height: 60px;"></div>
    </div>

    <div id="tab-kompak" class="content-area hidden">
       <div style="background: #FFF8E1; color: #F57F17; padding: 1rem; border-radius: 12px; font-weight: 500; font-size: 0.9rem; margin-bottom: 1.5rem; text-align: center; border: 1px solid #FFE082;">
          Berikan bintang pada sekolah yang tampil.
       </div>

       <div id="list-sekolah-container"></div>
       
       <div style="height: 60px;"></div>
    </div>

    <div class="fab-wrapper">
       <button id="btn-main-action" class="btn-main" onclick="handleMainAction()">Simpan Catatan</button>
    </div>

  </div>

  <div id="toast">Notifikasi</div>

  <script>
    // --- SETUP ---
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxKg0VRlRs-ipgvVX1ma-rJ5RYowThx4w3z_lOwa8552cWdYTLmJfkzxMMt1SVP2JNN/exec"; 
    const CACHE_KEY = 'kkg_data_v1';
    let currentTab = 'tab-aktif';

    // --- AUTH ---
    function submitAuth() {
        const p = document.getElementById('auth-pass').value;
        if(!p) return;
        const btn = document.getElementById('btn-auth');
        const txt = btn.innerText; btn.innerText = '...'; btn.disabled = true;

        fetch(SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({ action: 'verifyPassword', payload: { pass: p, type: 'pengamat' } }),
            headers: { "Content-Type": "text/plain;charset=utf-8" }
        })
        .then(r => r.json())
        .then(res => {
            if(res === true) {
                document.getElementById('modal-auth').classList.add('hidden');
                document.getElementById('app-view').classList.remove('hidden');
                initData();
            } else {
                showToast("PIN Salah"); btn.innerText = txt; btn.disabled = false;
                document.getElementById('auth-pass').value = '';
            }
        })
        .catch(e => { showToast("Gagal koneksi"); btn.innerText = txt; btn.disabled = false; });
    }

    // --- DATA ---
    function initData() {
        const cached = localStorage.getItem(CACHE_KEY);
        if(cached) renderData(JSON.parse(cached));
        
        fetch(SCRIPT_URL + '?action=getDataOptions')
        .then(r => r.json())
        .then(data => {
            localStorage.setItem(CACHE_KEY, JSON.stringify(data));
            renderData(data);
        });
    }

    function renderData(data) {
        // Tab 1 Dropdown
        const sel = document.getElementById('log-sekolah');
        const curr = sel.value;
        sel.innerHTML = '<option value="" disabled selected>Pilih Sekolah</option>';
        data.sekolah.forEach(s => {
            let o = document.createElement('option'); o.value = s; o.text = s; sel.add(o);
        });
        if(curr) sel.value = curr;

        // Tab 2 List (Render sekali saja biar input ga reset)
        const con = document.getElementById('list-sekolah-container');
        if(con.innerHTML === "") {
            con.innerHTML = data.sekolah.map((sd, i) => `
                <div class="card card-k" data-sd="${sd}">
                   <h3 class="font-head" style="font-size: 1.1rem; padding-bottom: 12px; margin-bottom: 12px; border-bottom: 1px solid var(--surface-variant);">${sd}</h3>
                   ${renderStarRow('Seragam', `s_${i}`)}
                   ${renderStarRow('Antusias', `y_${i}`)}
                   ${renderStarRow('Kerjasama', `k_${i}`)}
                </div>
            `).join('');
        }
    }

    function renderStarRow(label, name) {
        let stars = '';
        for(let i=5; i>=1; i--) {
            stars += `<input type="radio" name="${name}" id="${name}_${i}" value="${i}"><label for="${name}_${i}">★</label>`;
        }
        return `<div class="rating-row"><span class="rating-label">${label}</span><div class="star-lg-wrapper">${stars}</div></div>`;
    }

    // --- TABS & BUTTON LOGIC ---
    function switchTab(id) {
        currentTab = id;
        // UI Tabs
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('btn-'+id).classList.add('active');
        
        // UI Content
        document.getElementById('tab-aktif').classList.add('hidden');
        document.getElementById('tab-kompak').classList.add('hidden');
        document.getElementById(id).classList.remove('hidden');

        // Button Text
        const btnMain = document.getElementById('btn-main-action');
        btnMain.innerText = (id === 'tab-aktif') ? "Simpan Catatan" : "Kirim Semua Nilai";
    }

    function handleMainAction() {
        if(currentTab === 'tab-aktif') submitLog();
        else submitKompak();
    }

    // --- SUBMIT LOGIC ---
    function submitLog() {
        const nama = document.getElementById('log-nama').value;
        const sekolah = document.getElementById('log-sekolah').value;
        const aksiEl = document.querySelector('input[name="aksi"]:checked');

        if(!nama || !sekolah || !aksiEl) { showToast("Lengkapi data dulu!"); return; }

        const btn = document.getElementById('btn-main-action');
        const txt = btn.innerText; btn.innerText = "Menyimpan..."; btn.disabled = true;

        const payload = { nama: nama, sekolah: sekolah, aksi: aksiEl.value };

        fetch(SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({ action: 'simpanLogKeaktifan', payload: payload }),
            headers: { "Content-Type": "text/plain;charset=utf-8" }
        })
        .then(r => r.json())
        .then(res => {
            if(res.success) {
                showToast("Berhasil dicatat!");
                // Add to list
                const hist = document.getElementById('log-history');
                if(hist.innerText.includes("Belum")) hist.innerHTML = '';
                
                let bg = "#FFDAD6", col = "#410002";
                if(payload.aksi.includes("Menjawab")) { bg="#C4EED0"; col="#074E23"; }
                
                hist.insertAdjacentHTML('afterbegin', `
                    <div class="hist-item">
                       <div><div style="font-weight:700;">${nama}</div><div style="font-size:0.8rem; color:var(--outline);">${sekolah}</div></div>
                       <div class="hist-badge" style="background:${bg}; color:${col};">${payload.aksi}</div>
                    </div>
                `);

                // Reset
                document.getElementById('log-nama').value = '';
                aksiEl.checked = false;
            }
            btn.innerText = txt; btn.disabled = false;
        })
        .catch(e => { showToast("Gagal kirim"); btn.innerText = txt; btn.disabled = false; });
    }

    function submitKompak() {
        const cards = document.querySelectorAll('.card-k');
        let votes = [];
        let hasVote = false;

        cards.forEach(c => {
            const sd = c.dataset.sd;
            const s = c.querySelector(`input[name^="s_"]:checked`)?.value || 0;
            const y = c.querySelector(`input[name^="y_"]:checked`)?.value || 0;
            const k = c.querySelector(`input[name^="k_"]:checked`)?.value || 0;
            if(s>0 || y>0 || k>0) hasVote = true;
            votes.push({ nama_sd: sd, s: s, y: y, k: k });
        });

        if(!hasVote) { showToast("Isi nilai minimal satu sekolah"); return; }

        const btn = document.getElementById('btn-main-action');
        const txt = btn.innerText; btn.innerText = "Mengirim Data..."; btn.disabled = true;

        fetch(SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({ action: 'simpanNilaiKekompakan', payload: votes }),
            headers: { "Content-Type": "text/plain;charset=utf-8" }
        })
        .then(r => r.json())
        .then(res => {
            showToast("Nilai tersimpan!");
            setTimeout(() => location.reload(), 1500);
        })
        .catch(e => { showToast("Gagal kirim"); btn.innerText = txt; btn.disabled = false; });
    }

    function showToast(m) {
        const t = document.getElementById('toast');
        t.innerText = m; t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 2500);
    }
  </script>
</body>
</html>
