<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
  <meta name="theme-color" content="#FFF8F7"> <title>Umpan Balik Kegiatan</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
  
  <style>
    /* MATERIAL DESIGN & CUSTOM STYLES */
    :root { --md-sys-color-primary: #B3261E; --md-sys-color-on-primary: #FFFFFF; --md-sys-color-primary-container: #FFDAD6; --md-sys-color-on-primary-container: #410002; --md-sys-color-surface: #FFF8F7; --md-sys-color-surface-container: #FCEAE9; --md-sys-color-surface-container-high: #FFFFFF; --md-sys-color-on-surface: #201A1A; --md-sys-color-on-surface-variant: #534341; --md-sys-color-outline: #857372; }
    body { font-family: 'Roboto', sans-serif; background-color: var(--md-sys-color-surface); color: var(--md-sys-color-on-surface); -webkit-tap-highlight-color: transparent; }
    h1, h2, h3, h4, h5, .font-google { font-family: 'Google Sans', sans-serif; }
    
    /* Perbaikan Touch Target */
    .star-rating-sm { direction: rtl; display: inline-flex; font-size: 1.5rem; gap: 4px; } /* Diperbesar sedikit */
    .star-rating-sm input { display: none; } .star-rating-sm label { color: #E0E0E0; cursor: pointer; transition: 0.2s; padding: 2px; } .star-rating-sm label:hover, .star-rating-sm label:hover ~ label, .star-rating-sm input:checked ~ label { color: #F9AB00; }
    
    .star-wrapper { display: flex; justify-content: center; width: 100%; padding: 5px 0; } 
    .star-rating { direction: rtl; display: inline-flex; font-size: 2.6rem; gap: 0.8rem; line-height: 1; } /* Spasi diperlebar */
    .star-rating input { display: none; } .star-rating label { color: #E0E0E0; cursor: pointer; transition: all 0.2s cubic-bezier(0.2, 0.0, 0, 1.0); } .star-rating label:hover, .star-rating label:hover ~ label, .star-rating input:checked ~ label { color: var(--md-sys-color-primary); transform: scale(1.1); }
    
    .fade-in { animation: fadeIn 0.3s cubic-bezier(0.2, 0, 0, 1) forwards; will-change: transform, opacity; } @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    
    /* Scrollbar hidden but functional for clean mobile look */
    .c-scroll { scrollbar-width: none; -ms-overflow-style: none; }
    .c-scroll::-webkit-scrollbar { display: none; }
    
    #toast-container { transition: transform 0.4s cubic-bezier(0.2, 0, 0, 1), opacity 0.3s; z-index: 100; } .toast-show { transform: translateY(0) !important; opacity: 1 !important; }
    .btn-material { border-radius: 50px; font-family: 'Google Sans', sans-serif; font-weight: 500; letter-spacing: 0.5px; transition: 0.2s; } .btn-material:active { transform: scale(0.96); }
    .card-material { background: var(--md-sys-color-surface-container-high); border-radius: 24px; border: none; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
    .input-material { background-color: var(--md-sys-color-surface-container); border: 1px solid transparent; border-radius: 12px; color: var(--md-sys-color-on-surface); transition: 0.2s; font-size: 16px; /* Mencegah zoom otomatis iOS */ } 
    .input-material:focus { background-color: #FFF; border-color: var(--md-sys-color-primary); outline: none; box-shadow: 0 0 0 2px rgba(179, 38, 30, 0.1); }
  </style>
</head>
<body class="min-h-screen flex flex-col items-center p-0 md:p-4">

  <div class="w-full md:max-w-md bg-[#FFF8F7] md:rounded-[32px] overflow-hidden min-h-screen md:min-h-[850px] md:h-auto flex flex-col relative border-0 md:border md:border-[#F2DEDC] shadow-none md:shadow-2xl">
    
    <div class="bg-[#FFF8F7] pt-6 pb-2 px-6 text-center z-20 sticky top-0 border-b border-transparent transition-all" id="main-header">
      <div class="w-12 h-1.5 rounded-full bg-red-100 mx-auto mb-4 md:hidden"></div>
      <h1 class="text-xl font-google font-medium text-[#201A1A] tracking-normal">Umpan Balik</h1>
      <p class="text-[#B3261E] text-xs font-bold uppercase tracking-widest mt-1">KKG Gugus Nakula</p>
    </div>

    <div id="loading" class="absolute inset-0 bg-[#FFF8F7] z-50 flex flex-col items-center justify-center">
      <div class="animate-spin rounded-full h-12 w-12 border-[4px] border-red-100 border-t-[#B3261E] mb-4"></div>
      <p class="text-[#534341] text-sm font-google font-medium animate-pulse">Menyiapkan Data...</p>
    </div>

    <div class="flex-1 relative overflow-hidden flex flex-col">
      
      <div id="view-identitas" class="p-6 fade-in hidden flex-1 flex flex-col justify-center">
        <div class="space-y-6 w-full max-w-sm mx-auto">
          <div class="text-center mb-4">
             <div class="w-20 h-20 bg-[#FFDAD6] text-[#410002] rounded-full flex items-center justify-center mx-auto mb-4 shadow-sm">
                <i class="fas fa-user-edit text-3xl"></i>
             </div>
            <h2 class="font-google text-2xl text-[#201A1A]">Identitas</h2>
            <p class="text-sm text-[#534341]">Silakan lengkapi data sebelum menilai.</p>
          </div>
          
          <div class="space-y-4">
              <div class="relative"><div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none"><i class="fas fa-map-marker-alt text-[#857372]"></i></div><select id="sel-lokasi" class="input-material w-full pl-12 p-4 text-sm font-medium appearance-none"><option value="" disabled selected>Pilih Lokasi</option></select></div>
              <div class="relative"><div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none"><i class="fas fa-microphone-alt text-[#857372]"></i></div><select id="sel-nara" class="input-material w-full pl-12 p-4 text-sm font-medium appearance-none"><option value="" disabled selected>Pilih Narasumber</option></select></div>
              <div class="relative"><div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none"><i class="fas fa-school text-[#857372]"></i></div><select id="sel-sekolah-peserta" class="input-material w-full pl-12 p-4 text-sm font-medium appearance-none"><option value="" disabled selected>Pilih Asal Sekolah</option></select></div>
          </div>
          <button onclick="toForm()" class="btn-material w-full bg-[#B3261E] text-white py-4 shadow-lg hover:shadow-xl mt-6 text-base font-bold flex items-center justify-center gap-2">Mulai Penilaian <i class="fas fa-arrow-right"></i></button>
        </div>
      </div>

      <form id="form-peserta" onsubmit="submitPeserta(event)" class="hidden fade-in flex flex-col h-full absolute inset-0 bg-[#FFF8F7] z-30">
        <div class="bg-[#FFF8F7] px-4 py-3 flex justify-between items-center sticky top-0 z-10 border-b border-[#F2DEDC] shadow-sm">
          <button type="button" onclick="goBack()" class="btn-material text-sm font-medium text-[#534341] bg-transparent py-2 px-3 hover:bg-[#F2DEDC]"><i class="fas fa-arrow-left mr-2"></i>Kembali</button>
          <span class="text-xs font-bold text-[#410002] bg-[#FFDAD6] px-4 py-1.5 rounded-full">Peserta</span>
        </div>
        
        <div class="flex-1 overflow-y-auto p-5 space-y-5 pb-32 c-scroll">
          <input type="hidden" name="lokasi" id="inp-lokasi"><input type="hidden" name="narasumber" id="inp-nara"><input type="hidden" name="asal_sekolah" id="inp-sekolah-peserta">
          
          <div class="card-material p-5">
             <div class="flex items-center gap-3 mb-6"><div class="w-10 h-10 rounded-full bg-[#FFDAD6] text-[#B3261E] flex items-center justify-center"><i class="fas fa-chalkboard-teacher"></i></div><h3 class="font-google font-medium text-lg text-[#201A1A]">Narasumber</h3></div>
             <div class="space-y-8 divide-y divide-[#F2DEDC]">
               <div class="pt-2 text-center"><p class="text-sm font-bold text-[#201A1A] mb-1">Penguasaan Materi</p><div class="star-wrapper"><div class="star-rating"><input type="radio" name="rating_materi" id="m5" value="5"><label for="m5">★</label><input type="radio" name="rating_materi" id="m4" value="4"><label for="m4">★</label><input type="radio" name="rating_materi" id="m3" value="3"><label for="m3">★</label><input type="radio" name="rating_materi" id="m2" value="2"><label for="m2">★</label><input type="radio" name="rating_materi" id="m1" value="1"><label for="m1">★</label></div></div></div>
               <div class="pt-6 text-center"><p class="text-sm font-bold text-[#201A1A] mb-1">Cara Penyajian</p><div class="star-wrapper"><div class="star-rating"><input type="radio" name="rating_presentasi" id="p5" value="5"><label for="p5">★</label><input type="radio" name="rating_presentasi" id="p4" value="4"><label for="p4">★</label><input type="radio" name="rating_presentasi" id="p3" value="3"><label for="p3">★</label><input type="radio" name="rating_presentasi" id="p2" value="2"><label for="p2">★</label><input type="radio" name="rating_presentasi" id="p1" value="1"><label for="p1">★</label></div></div></div>
               <div class="pt-6 text-center"><p class="text-sm font-bold text-[#201A1A] mb-1">Interaksi</p><div class="star-wrapper"><div class="star-rating"><input type="radio" name="rating_interaksi" id="i5" value="5"><label for="i5">★</label><input type="radio" name="rating_interaksi" id="i4" value="4"><label for="i4">★</label><input type="radio" name="rating_interaksi" id="i3" value="3"><label for="i3">★</label><input type="radio" name="rating_interaksi" id="i2" value="2"><label for="i2">★</label><input type="radio" name="rating_interaksi" id="i1" value="1"><label for="i1">★</label></div></div></div>
               <div class="pt-6 text-center"><p class="text-sm font-bold text-[#201A1A] mb-1">Waktu</p><div class="star-wrapper"><div class="star-rating"><input type="radio" name="rating_waktu" id="w5" value="5"><label for="w5">★</label><input type="radio" name="rating_waktu" id="w4" value="4"><label for="w4">★</label><input type="radio" name="rating_waktu" id="w3" value="3"><label for="w3">★</label><input type="radio" name="rating_waktu" id="w2" value="2"><label for="w2">★</label><input type="radio" name="rating_waktu" id="w1" value="1"><label for="w1">★</label></div></div></div>
             </div>
          </div>

          <div class="card-material p-5">
             <div class="flex items-center gap-3 mb-6"><div class="w-10 h-10 rounded-full bg-[#E8DEF8] text-[#1D192B] flex items-center justify-center"><i class="fas fa-users-cog"></i></div><h3 class="font-google font-medium text-lg text-[#201A1A]">Panitia</h3></div>
             <div class="space-y-8 divide-y divide-[#F2DEDC]">
               <div class="pt-2 text-center"><p class="text-sm font-bold text-[#201A1A] mb-1">Sarana Prasarana</p><div class="star-wrapper"><div class="star-rating"><input type="radio" name="rating_sarana" id="s5" value="5"><label for="s5">★</label><input type="radio" name="rating_sarana" id="s4" value="4"><label for="s4">★</label><input type="radio" name="rating_sarana" id="s3" value="3"><label for="s3">★</label><input type="radio" name="rating_sarana" id="s2" value="2"><label for="s2">★</label><input type="radio" name="rating_sarana" id="s1" value="1"><label for="s1">★</label></div></div></div>
               <div class="pt-6 text-center"><p class="text-sm font-bold text-[#201A1A] mb-1">Pelayanan</p><div class="star-wrapper"><div class="star-rating"><input type="radio" name="rating_pelayanan" id="l5" value="5"><label for="l5">★</label><input type="radio" name="rating_pelayanan" id="l4" value="4"><label for="l4">★</label><input type="radio" name="rating_pelayanan" id="l3" value="3"><label for="l3">★</label><input type="radio" name="rating_pelayanan" id="l2" value="2"><label for="l2">★</label><input type="radio" name="rating_pelayanan" id="l1" value="1"><label for="l1">★</label></div></div></div>
               <div class="pt-6 text-center"><p class="text-sm font-bold text-[#201A1A] mb-1">Susunan Acara</p><div class="star-wrapper"><div class="star-rating"><input type="radio" name="rating_acara" id="a5" value="5"><label for="a5">★</label><input type="radio" name="rating_acara" id="a4" value="4"><label for="a4">★</label><input type="radio" name="rating_acara" id="a3" value="3"><label for="a3">★</label><input type="radio" name="rating_acara" id="a2" value="2"><label for="a2">★</label><input type="radio" name="rating_acara" id="a1" value="1"><label for="a1">★</label></div></div></div>
             </div>
          </div>

          <div class="card-material p-5">
             <div class="flex items-center gap-3 mb-6"><div class="w-10 h-10 rounded-full bg-[#C4EED0] text-[#074E23] flex items-center justify-center"><i class="fas fa-home"></i></div><h3 class="font-google font-medium text-lg text-[#201A1A]">Tuan Rumah</h3></div>
             <div class="space-y-8 divide-y divide-[#F2DEDC]">
               <div class="pt-2 text-center"><p class="text-sm font-bold text-[#201A1A] mb-1">Tempat</p><div class="star-wrapper"><div class="star-rating"><input type="radio" name="rating_tempat" id="t5" value="5"><label for="t5">★</label><input type="radio" name="rating_tempat" id="t4" value="4"><label for="t4">★</label><input type="radio" name="rating_tempat" id="t3" value="3"><label for="t3">★</label><input type="radio" name="rating_tempat" id="t2" value="2"><label for="t2">★</label><input type="radio" name="rating_tempat" id="t1" value="1"><label for="t1">★</label></div></div></div>
               <div class="pt-6 text-center"><p class="text-sm font-bold text-[#201A1A] mb-1">Budaya & Ciri Khas</p><div class="star-wrapper"><div class="star-rating"><input type="radio" name="rating_budaya" id="j5" value="5"><label for="j5">★</label><input type="radio" name="rating_budaya" id="j4" value="4"><label for="j4">★</label><input type="radio" name="rating_budaya" id="j3" value="3"><label for="j3">★</label><input type="radio" name="rating_budaya" id="j2" value="2"><label for="j2">★</label><input type="radio" name="rating_budaya" id="j1" value="1"><label for="j1">★</label></div></div></div>
               <div class="pt-6 text-center"><p class="text-sm font-bold text-[#201A1A] mb-1">Pengemasan</p><div class="star-wrapper"><div class="star-rating"><input type="radio" name="rating_pengemasan" id="pm5" value="5"><label for="pm5">★</label><input type="radio" name="rating_pengemasan" id="pm4" value="4"><label for="pm4">★</label><input type="radio" name="rating_pengemasan" id="pm3" value="3"><label for="pm3">★</label><input type="radio" name="rating_pengemasan" id="pm2" value="2"><label for="pm2">★</label><input type="radio" name="rating_pengemasan" id="pm1" value="1"><label for="pm1">★</label></div></div></div>
               <div class="pt-6 text-center"><p class="text-sm font-bold text-[#201A1A] mb-1">Kebersihan</p><div class="star-wrapper"><div class="star-rating"><input type="radio" name="rating_kebersihan" id="k5" value="5"><label for="k5">★</label><input type="radio" name="rating_kebersihan" id="k4" value="4"><label for="k4">★</label><input type="radio" name="rating_kebersihan" id="k3" value="3"><label for="k3">★</label><input type="radio" name="rating_kebersihan" id="k2" value="2"><label for="k2">★</label><input type="radio" name="rating_kebersihan" id="k1" value="1"><label for="k1">★</label></div></div></div>
             </div>
          </div>

          <div class="card-material p-5">
            <label class="block text-sm font-google font-bold text-[#201A1A] mb-3">Masukan & Saran</label>
            <textarea name="saran" rows="3" class="input-material w-full p-3 resize-none" placeholder="Tuliskan saran untuk perbaikan..."></textarea>
          </div>
          
          <button type="submit" id="btn-submit-p" class="btn-material w-full bg-[#B3261E] text-white py-4 shadow-md hover:shadow-lg font-bold text-base">Kirim Penilaian</button>
        </div>
      </form>

      <div id="view-pengamat" class="hidden fade-in flex flex-col h-full absolute inset-0 bg-[#FFF8F7] z-30">
         <div class="bg-[#B3261E] text-white px-5 py-4 flex justify-between items-center shadow-md z-40 shrink-0">
            <div><h2 class="font-google font-medium text-lg leading-none">Pengamat</h2><p class="text-xs text-[#FFDAD6] mt-1">Gugus Nakula</p></div>
            <button onclick="goBack()" class="btn-material text-xs font-bold bg-[#FFDAD6] text-[#410002] px-4 py-2 hover:bg-white">Tutup</button>
         </div>
         <div class="flex bg-[#FFF8F7] shrink-0 px-2 pt-2">
           <button onclick="switchTab('tab-aktif')" id="btn-tab-aktif" class="flex-1 py-3 text-sm font-google font-medium text-[#B3261E] border-b-[3px] border-[#B3261E]">Keaktifan</button>
           <button onclick="switchTab('tab-kompak')" id="btn-tab-kompak" class="flex-1 py-3 text-sm font-google font-medium text-[#534341] border-b-[3px] border-transparent">Kekompakan</button>
         </div>
         
         <div id="tab-aktif" class="flex-1 overflow-y-auto p-4 space-y-4 c-scroll pb-24">
            <div class="card-material p-5">
               <h3 class="font-google font-bold text-[#201A1A] text-sm mb-4">Catat Personil</h3>
               <div class="space-y-4">
                 <div><label class="block text-xs font-bold text-[#857372] mb-1">Nama Personil</label><input type="text" id="log-nama" class="input-material w-full p-3 text-sm font-medium" placeholder="Contoh: Ibu Rina"></div>
                 <div><label class="block text-xs font-bold text-[#857372] mb-1">Asal Sekolah</label><select id="log-sekolah" class="input-material w-full p-3 text-sm font-medium"><option value="" disabled selected>Pilih Sekolah</option></select></div>
                 <div>
                    <label class="block text-xs font-bold text-[#857372] mb-2">Jenis Aktivitas</label>
                    <div class="grid grid-cols-2 gap-2">
                        <label class="cursor-pointer"><input type="radio" name="log-aksi" value="Bertanya" class="peer hidden"><div class="btn-material py-2 text-center text-xs border border-[#857372] text-[#534341] peer-checked:bg-[#FFDAD6] peer-checked:text-[#410002] peer-checked:border-transparent font-medium">Bertanya</div></label>
                        <label class="cursor-pointer"><input type="radio" name="log-aksi" value="Menjawab" class="peer hidden"><div class="btn-material py-2 text-center text-xs border border-[#857372] text-[#534341] peer-checked:bg-[#C4EED0] peer-checked:text-[#074E23] peer-checked:border-transparent font-medium">Menjawab</div></label>
                        <label class="cursor-pointer"><input type="radio" name="log-aksi" value="Presentasi" class="peer hidden"><div class="btn-material py-2 text-center text-xs border border-[#857372] text-[#534341] peer-checked:bg-[#E8DEF8] peer-checked:text-[#1D192B] peer-checked:border-transparent font-medium">Presentasi</div></label>
                        <label class="cursor-pointer"><input type="radio" name="log-aksi" value="Ice Breaking" class="peer hidden"><div class="btn-material py-2 text-center text-xs border border-[#857372] text-[#534341] peer-checked:bg-[#FFD8E4] peer-checked:text-[#31111D] peer-checked:border-transparent font-medium">Ice Breaking</div></label>
                    </div>
                 </div>
                 <button onclick="submitLogAktif()" id="btn-log-submit" class="btn-material w-full bg-[#201A1A] text-white py-3 mt-2 shadow-md">Simpan Catatan</button>
               </div>
            </div>
            <div class="mt-4"><h4 class="text-xs font-bold text-[#534341] uppercase mb-2 ml-1">Riwayat Sesi Ini</h4><div id="log-history" class="space-y-2"><p class="text-xs text-center text-[#857372] italic py-4">Belum ada catatan baru.</p></div></div>
         </div>

         <div id="tab-kompak" class="hidden flex-1 overflow-y-auto p-4 space-y-4 pb-32 c-scroll">
            <div class="bg-[#FFDAD6] p-3 rounded-2xl text-[#410002] text-xs text-center border border-[#B3261E] border-opacity-10 font-medium">Nilai aspek visual & kerjasama tim sekolah.</div>
            <div id="list-sekolah-container" class="space-y-3"></div>
            <div class="fixed bottom-0 left-0 w-full p-4 bg-[#FFF8F7] border-t border-[#F2DEDC] md:absolute z-50"><button onclick="submitKekompakan()" id="btn-submit-kompak" class="btn-material w-full bg-[#B3261E] text-white py-3 shadow-lg font-bold">Simpan Nilai</button></div>
         </div>
      </div>

      <div id="view-admin" class="hidden fade-in flex flex-col h-full absolute inset-0 bg-[#FFF8F7] z-40">
        <div class="bg-[#FFF8F7] px-5 py-3 border-b border-[#F2DEDC] flex justify-between items-center sticky top-0 z-10">
           <h2 class="font-google font-bold text-[#201A1A] text-lg">Dashboard</h2>
           <button onclick="goBack()" class="btn-material text-xs font-bold text-[#B3261E] bg-[#FFDAD6] px-4 py-2 rounded-full">Tutup</button>
        </div>
        <div class="p-4 bg-[#FFF8F7]"><select id="filter-admin" onchange="loadAdminData()" class="input-material w-full text-sm font-bold p-3"><option value="Semua">Semua Lokasi</option></select></div>
        <div id="admin-content" class="flex-1 overflow-y-auto p-4 pb-20 c-scroll"></div>
      </div>

    </div>

    <div class="bg-[#FCEAE9] h-20 px-6 flex justify-around items-center rounded-t-[24px] md:rounded-b-[24px] shadow-[0_-4px_20px_rgba(0,0,0,0.05)] relative z-20">
      <button onclick="authModal('panitia')" class="flex flex-col items-center gap-1 group w-16"><div class="w-16 h-8 rounded-full flex items-center justify-center group-hover:bg-[#FFDAD6] transition-colors"><i class="fas fa-chart-pie text-[#534341] group-hover:text-[#B3261E] text-lg"></i></div><span class="text-xs font-medium text-[#534341] group-hover:text-[#201A1A]">Laporan</span></button>
      <button onclick="authModal('pengamat')" class="flex flex-col items-center gap-1 group w-16"><div class="w-16 h-8 rounded-full flex items-center justify-center group-hover:bg-[#FFDAD6] transition-colors"><i class="fas fa-eye text-[#534341] group-hover:text-[#B3261E] text-lg"></i></div><span class="text-xs font-medium text-[#534341] group-hover:text-[#201A1A]">Pengamat</span></button>
    </div>

  </div>

  <div id="modal-auth" class="fixed inset-0 z-[60] bg-black/60 hidden flex items-center justify-center p-4 backdrop-blur-sm">
      <div class="bg-[#FFF8F7] rounded-[28px] p-6 w-full max-w-xs shadow-xl text-center">
          <i class="fas fa-lock text-[#B3261E] text-3xl mb-4"></i>
          <h3 id="auth-title" class="font-google font-bold text-[#201A1A] text-xl mb-1">Akses</h3>
          <p class="text-sm text-[#534341] mb-5">Masukkan kode akses untuk melanjutkan.</p>
          <input type="password" id="auth-pass" class="input-material w-full p-3 text-center text-xl font-bold mb-6 tracking-widest" placeholder="••••" inputmode="numeric">
          <div class="grid grid-cols-2 gap-3">
              <button onclick="closeAuth()" class="btn-material py-3 bg-transparent text-[#B3261E] border border-[#B3261E] font-bold">Batal</button>
              <button onclick="submitAuth()" id="btn-auth" class="btn-material py-3 bg-[#B3261E] text-white font-bold">Masuk</button>
          </div>
      </div>
  </div>
  
  <div id="toast-container" class="fixed bottom-24 left-1/2 -translate-x-1/2 z-[70] opacity-0 pointer-events-none transition-all w-max max-w-[90%]">
      <div id="toast-msg" class="bg-[#201A1A] text-[#F2F2F2] text-sm font-medium px-6 py-3 rounded-full shadow-lg flex items-center gap-3">
          <i class="fas fa-info-circle text-[#FFDAD6]"></i> <span>Notifikasi</span>
      </div>
  </div>

  <script>
    // ============================================
    // KONFIGURASI PENTING
    // ============================================
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxKg0VRlRs-ipgvVX1ma-rJ5RYowThx4w3z_lOwa8552cWdYTLmJfkzxMMt1SVP2JNN/exec"; 

    let globalData = {}; let currentAuthType = '';

    // Optimasi: DOMContentLoaded
    document.addEventListener('DOMContentLoaded', async function() {
        // Mulai load data SEGERA, tidak perlu nunggu font/gambar
        const data = await apiCall('getDataOptions');
        if(data) initData(data);
        
        // Setup History API Handling (Tombol Back HP)
        window.addEventListener('popstate', function(event) {
            const state = event.state;
            if (!state || state.view === 'home') {
                closeAllViews(); // Kembali ke identitas
            } else if (state.view === 'form') {
                // Handle kasus khusus jika perlu
            }
        });
    });

    async function apiCall(action, data = null, method = 'GET') {
        const url = method === 'GET' ? `${SCRIPT_URL}?action=${action}` : SCRIPT_URL;
        const options = { method: method };
        if (method === 'POST') {
            options.body = JSON.stringify({ action: action, payload: data });
            options.headers = { "Content-Type": "text/plain;charset=utf-8" };
        }
        try {
            const response = await fetch(url, options);
            return await response.json();
        } catch (error) {
            console.error(error); showToast("Gagal koneksi server", "error"); return null;
        }
    }

    function initData(data) {
      globalData = data;
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('view-identitas').classList.remove('hidden');
      fillSelect('sel-nara', data.narasumber); fillSelect('sel-lokasi', data.lokasi); fillSelect('sel-sekolah-peserta', data.sekolah);
      fillSelect('log-sekolah', data.sekolah); renderKekompakanForm(data.sekolah);
      
      // Reset history saat load pertama
      history.replaceState({view: 'home'}, '', '');
    }
    
    function fillSelect(id, list) {
      const sel = document.getElementById(id);
      sel.innerHTML = `<option value="" disabled selected>${sel.options[0].text}</option>`;
      if(list) list.forEach(item => { let o=document.createElement('option'); o.value=item; o.text=item; sel.add(o); });
    }

    // --- NAVIGASI DENGAN HISTORY API ---
    
    function toForm() {
      if(!document.getElementById('sel-nara').value || !document.getElementById('sel-lokasi').value || !document.getElementById('sel-sekolah-peserta').value) { showToast("Lengkapi data identitas"); return; }
      document.getElementById('inp-nara').value = document.getElementById('sel-nara').value;
      document.getElementById('inp-lokasi').value = document.getElementById('sel-lokasi').value;
      document.getElementById('inp-sekolah-peserta').value = document.getElementById('sel-sekolah-peserta').value;
      
      // UX: Push state agar tombol back HP bekerja
      history.pushState({view: 'form'}, '', '#form');
      
      document.getElementById('view-identitas').classList.add('hidden'); document.getElementById('form-peserta').classList.remove('hidden');
    }

    // Fungsi universal untuk tombol "Kembali" / "Tutup"
    function goBack() {
        if (history.state && history.state.view !== 'home') {
            history.back(); // Memicu popstate event
        } else {
            closeAllViews();
        }
    }

    function closeAllViews() {
        document.getElementById('form-peserta').classList.add('hidden');
        document.getElementById('view-pengamat').classList.add('hidden');
        document.getElementById('view-admin').classList.add('hidden');
        document.getElementById('modal-auth').classList.add('hidden');
        document.getElementById('view-identitas').classList.remove('hidden');
        
        // Pastikan URL bersih
        if (history.state && history.state.view !== 'home') {
             history.replaceState({view: 'home'}, '', ' ');
        }
    }

    // -----------------------------------

    async function submitPeserta(e) {
      e.preventDefault();
      const btn=document.getElementById('btn-submit-p'); const txt = btn.innerHTML; btn.innerHTML='<i class="fas fa-spinner fa-spin"></i> Mengirim...'; btn.disabled=true;
      const form=document.getElementById('form-peserta'); let data={}; new FormData(form).forEach((v,k)=>data[k]=v);
      const res = await apiCall('simpanData', data, 'POST');
      if (res && res.success) { showToast("Terkirim! Terima kasih.", "success"); setTimeout(() => location.reload(), 2000); }
      else { btn.innerHTML = txt; btn.disabled = false; showToast("Gagal kirim, coba lagi."); }
    }

    function switchTab(tabId) {
      document.getElementById('tab-aktif').classList.add('hidden'); document.getElementById('tab-kompak').classList.add('hidden');
      document.getElementById('btn-tab-aktif').className = "flex-1 py-3 text-sm font-google font-medium text-[#534341] border-b-[3px] border-transparent";
      document.getElementById('btn-tab-kompak').className = "flex-1 py-3 text-sm font-google font-medium text-[#534341] border-b-[3px] border-transparent";
      document.getElementById(tabId).classList.remove('hidden');
      document.getElementById('btn-'+tabId).className = "flex-1 py-3 text-sm font-google font-medium text-[#B3261E] border-b-[3px] border-[#B3261E]";
    }

    async function submitLogAktif() {
      const nama = document.getElementById('log-nama').value; const sek = document.getElementById('log-sekolah').value; const aksiEl = document.querySelector('input[name="log-aksi"]:checked');
      if(!nama || !sek || !aksiEl) { showToast("Lengkapi data jurnal"); return; }
      const btn = document.getElementById('btn-log-submit'); const txt = btn.innerHTML; btn.innerHTML='Menyimpan...'; btn.disabled=true;
      const res = await apiCall('simpanLogKeaktifan', {nama:nama, sekolah:sek, aksi:aksiEl.value}, 'POST');
      if(res && res.success) {
         showToast("Tercatat!"); btn.innerHTML='Simpan Catatan'; btn.disabled=false;
         document.getElementById('log-nama').value=''; 
         const hist = document.getElementById('log-history');
         if(hist.innerText.includes("Belum")) hist.innerHTML='';
         hist.insertAdjacentHTML('afterbegin', `<div class="bg-white p-3 rounded-xl border border-[#F2DEDC] flex justify-between items-center"><div class="text-xs"><span class="font-bold block text-[#201A1A] text-sm">${nama}</span><span class="text-xs text-[#534341]">${sek}</span></div><span class="text-[10px] font-bold bg-[#FFDAD6] text-[#410002] px-2 py-1 rounded-md">${aksiEl.value}</span></div>`);
      } else { btn.innerHTML = txt; btn.disabled = false; }
    }

    function renderKekompakanForm(list) {
      const c = document.getElementById('list-sekolah-container'); c.innerHTML='';
      if(list) list.forEach((sd,i) => {
        c.insertAdjacentHTML('beforeend', `<div class="card-material p-4 card-k" data-sd="${sd}"><h3 class="font-bold text-[#201A1A] text-sm mb-3 border-b border-[#F2DEDC] pb-2">${sd}</h3><div class="space-y-3"><div class="flex justify-between items-center"><span class="text-xs font-medium text-[#534341]">Seragam</span><div class="star-rating-sm">${[5,4,3,2,1].map(n=>`<input type="radio" name="s_${i}" id="s_${i}_${n}" value="${n}"><label for="s_${i}_${n}">★</label>`).join('')}</div></div><div class="flex justify-between items-center"><span class="text-xs font-medium text-[#534341]">Antusias</span><div class="star-rating-sm">${[5,4,3,2,1].map(n=>`<input type="radio" name="y_${i}" id="y_${i}_${n}" value="${n}"><label for="y_${i}_${n}">★</label>`).join('')}</div></div><div class="flex justify-between items-center"><span class="text-xs font-medium text-[#534341]">Kerjasama</span><div class="star-rating-sm">${[5,4,3,2,1].map(n=>`<input type="radio" name="k_${i}" id="k_${i}_${n}" value="${n}"><label for="k_${i}_${n}">★</label>`).join('')}</div></div></div></div>`);
      });
    }

    async function submitKekompakan() {
      let votes=[]; let hasVote=false;
      document.querySelectorAll('.card-k').forEach(card=>{
        const sd=card.dataset.sd;
        const s=card.querySelector('input[name^="s_"]:checked')?.value||0;
        const y=card.querySelector('input[name^="y_"]:checked')?.value||0;
        const k=card.querySelector('input[name^="k_"]:checked')?.value||0;
        if(s>0||y>0||k>0) hasVote=true;
        votes.push({nama_sd:sd, s:s, y:y, k:k});
      });
      if(!hasVote){showToast("Isi minimal satu nilai");return;}
      const btn=document.getElementById('btn-submit-kompak'); const txt = btn.innerHTML; btn.innerHTML='Menyimpan...'; btn.disabled=true;
      const res = await apiCall('simpanNilaiKekompakan', votes, 'POST');
      if(res && res.success) { showToast("Nilai Disimpan","success"); btn.innerHTML='Simpan Nilai'; btn.disabled=false; }
      else { btn.innerHTML = txt; btn.disabled = false; }
    }

    function renderAdmin(data) {
      if(!data || !data.peserta) return;
      const c = document.getElementById('admin-content'); const stats = data.peserta; const schools = data.sekolah; const det = stats.details; const logs = data.latest_logs;
      const sel = document.getElementById('filter-admin'); 
      if(sel.options.length<=1 && data.locations) data.locations.forEach(l => sel.add(new Option(l, l)));
      
      const renderBars = (obj) => {
        let html = '<div class="space-y-2 mt-4 pt-3 border-t border-white/20">';
        for (const [key, val] of Object.entries(obj)) {
          let percent = (parseFloat(val)/5)*100; html += `<div><div class="flex justify-between text-[10px] text-white/90 mb-1 font-medium"><span>${key}</span><span>${val}</span></div><div class="w-full bg-black/20 rounded-full h-1.5 overflow-hidden"><div class="bg-white rounded-full h-1.5" style="width: ${percent}%"></div></div></div>`;
        } return html + '</div>';
      };
      const renderRankList = (title, items, icon, colorBase) => {
         if(!items || !items.length) return '';
         return `<div class="card-material p-4 min-w-[280px]"><h4 class="text-xs font-bold uppercase text-[#857372] mb-4 flex items-center gap-2"><div class="w-6 h-6 rounded-lg bg-[#FFDAD6] text-[#B3261E] flex items-center justify-center"><i class="${icon}"></i></div>${title}</h4>` + items.slice(0,3).map((r,i)=>`<div class="flex justify-between items-center py-3 border-b border-[#F2DEDC] last:border-0"><div class="flex items-center gap-3 overflow-hidden"><span class="text-[10px] font-black w-6 h-6 flex items-center justify-center rounded-full ${i==0?'bg-[#FFB4AB] text-[#410002]':'bg-[#F2DEDC] text-[#534341]'}">${i+1}</span><div class="truncate"><span class="block text-xs font-bold text-[#201A1A] truncate">${r.nama}</span>${r.responden?`<span class="text-[10px] text-[#534341] font-medium">${r.responden} Responden</span>`:''}</div></div><span class="text-sm font-black text-[#B3261E]">${r.skor}</span></div>`).join('') + `</div>`;
      };

      let html = `<div class="bg-[#B3261E] text-white p-6 rounded-[28px] mb-6 shadow-xl relative overflow-hidden"><div class="absolute -right-4 -top-4 w-32 h-32 bg-[#FFB4AB] rounded-full opacity-20 blur-2xl"></div><div class="relative z-10 flex justify-between items-end"><div><p class="text-[11px] font-bold text-[#FFDAD6] uppercase tracking-widest mb-1">Total Responden</p><h3 class="text-5xl font-google font-medium tracking-tighter">${stats.count}</h3></div><div class="text-right"><p class="text-[10px] text-[#FFDAD6]">Update</p><p class="text-xs font-bold text-white">Barusan</p></div></div></div>`;
      html += `<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6"><div class="bg-[#8F4C38] rounded-[24px] p-5 text-white shadow-lg relative overflow-hidden"><div class="relative z-10"><p class="text-[10px] font-bold text-[#FFDAD6] uppercase tracking-widest mb-1">Narasumber</p><div class="flex items-baseline gap-2 mb-2"><h3 class="text-4xl font-google font-medium">${stats.avgNara}</h3><span class="text-xs text-[#FFDAD6] opacity-80">/ 5.0</span></div>${det&&det.nara?renderBars(det.nara):''}</div></div><div class="bg-[#9c4146] rounded-[24px] p-5 text-white shadow-lg relative overflow-hidden"><div class="relative z-10"><p class="text-[10px] font-bold text-[#FFDAD6] uppercase tracking-widest mb-1">Panitia</p><div class="flex items-baseline gap-2 mb-2"><h3 class="text-4xl font-google font-medium">${stats.avgPanitia}</h3><span class="text-xs text-[#FFDAD6] opacity-80">/ 5.0</span></div>${det&&det.panitia?renderBars(det.panitia):''}</div></div><div class="bg-[#7D5260] rounded-[24px] p-5 text-white shadow-lg relative overflow-hidden"><div class="relative z-10"><p class="text-[10px] font-bold text-[#FFDAD6] uppercase tracking-widest mb-1">Tuan Rumah</p><div class="flex items-baseline gap-2 mb-2"><h3 class="text-4xl font-google font-medium">${stats.avgTuanRumah}</h3><span class="text-xs text-[#FFDAD6] opacity-80">/ 5.0</span></div>${det&&det.tr?renderBars(det.tr):''}</div></div></div>`;
      html += `<div class="grid grid-cols-2 gap-4 mb-6"><div class="bg-[#FFF8F7] p-4 rounded-[24px] border border-[#F2DEDC] relative overflow-hidden"><div class="flex justify-between items-start relative z-10"><div><h4 class="text-[10px] font-bold text-[#B3261E] uppercase tracking-wide mb-1">Terkompak</h4>${schools.kompak&&schools.kompak.length>0?`<p class="text-sm font-bold text-[#201A1A] leading-tight line-clamp-2">${schools.kompak[0].nama}</p><div class="mt-2 inline-flex items-center gap-1 bg-[#FFDAD6] px-2 py-1 rounded-lg"><i class="fas fa-star text-[10px] text-[#410002]"></i><span class="text-[10px] font-bold text-[#410002]">${schools.kompak[0].skor_kompak} Poin</span></div>`:'<p class="text-xs text-[#857372] italic">Belum ada data</p>'}</div></div></div><div class="bg-[#FFF8F7] p-4 rounded-[24px] border border-[#F2DEDC] relative overflow-hidden"><div class="flex justify-between items-start relative z-10"><div><h4 class="text-[10px] font-bold text-[#B3261E] uppercase tracking-wide mb-1">Tergiat</h4>${schools.aktif&&schools.aktif.length>0?`<p class="text-sm font-bold text-[#201A1A] leading-tight line-clamp-2">${schools.aktif[0].nama}</p><div class="mt-2 inline-flex items-center gap-1 bg-[#FFDAD6] px-2 py-1 rounded-lg"><i class="fas fa-hand-paper text-[10px] text-[#410002]"></i><span class="text-[10px] font-bold text-[#410002]">${schools.aktif[0].skor_aktif} Aksi</span></div>`:'<p class="text-xs text-[#857372] italic">Belum ada data</p>'}</div></div></div></div>`;
      html += `<div class="flex flex-col gap-4 mb-6">${renderRankList('Top Narasumber', stats.ranking, 'fas fa-chalkboard-teacher', {bg:'bg-[#FFDAD6]', text:'text-[#B3261E]'})}<div class="grid grid-cols-1 md:grid-cols-2 gap-4">${renderRankList('Top Panitia (Lokasi)', stats.rankPanitia, 'fas fa-users-cog', {bg:'bg-[#FFDAD6]', text:'text-[#B3261E]'})}${renderRankList('Top Tuan Rumah', stats.rankTuanRumah, 'fas fa-school', {bg:'bg-[#FFDAD6]', text:'text-[#B3261E]'})}</div></div>`;
      html += `<div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div><h3 class="font-bold text-xs text-[#534341] uppercase mb-3 flex items-center gap-2"><i class="fas fa-history"></i> Log Keaktifan</h3><div class="space-y-2">${logs&&logs.length>0?logs.map(l=>`<div class="bg-white p-3 rounded-xl border border-[#F2DEDC] flex justify-between items-center shadow-sm"><div><p class="text-xs font-bold text-[#201A1A]">${l.nama}</p><p class="text-[10px] text-[#534341]">${l.sd}</p></div><span class="text-[10px] font-bold bg-[#FFDAD6] text-[#410002] px-2 py-1 rounded-md">${l.aksi}</span></div>`).join(''):'<p class="text-center text-xs text-[#857372] py-4 italic">Belum ada aktivitas.</p>'}</div></div><div><h3 class="font-bold text-xs text-[#534341] uppercase mb-3 flex items-center gap-2"><i class="fas fa-comment-alt"></i> Masukan Terbaru</h3><div class="space-y-2">${stats.comments&&stats.comments.length>0?stats.comments.map(c=>`<div class="bg-white p-3 rounded-xl border border-[#F2DEDC] shadow-sm text-xs text-[#534341] italic leading-relaxed">"${c.teks}"</div>`).join(''):'<div class="bg-[#FCEAE9] p-4 rounded-xl text-center text-xs text-[#857372] italic">Belum ada masukan.</div>'}</div></div></div>`;
      c.innerHTML = html;
    }

    function authModal(t){
        currentAuthType=t; 
        document.getElementById('auth-title').innerText=t=='panitia'?'Akses Panitia':'Akses Pengamat'; 
        document.getElementById('modal-auth').classList.remove('hidden');
        history.pushState({view: 'auth'}, '', '#auth'); // Support back button
        
        // UX: Auto focus keyboard
        setTimeout(() => {
            document.getElementById('auth-pass').focus();
        }, 300);
    }
    
    function closeAuth(){
        document.getElementById('modal-auth').classList.add('hidden');
        goBack();
    }
    
    async function submitAuth(){
        const p=document.getElementById('auth-pass').value; if(!p)return; 
        const res = await apiCall('verifyPassword', {pass:p, type:currentAuthType}, 'POST');
        if(res === true){ 
            document.getElementById('modal-auth').classList.add('hidden'); // Tutup modal dulu
            if(currentAuthType=='panitia'){
                document.getElementById('view-admin').classList.remove('hidden'); 
                history.replaceState({view: 'admin'}, '', '#admin'); // Ganti state auth jadi admin
                loadAdminData();
            }else{
                document.getElementById('view-pengamat').classList.remove('hidden');
                history.replaceState({view: 'pengamat'}, '', '#pengamat'); // Ganti state auth jadi pengamat
            }
        }
        else { showToast("Kode Salah"); document.getElementById('auth-pass').value=''; document.getElementById('auth-pass').focus();}
    }
    
    async function loadAdminData(){
        const filter = document.getElementById('filter-admin').value;
        const res = await apiCall('getRekapData', { action: 'getRekapData', filterLokasi: filter }, 'GET');
        renderAdmin(res);
    }
    function showToast(m,t){const c=document.getElementById('toast-container'); document.getElementById('toast-msg').querySelector('span').innerText=m; c.classList.add('toast-show'); setTimeout(()=>c.classList.remove('toast-show'),2500);}
  </script>
</body>
</html>
