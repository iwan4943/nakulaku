<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NAKULAKU</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&family=Google+Sans+Text:wght@400;500&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    :root {
      --md-primary: #B3261E;
      --md-on-primary: #FFFFFF;
      --md-primary-container: #FFDAD6;
      --md-on-primary-container: #410002;
      --md-surface: #FFF8F7;
      --md-surface-container-low: #FCEAE9;
      --md-surface-container: #FFFFFF;
      --md-on-surface: #201A1A;
      --md-on-surface-variant: #534341;
      --md-outline: #857372;
      --shape-card: 28px;
      --shape-pill: 50px;
    }
    body { font-family: 'Google Sans Text', sans-serif; background-color: var(--md-surface); color: var(--md-on-surface); padding-bottom: 80px; -webkit-font-smoothing: antialiased; }
    .hidden { display: none !important; }
    .text-nakula { color: var(--md-primary) !important; }
    .login-wrapper { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(180deg, var(--md-surface) 0%, var(--md-primary-container) 100%); }
    .card-std { background: var(--md-surface-container); border: none; border-radius: var(--shape-card); padding: 24px; margin-bottom: 20px; box-shadow: 0 1px 3px 0 rgba(0,0,0,0.05); transition: all 0.3s ease; }
    .login-box { width: 100%; max-width: 360px; padding: 20px; text-align: center; }
    .title-login { font-size: 2.2rem; font-weight: 700; color: var(--md-on-surface); margin-bottom: 8px; font-family: 'Google Sans'; }
    .input-pin { text-align: center; font-size: 1.8rem; font-weight: 700; letter-spacing: 8px; color: var(--md-primary); background: var(--md-surface-container); border: 2px solid transparent; border-bottom: 2px solid var(--md-outline); border-radius: 12px 12px 0 0; padding: 16px; width: 100%; outline: none; transition: 0.3s; }
    .input-pin:focus { border-bottom-color: var(--md-primary); background: #fff; }
    .btn-masuk { background-color: var(--md-primary); color: var(--md-on-primary); padding: 16px; border: none; border-radius: var(--shape-pill); font-weight: 500; width: 100%; margin-top: 24px; font-family: 'Google Sans'; transition: 0.3s; }
    .btn-masuk:hover { background-color: #901D16; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
    .grade-5 { background-color: #FFEFBF !important; color: #765600 !important; }
    .grade-4 { background-color: #D3E3FD !important; color: #041E49 !important; }
    .grade-3 { background-color: #C4EED0 !important; color: #074E23 !important; }
    .grade-2 { background-color: #FFD8E4 !important; color: #31111D !important; }
    .grade-1 { background-color: var(--md-surface-container) !important; color: var(--md-on-surface) !important; border: 1px solid #eee; }
    .grade-admin { background-color: #E8DEF8 !important; color: #1D192B !important; }
    .text-gradient { background: none; -webkit-text-fill-color: initial; color: var(--md-primary); }
    #card-header { padding: 20px; display: flex; align-items: center; }
    .badge-box-large { width: 64px; height: 64px; background: rgba(255,255,255,0.5); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; margin-right: 16px; }
    .role-badge { font-size: 0.7rem; padding: 4px 12px; border-radius: 12px; font-weight: 600; background: var(--md-primary-container); color: var(--md-on-primary-container); }
    .progress-track { background: #F0F0F0; height: 12px; border-radius: 50px; overflow: hidden; margin: 20px 0; width: 100%; }
    .progress-fill { height: 100%; border-radius: 50px; transition: width 1s ease; }
    .bar-gradient { background: var(--md-primary) !important; }
    .stat-box { text-align: center; padding: 20px 10px; border-radius: 20px; background: var(--md-surface-container-low); height: 100%; }
    .stat-num { font-size: 2rem; font-weight: 500; font-family: 'Google Sans'; margin-bottom: 4px; }
    .stat-label { font-size: 0.75rem; font-weight: 600; color: var(--md-on-surface-variant); }
    .rank-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f0f0f0; }
    .rank-pos { font-weight: 700; width: 32px; font-size: 0.9rem; color: var(--md-outline); }
    .rank-1 { color: #E6B906; } .rank-2 { color: #9EA6AA; } .rank-3 { color: #A86E3C; }
    .table-rekap thead th { background-color: var(--md-surface-container-low); color: var(--md-on-surface-variant); font-size: 0.75rem; border: none; padding: 12px; border-radius: 8px; }
    .table-rekap tbody td { padding: 12px; border-bottom: 1px solid #f5f5f5; color: var(--md-on-surface); }
    .search-box { background: var(--md-surface-container-low); border: 1px solid transparent; border-radius: 16px; padding: 12px 20px; width: 100%; outline: none; }
    .search-box:focus { background: #fff; border-color: var(--md-primary); }
    .score-badge { border-radius: 8px; font-weight: 600; font-size: 0.8rem; padding: 4px 10px; }
    .sb-high { background: #C4EED0; color: #074E23; } .sb-mid { background: #FFEFBF; color: #765600; } .sb-low { background: #FFDAD6; color: #410E0B; }
    .agenda-item { display: flex; align-items: flex-start; padding: 16px 0; border-bottom: 1px solid #f0f0f0; }
    .date-badge { background: var(--md-primary-container); color: var(--md-on-primary-container); padding: 8px 12px; border-radius: 16px; text-align: center; margin-right: 16px; min-width: 65px; font-weight: 700; }
    .date-badge span { display: block; font-size: 0.7rem; opacity: 0.8; text-transform: uppercase; }
    .agenda-title { font-weight: 600; font-size: 1rem; color: var(--md-on-surface); margin-bottom: 4px; font-family: 'Google Sans'; }
    .agenda-meta { font-size: 0.85rem; color: var(--md-on-surface-variant); }
    .form-control { background: var(--md-surface-container-low); border: 1px solid transparent; border-radius: 12px; padding: 12px; }
    .btn-danger { background: var(--md-primary); border: none; border-radius: var(--shape-pill); padding: 12px; color: white; }
    .btn-light { background: var(--md-surface-container-low); border: none; color: var(--md-primary); }
    #loader { background: var(--md-surface); position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
  </style>
</head>
<body>

  <div id="loader" class="hidden">
    <div class="spinner-border mb-3" style="width: 3rem; height: 3rem;" role="status"></div>
    <div class="fw-bold text-nakula" style="letter-spacing: 1px; font-family: 'Google Sans';">NAKULAKU</div>
  </div>

  <div id="view-login" class="login-wrapper">
    <div class="card-std login-box shadow-lg">
      <div class="mb-4"><i class="fas fa-shapes fa-3x" style="color:var(--md-primary);"></i></div>
      <h1 class="title-login">NAKULAKU</h1>
      <p class="text-muted mb-5 small">Portal Kinerja & Prestasi Gugus</p>
      
      <div class="text-start mb-2"><label class="small fw-bold ms-2 text-muted">MASUKKAN PIN</label></div>
      <input type="password" id="input-pin" class="input-pin" placeholder="• • • • •" inputmode="numeric">
      
      <div id="msg-login" class="text-danger small fw-bold mt-3"></div>
      
      <button onclick="doLoginManual()" class="btn-masuk">BUKA DASHBOARD <i class="fas fa-arrow-right ms-2"></i></button>
      <div class="mt-4 text-muted small opacity-50">&copy; 2025 Gugus Nakula</div>
    </div>
  </div>

  <div id="view-dashboard" class="hidden py-3">
    <div class="container" style="max-width: 800px;">
      
      <div id="card-header" class="card-std grade-1">
        <div class="d-flex align-items-center justify-content-between w-100">
          <div class="d-flex align-items-center">
            <div id="main-badge-box" class="badge-box-large shadow-sm"><i class="fas fa-user-circle text-muted"></i></div>
            <div class="ms-2">
              <h5 id="u-nama" class="fw-bold mb-1" style="color: inherit;">Nama User</h5>
              <div class="d-flex align-items-center gap-2">
                <span id="u-role" class="role-badge">GURU</span>
                <small id="u-unit" class="text-muted small fw-bold" style="color: inherit !important; opacity: 0.8;">Sekolah</small>
              </div>
            </div>
          </div>
          <button onclick="doLogout()" class="btn btn-light rounded-circle" style="width:48px; height:48px;" title="Keluar"><i class="fas fa-power-off"></i></button>
        </div>
      </div>

      <div id="panel-admin" class="hidden">
        <div class="row g-3 mb-3">
          <div class="col-4"><div class="stat-box"><div class="stat-num text-nakula" id="adm-total-sekolah">0</div><div class="stat-label">SEKOLAH</div></div></div>
          <div class="col-4"><div class="stat-box"><div class="stat-num text-success" id="adm-total-guru">0</div><div class="stat-label">GURU</div></div></div>
          <div class="col-4"><div class="stat-box"><div class="stat-num text-warning" id="adm-avg-gugus">0%</div><div class="stat-label">RATA-RATA</div></div></div>
        </div>
        
        <div class="card-std">
          <h6 class="fw-bold text-nakula mb-4"><i class="fas fa-chart-simple me-2"></i>KINERJA ANTAR SEKOLAH</h6>
          <div style="height: 220px;"><canvas id="chartAdmin"></canvas></div>
        </div>

        <div class="card-std">
          <h6 class="fw-bold text-nakula mb-3"><i class="fas fa-medal me-2"></i>RANKING PRESENSI</h6>
          <div id="list-ranking-presensi"></div>
        </div>
        
        <div class="card-std">
          <h6 class="fw-bold text-nakula mb-3"><i class="fas fa-clipboard-check me-2"></i>RANKING KINERJA TUGAS</h6>
          <div id="list-ranking-kinerja"></div>
        </div>

        <div class="card-std">
          <h6 class="fw-bold text-nakula mb-3"><i class="fas fa-users-viewfinder me-2"></i>REKAPITULASI DETAIL</h6>
          <div class="mb-3">
            <div class="position-relative">
                <i class="fas fa-search position-absolute text-muted" style="left: 15px; top: 15px;"></i>
                <input type="text" id="search-guru" class="search-box ps-5" placeholder="Cari nama guru / sekolah..." onkeyup="filterGuruTable()">
            </div>
          </div>
          <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
            <table class="table table-borderless table-rekap align-middle">
              <thead><tr><th>Guru / Sekolah</th><th class="text-center">Presensi</th><th class="text-center">Tugas</th><th class="text-center">Total</th></tr></thead>
              <tbody id="table-guru-body"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="panel-user" class="hidden">
        <div class="card-std">
          <div class="d-flex justify-content-between align-items-end mb-2">
            <div><div class="small fw-bold text-nakula mb-1" style="letter-spacing: 1px;" id="label-kinerja-main">TOTAL SKOR</div><div class="h6 text-muted mb-0">Prestasi Minggu Ini</div></div>
            <div id="text-score-big" class="display-3 fw-bold text-nakula" style="font-family: 'Google Sans'; line-height: 1;">0%</div>
          </div>
          <div class="progress-track"><div id="bar-score-main" class="progress-fill" style="width: 0%"></div></div>
          <div class="row text-center mt-4">
            <div class="col-6 border-end"><small class="text-muted fw-bold d-block mb-1" style="font-size:0.7rem;" id="label-sub-1">DISIPLIN</small><span class="h4 fw-bold" style="color:var(--md-on-surface);" id="val-sub-1">0%</span></div>
            <div class="col-6"><small class="text-muted fw-bold d-block mb-1" style="font-size:0.7rem;" id="label-sub-2">TUGAS</small><span class="h4 fw-bold" style="color:var(--md-on-surface);" id="val-sub-2">0%</span></div>
          </div>
        </div>

        <div id="area-ks-insight" class="card-std hidden">
          <h6 class="fw-bold text-nakula mb-4"><i class="fas fa-lightbulb me-2"></i>ANALISIS & REFLEKSI</h6>
          <div class="d-flex align-items-center gap-3">
            <div style="width: 90px; height: 90px; position:relative; flex-shrink:0;"><canvas id="chartKS"></canvas></div>
            <div id="text-refleksi" class="fst-italic small text-muted">Memuat data...</div>
          </div>
        </div>
      </div>

      <div class="row g-3" id="shared-content">
        <div class="col-lg-12">
          <div class="card-std">
            <h6 class="fw-bold text-nakula mb-3"><i class="far fa-calendar-alt me-2"></i>AGENDA KEGIATAN</h6>
            <div id="list-agenda"></div>
          </div>
        </div>
        <div class="col-lg-6 user-only">
          <div class="card-std h-100">
            <h6 class="fw-bold text-nakula mb-3"><i class="fas fa-history me-2"></i>RIWAYAT PRESENSI</h6>
            <div id="list-presensi"></div>
          </div>
        </div>
        <div class="col-lg-6 user-only">
          <div class="card-std h-100">
            <h6 class="fw-bold text-nakula mb-3" id="label-kanan-title">STATUS TUGAS</h6>
            <div id="list-content-kanan"></div>
          </div>
        </div>
      </div>
      
      <div id="card-ubah-pin" class="card-std mt-3 user-only">
        <h6 class="fw-bold text-nakula mb-4"><i class="fas fa-shield-alt me-2"></i>KEAMANAN AKUN</h6>
        <div class="row g-3 align-items-end">
          <div class="col-md-4"><label class="small text-muted fw-bold mb-2 ms-1">PIN Lama</label><input type="password" id="pin-old" class="form-control" placeholder="• • • • •" inputmode="numeric"></div>
          <div class="col-md-4"><label class="small text-muted fw-bold mb-2 ms-1">PIN Baru (Angka)</label><input type="password" id="pin-new" class="form-control" placeholder="• • • • •" inputmode="numeric"></div>
          <div class="col-md-4"><button onclick="doChangePin()" class="btn btn-danger w-100 fw-bold">SIMPAN BARU</button></div>
        </div>
        <div id="msg-pin" class="small mt-3 fw-bold text-center"></div>
      </div>
    </div>
  </div>

  <script>
    // ==========================================
    // GANTI URL DI BAWAH INI
    // ==========================================
    const ENDPOINT_URL = "https://script.google.com/macros/s/AKfycbyvsXS7TSjaz7RccMYhZAaVKhOR03YPrymCXOaqOqOlAgr9jFsa0iuqlPWDlKh-ZE1pGg/exec";
    
    let curUser = null;
    let mainChart = null; 
    let allGuruData = []; 
    const STORE_KEY = 'nakula_user_pin'; 

    document.addEventListener('DOMContentLoaded', () => {
      const savedPin = localStorage.getItem(STORE_KEY);
      if(savedPin) { document.getElementById('input-pin').value = savedPin; doLogin(savedPin); }
    });

    function doLoginManual() {
      const pin = document.getElementById('input-pin').value;
      if(!pin) { showMsg('PIN wajib diisi'); return; }
      doLogin(pin);
    }

    async function doLogin(pin) {
      loader(true); showMsg(''); 
      try {
        const response = await fetch(`${ENDPOINT_URL}?action=login&pin=${pin}`);
        const res = await response.json();
        if(res.status === 'success') {
          localStorage.setItem(STORE_KEY, pin);
          onLoginSuccess(res);
        } else {
          localStorage.removeItem(STORE_KEY); loader(false); showMsg(res.message);
        }
      } catch (error) { loader(false); showMsg("Koneksi gagal. Cek internet Anda."); }
    }

    function onLoginSuccess(res) {
      curUser = res.data;
      updateProfileUI(curUser);
      document.getElementById('view-login').classList.add('hidden');
      document.getElementById('view-dashboard').classList.remove('hidden');
      loadData();
    }

    async function loadData() {
      try {
        const params = new URLSearchParams({
          action: 'getDashboard', email: curUser.email, pin: curUser.pin,
          role: curUser.jabatan, school: curUser.sekolah, special: curUser.role_khusus
        });
        const response = await fetch(`${ENDPOINT_URL}?${params.toString()}`);
        const data = await response.json();
        renderDashboard(data);
      } catch (error) { loader(false); alert("Gagal memuat data dashboard."); }
    }

    async function doChangePin() {
      const pOld = document.getElementById('pin-old').value; const pNew = document.getElementById('pin-new').value; const msgEl = document.getElementById('msg-pin');
      if(!pOld || !pNew || isNaN(pNew)) { msgEl.className = 'small mt-2 fw-bold text-center text-danger'; msgEl.innerText = "Isi PIN dengan benar (Angka)."; return; }
      loader(true);
      try {
        const response = await fetch(`${ENDPOINT_URL}?action=changePin&email=${curUser.email}&oldPin=${pOld}&newPin=${pNew}`);
        const res = await response.json();
        loader(false);
        if(res.status === 'success') {
            document.getElementById('pin-old').value = ''; document.getElementById('pin-new').value = '';
            msgEl.className = 'small mt-2 fw-bold text-center text-success'; msgEl.innerText = res.message;
            localStorage.setItem(STORE_KEY, pNew); curUser.pin = pNew; 
        } else {
            msgEl.className = 'small mt-2 fw-bold text-center text-danger'; msgEl.innerText = res.message;
        }
      } catch (e) { loader(false); msgEl.innerText = "Error koneksi server."; }
    }

    function updateProfileUI(u) {
      document.getElementById('u-nama').innerText = u.nama;
      document.getElementById('u-unit').innerText = u.sekolah;
      let roleDisplay = 'GURU';
      if(u.jabatan.toLowerCase().includes('kepala')) roleDisplay = 'KEPALA SEKOLAH';
      if(u.role_khusus.includes('ADMIN') || u.jabatan.toLowerCase().includes('admin') || u.jabatan.toLowerCase().includes('pengawas')) roleDisplay = 'ADMINISTRATOR';
      document.getElementById('u-role').innerText = roleDisplay;
    }

    function renderDashboard(d) {
      loader(false);
      const panelAdmin = document.getElementById('panel-admin');
      const panelUser = document.getElementById('panel-user');
      const userOnlyCols = document.querySelectorAll('.user-only');
      const header = document.getElementById('card-header');
      const badgeBox = document.getElementById('main-badge-box');

      panelAdmin.classList.add('hidden'); panelUser.classList.add('hidden');

      if(d.role === 'ADMIN') {
        panelAdmin.classList.remove('hidden'); userOnlyCols.forEach(el => el.classList.add('hidden'));
        header.className = 'card-std bg-gradient-header grade-admin';
        badgeBox.innerHTML = '<i class="fas fa-user-shield" style="color:inherit"></i>';
        document.getElementById('adm-total-sekolah').innerText = d.stats.total_sekolah;
        document.getElementById('adm-total-guru').innerText = d.stats.total_guru;
        document.getElementById('adm-avg-gugus').innerText = d.stats.avg_gugus + '%';
        renderChartAdmin(d.sekolah_ranking);
        allGuruData = d.guru_detail;
        renderRankingTables(d.sekolah_ranking); renderGuruTable(allGuruData); 
      } else {
        panelUser.classList.remove('hidden'); userOnlyCols.forEach(el => el.classList.remove('hidden'));
        const score = d.kinerja.persen;
        let grade = 'grade-1', iconHTML = '<i class="fas fa-user-circle"></i>';
        if(score==100){ grade='grade-5'; iconHTML='<i class="fas fa-trophy"></i>'; }
        else if(score>=80){ grade='grade-4'; iconHTML='<i class="fas fa-medal"></i>'; }
        else if(score>=60){ grade='grade-3'; iconHTML='<i class="fas fa-star"></i>'; }
        else if(score>=40){ grade='grade-2'; iconHTML='<i class="fas fa-bullseye"></i>'; }
        header.className = `card-std bg-gradient-header ${grade}`; badgeBox.innerHTML = iconHTML;
        
        const txtBig = document.getElementById('text-score-big'); const barMain = document.getElementById('bar-score-main');
        txtBig.className = grade !== 'grade-1' ? `display-3 fw-bold text-gradient ${grade}` : `display-3 fw-bold text-nakula`;
        txtBig.innerText = score + '%';
        barMain.className = grade !== 'grade-1' ? `progress-fill bar-gradient ${grade}` : `progress-fill`;
        if(grade === 'grade-1') barMain.style.background = '#B3261E';
        setTimeout(()=> { barMain.style.width = score + '%'; }, 100);

        const ksArea = document.getElementById('area-ks-insight'); const listKanan = document.getElementById('list-content-kanan');
        if(d.role === 'KS') {
          document.getElementById('label-kinerja-main').innerText = "KINERJA SEKOLAH"; ksArea.classList.remove('hidden');
          document.getElementById('label-sub-1').innerText = "DISIPLIN KS"; document.getElementById('val-sub-1').innerText = d.kinerja.score_ks + '%';
          document.getElementById('label-sub-2').innerText = "RATA-RATA GURU"; document.getElementById('val-sub-2').innerText = d.kinerja.avg_guru + '%';
          document.getElementById('text-refleksi').innerHTML = d.kinerja.persen >= 80 ? '<strong>"Kinerja Sekolah Prima."</strong>' : '<strong>"Perlu Pembinaan Guru."</strong>';
          renderChartKS(score);
          document.getElementById('label-kanan-title').innerHTML = '<i class="fas fa-trophy me-2"></i>PERFORMA GURU';
          renderListGuruKS(d.guru_list, listKanan);
        } else {
          document.getElementById('label-kinerja-main').innerText = "KINERJA INDIVIDU"; ksArea.classList.add('hidden');
          document.getElementById('label-sub-1').innerText = "PRESENSI SAYA"; document.getElementById('val-sub-1').innerText = d.kinerja.detail_presensi + '%';
          document.getElementById('label-sub-2').innerText = "TUGAS SAYA"; document.getElementById('val-sub-2').innerText = d.kinerja.detail_tugas + '%';
          document.getElementById('label-kanan-title').innerHTML = '<i class="fas fa-tasks me-2"></i>STATUS TUGAS';
          renderListTugas(d.tugas, listKanan);
        }
        renderListPresensi(d.presensi);
      }
      renderAgenda(d.agenda);
    }

    function renderListPresensi(list) {
      const el = document.getElementById('list-presensi'); el.innerHTML = '';
      if(!list || list.length === 0) { el.innerHTML = '<div class="text-center small text-muted py-3">Belum ada presensi</div>'; return; }
      list.forEach(p => {
        let c = p.status.includes('Tepat') ? 'text-success' : 'text-danger';
        el.innerHTML += `<div class="py-2 border-bottom d-flex justify-content-between"><span class="small fw-bold">${p.waktu}</span><span class="small fw-bold ${c}">${p.status.split(' ')[0]}</span></div>`;
      });
    }

    function renderListTugas(list, container) {
      container.innerHTML = '';
      if(!list || list.length === 0) { container.innerHTML = '<div class="text-center small text-muted py-3">Tidak ada tugas</div>'; return; }
      list.forEach(t => {
        let b = t.status.includes('Diterima') ? 'sb-high' : 'sb-mid';
        container.innerHTML += `<div class="py-2 border-bottom"><div class="d-flex justify-content-between"><span class="small fw-bold">${t.judul}</span><span class="score-badge ${b}">${t.status}</span></div></div>`;
      });
    }

    function renderListGuruKS(list, container) {
      container.innerHTML = '';
      if(!list || list.length === 0) { container.innerHTML = '<div class="text-center small text-muted py-3">Tidak ada data</div>'; return; }
      list.forEach((g,i) => {
         let c = g.score >= 80 ? 'bg-success' : 'bg-warning';
         container.innerHTML += `<div class="rank-row" style="padding:8px 0;"><div class="rank-pos">#${i+1}</div><div class="flex-grow-1"><div class="d-flex justify-content-between mb-1"><span class="small fw-bold text-dark">${g.nama}</span><span class="small fw-bold text-muted">${g.score}%</span></div><div class="progress" style="height:5px"><div class="progress-bar ${c}" style="width:${g.score}%"></div></div></div></div>`;
      });
    }

    function renderAgenda(list) {
      const el = document.getElementById('list-agenda'); el.innerHTML = '';
      if(!list || list.length === 0) { el.innerHTML = '<div class="text-center text-muted small py-3">Belum ada agenda</div>'; return; }
      list.forEach(a => {
        let t = a.tanggal.split(' ');
        el.innerHTML += `<div class="agenda-item"><div class="date-badge">${t[0]} <span>${t[1]||''}</span></div><div class="flex-grow-1"><div class="agenda-title">${a.kegiatan}</div><div class="agenda-meta"><i class="far fa-clock me-1"></i>${a.waktu} • ${a.narsum||'-'}</div></div></div>`;
      });
    }
    
    function renderRankingTables(data) {
       const el = document.getElementById('list-ranking-presensi');
       const elK = document.getElementById('list-ranking-kinerja');
       if(!data) return;
       let rankP = [...data].sort((a,b)=>b.rata_rata_presensi - a.rata_rata_presensi);
       let rankT = [...data].sort((a,b)=>b.rata_rata_tugas - a.rata_rata_tugas);
       el.innerHTML = generateRankHTML(rankP, 'rata_rata_presensi');
       elK.innerHTML = generateRankHTML(rankT, 'rata_rata_tugas');
    }
    
    function generateRankHTML(arr, key) {
       let html = '';
       arr.forEach((s, i) => {
          let score = s[key]; let c = score>=80?'bg-success':(score>=60?'bg-primary':'bg-warning');
          let rankClass = (i+1)<=3 ? `rank-${i+1}` : '';
          html += `<div class="rank-row"><div class="rank-pos ${rankClass}">#${i+1}</div><div class="flex-grow-1"><div class="d-flex justify-content-between mb-1"><span class="small fw-bold text-dark">${s.nama}</span><span class="small fw-bold text-muted">${score}%</span></div><div class="progress" style="height:8px; border-radius:10px;"><div class="progress-bar ${c}" style="width:${score}%"></div></div></div></div>`;
       });
       return html;
    }

    function renderGuruTable(data) {
      const tbody = document.getElementById('table-guru-body'); tbody.innerHTML = '';
      if(!data || data.length === 0) { tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted small">Tidak ada data</td></tr>'; return; }
      data.forEach(g => {
        let b = g.total >= 80 ? 'sb-high' : (g.total >= 60 ? 'sb-mid' : 'sb-low');
        tbody.innerHTML += `<tr><td><div class="fw-bold small" style="color:var(--md-on-surface);">${g.nama}</div><div class="text-muted" style="font-size:0.75rem">${g.sekolah}</div></td><td class="text-center"><span class="text-muted small">${g.presensi}%</span></td><td class="text-center"><span class="text-muted small">${g.tugas}%</span></td><td class="text-center"><span class="score-badge ${b}">${g.total}%</span></td></tr>`;
      });
    }

    function filterGuruTable() {
      const term = document.getElementById('search-guru').value.toLowerCase();
      const filtered = allGuruData.filter(g => g.nama.toLowerCase().includes(term) || g.sekolah.toLowerCase().includes(term));
      renderGuruTable(filtered);
    }

    function renderChartAdmin(data) {
       const ctx = document.getElementById('chartAdmin').getContext('2d');
       if(mainChart) mainChart.destroy();
       mainChart = new Chart(ctx, { type: 'bar', data: { labels: data.map(d=>d.nama), datasets: [{ label: 'Skor', data: data.map(d=>d.rata_rata), backgroundColor: '#B3261E', borderRadius: 8 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, max: 100, grid: {display:false} }, x: { grid: {display:false} } } } });
    }

    function renderChartKS(score) {
       const ctx = document.getElementById('chartKS').getContext('2d');
       if(mainChart) mainChart.destroy();
       let c = score>=80?'#C4EED0':(score>=60?'#FFEFBF':'#FFDAD6'); let cOn = score>=80?'#074E23':(score>=60?'#765600':'#410E0B');
       mainChart = new Chart(ctx, { type: 'doughnut', data: { labels: ['Capaian', 'Gap'], datasets: [{ data: [score, 100-score], backgroundColor: [cOn, c], borderWidth: 0 }] }, options: { cutout: '75%', plugins: { legend: { display: false } }, maintainAspectRatio: false } });
    }

    function doLogout() {
      localStorage.removeItem(STORE_KEY); curUser = null;
      if(mainChart) { mainChart.destroy(); mainChart = null; }
      document.getElementById('input-pin').value = '';
      document.getElementById('view-dashboard').classList.add('hidden');
      document.getElementById('view-login').classList.remove('hidden');
      document.getElementById('card-header').className = 'card-std grade-1';
    }

    function loader(x) { document.getElementById('loader').className = x ? '' : 'hidden'; }
    function showMsg(m) { document.getElementById('msg-login').innerText = m; }
  </script>
</body>
</html>
