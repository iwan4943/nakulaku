<!DOCTYPE html>
<html lang="id" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#F6F5F4" id="theme-color-meta">
    <title>NAKULAKU EKOSISTEM</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/iwan4943/nakulaku/refs/heads/main/nakula.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class', 
            theme: { 
                extend: { 
                    colors: { 
                        nakula: { 50: '#fff1f2', 100: '#ffe4e6', 200: '#fecdd3', 500: '#f43f5e', 600: '#B3261E', 700: '#9f1239', 800: '#881337', 900: '#4c0519' },
                        gnomebg: '#F6F5F4', gnomecard: '#FFFFFF', 
                        darkbg: '#1E1E1E', darkcard: '#303030', darkborder: '#454545'
                    }, 
                    fontFamily: { sans: ['Plus Jakarta Sans', 'sans-serif'] },
                    boxShadow: { 
                        'gnome': '0 2px 8px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.02)', 
                        'glass': '0 8px 32px 0 rgba(31, 38, 135, 0.15)',
                        'dark-soft': '0 4px 12px rgba(0, 0, 0, 0.2)' 
                    },
                    animation: { 'fade-in': 'fadeIn 0.6s ease-out forwards', 'pulse-slow': 'pulse 3s infinite' },
                    keyframes: { fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } } }
                } 
            }
        }
    </script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        body { -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        @media (min-width: 1024px) { ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.1); border-radius: 10px; } .dark ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); } }
        .bento-card { transition: transform 0.2s cubic-bezier(0.25, 0.1, 0.25, 1), background-color 0.2s; border: 1px solid rgba(0,0,0,0.05); }
        .dark .bento-card { border: 1px solid #454545; background-color: #303030; }
        .bento-card:active { transform: scale(0.98); }
        .icon-watermark { position: absolute; right: -20px; bottom: -20px; opacity: 0.03; transform: rotate(-15deg); transition: transform 0.3s; }
        .bento-card:hover .icon-watermark { transform: rotate(0deg) scale(1.2); opacity: 0.06; }
        .modal-content { transition: all 0.3s cubic-bezier(0.19, 1, 0.22, 1); }
        .school-slide { position: absolute; inset: 0; display: flex; align-items: center; gap: 1rem; padding: 1rem; opacity: 0; transform: translateY(20px) scale(0.95); transition: all 1.5s cubic-bezier(0.2, 0.8, 0.2, 1); pointer-events: none; }
        .school-slide.active { opacity: 1; transform: translateY(0) scale(1); pointer-events: auto; }
        .school-slide.exit { opacity: 0; transform: translateY(-20px) scale(1.05); }
        .loader-ring { display: inline-block; position: relative; width: 80px; height: 80px; }
        .loader-ring div { box-sizing: border-box; display: block; position: absolute; width: 64px; height: 64px; margin: 8px; border: 4px solid #B3261E; border-radius: 50%; animation: loader-ring 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite; border-color: #B3261E transparent transparent transparent; }
        .dark .loader-ring div { border-color: #fff transparent transparent transparent; }
        .loader-ring div:nth-child(1) { animation-delay: -0.45s; } .loader-ring div:nth-child(2) { animation-delay: -0.3s; } .loader-ring div:nth-child(3) { animation-delay: -0.15s; }
        @keyframes loader-ring { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #exit-toast { visibility: hidden; min-width: 220px; background-color: #303030; color: #fff; text-align: center; border-radius: 50px; padding: 10px 24px; position: fixed; z-index: 100; left: 50%; bottom: 30px; transform: translateX(-50%); font-size: 13px; font-weight: 600; opacity: 0; transition: all 0.2s; pointer-events: none; box-shadow: 0 4px 12px rgba(0,0,0,0.3); border: 1px solid #454545; }
        #exit-toast.show { visibility: visible; opacity: 1; bottom: 50px; }
        .timeline-item { position: relative; padding-left: 2rem; border-left: 2px solid #e5e7eb; padding-bottom: 2rem; }
        .dark .timeline-item { border-left-color: #454545; }
        .timeline-item:last-child { border-left: transparent; padding-bottom: 0; }
        .timeline-dot { position: absolute; -left: 5px; top: 0; width: 12px; height: 12px; border-radius: 50%; background: #e5e7eb; border: 2px solid #fff; }
        .dark .timeline-dot { background: #454545; border-color: #303030; }
    </style>
</head>
<body class="bg-gnomebg text-stone-800 dark:bg-darkbg dark:text-stone-200 h-screen flex flex-col relative transition-colors duration-300">

    <div class="fixed top-0 inset-x-0 h-48 bg-stone-200/30 dark:hidden pointer-events-none"></div>

    <main class="flex-1 flex flex-col h-full relative z-10 w-full md:flex-row md:overflow-hidden">
        
        <aside class="hidden md:flex w-20 lg:w-72 flex-col border-r border-stone-200 dark:border-darkborder bg-white/80 dark:bg-darkcard/80 backdrop-blur-md h-full p-6 gap-6 z-20 shrink-0">
            <div id="desktop-profile-container" class="bg-gradient-to-br from-slate-100 to-zinc-200 dark:from-slate-800 dark:to-zinc-800 rounded-[2rem] p-6 text-center shadow-gnome dark:shadow-dark-soft border border-white/20 dark:border-white/5 relative overflow-hidden group">
                <div class="absolute inset-0 bg-white/20 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                <div id="desk-view-guest">
                    <div class="w-16 h-16 mx-auto bg-stone-200 dark:bg-stone-700 rounded-full flex items-center justify-center mb-3"><i data-lucide="user" class="w-8 h-8 text-stone-400"></i></div>
                    <h3 class="font-bold text-lg text-stone-800 dark:text-white">Tamu</h3>
                    <button onclick="app.openModal('profile-modal')" class="relative z-10 mt-3 w-full py-2 bg-stone-900 text-white rounded-xl text-xs font-bold shadow-md hover:scale-105 transition cursor-pointer">Masuk Akun</button>
                </div>
                <div id="desk-view-user" class="hidden">
                    <img id="desk-user-photo" src="" class="w-20 h-20 mx-auto rounded-full object-cover border-4 border-white dark:border-stone-700 shadow-md mb-3">
                    <h3 id="desk-user-name" class="font-bold text-base text-stone-800 dark:text-white leading-tight mb-1">Nama User</h3>
                    <p id="desk-user-role" class="text-xs font-bold uppercase tracking-wider text-white/80 bg-black/20 dark:bg-white/20 inline-block px-3 py-1 rounded-full">Jabatan</p>
                    <button onclick="app.openModal('profile-modal')" class="relative z-10 mt-4 w-full py-2 bg-white/90 dark:bg-black/20 text-stone-800 dark:text-white rounded-xl text-xs font-bold border border-transparent hover:bg-white transition shadow-sm cursor-pointer">Edit Profil</button>
                </div>
            </div>
            <nav class="flex-1 space-y-2 overflow-y-auto pr-1 custom-scroll">
                <div class="mb-2"><p class="text-[10px] font-bold text-stone-400 uppercase tracking-widest px-2 mb-2">Menu Utama</p></div>
                <div id="desktop-sidebar-menu" class="space-y-2"></div>
                <div class="pt-4 mt-4 border-t border-stone-200 dark:border-stone-700">
                    <p class="text-[10px] font-bold text-stone-400 uppercase tracking-widest px-2 mb-2">Pengaturan</p>
                    <button onclick="app.refreshData(true)" class="w-full p-3 rounded-xl hover:bg-stone-100 dark:hover:bg-stone-800 text-stone-600 dark:text-stone-300 transition flex items-center gap-3 font-medium text-sm cursor-pointer"><i data-lucide="refresh-cw" class="w-4 h-4"></i> Sinkronisasi</button>
                    <button onclick="app.openModal('feedback-modal')" class="w-full p-3 rounded-xl hover:bg-stone-50 dark:hover:bg-stone-800/50 text-stone-500 flex items-center gap-3 text-sm cursor-pointer"><i data-lucide="life-buoy" class="w-4 h-4"></i> Bantuan</button>
                    <button onclick="app.confirmLogout()" class="w-full p-3 rounded-xl hover:bg-red-50 dark:hover:bg-red-900/20 text-red-500 flex items-center gap-3 text-sm font-bold mt-1 cursor-pointer"><i data-lucide="log-out" class="w-4 h-4"></i> Keluar</button>
                </div>
            </nav>
        </aside>

        <div class="flex-1 flex flex-col h-full overflow-hidden relative">
            
            <header class="md:hidden px-6 pt-8 pb-2 flex justify-between items-center bg-transparent z-20">
                <div class="flex flex-col">
                    <h1 class="text-2xl font-extrabold text-stone-800 dark:text-white leading-none tracking-tight">NAKULAKU <span class="text-nakula-600">EKOSISTEM</span></h1>
                    <p class="text-[11px] font-bold text-stone-400 dark:text-stone-500 mt-1 uppercase tracking-[0.15em]">Solid Bersinergi Menginspirasi</p>
                </div>
                <div class="flex gap-3 items-center">
                    <img src="https://raw.githubusercontent.com/iwan4943/nakulaku/refs/heads/main/nakula.png" class="w-10 h-10 rounded-xl shadow-gnome bg-white dark:bg-darkcard p-1 object-contain border border-stone-100 dark:border-darkborder">
                </div>
            </header>

            <header class="hidden md:flex px-8 pt-8 pb-4 justify-between items-center bg-transparent z-20">
                <div class="flex items-center gap-4">
                    <img src="https://raw.githubusercontent.com/iwan4943/nakulaku/refs/heads/main/nakula.png" class="w-12 h-12 rounded-xl shadow-gnome bg-white dark:bg-darkcard p-1 border border-stone-100 dark:border-stone-700">
                    <div>
                        <h1 class="text-2xl font-black text-stone-800 dark:text-white tracking-tight">NAKULAKU EKOSISTEM</h1>
                        <p class="text-xs font-bold text-stone-400 uppercase tracking-widest">Solid Bersinergi Menginspirasi</p>
                    </div>
                </div>
                <div class="flex items-center gap-6 bg-white/50 dark:bg-darkcard/50 backdrop-blur-sm px-6 py-2 rounded-2xl border border-stone-100 dark:border-stone-800">
                    <div class="text-right">
                        <div id="desktop-clock" class="text-2xl font-black text-nakula-600 tracking-tight">00:00</div>
                        <div id="desktop-date" class="text-[10px] font-bold text-stone-400 uppercase tracking-wider">...</div>
                    </div>
                    <div class="h-8 w-px bg-stone-200 dark:bg-stone-700"></div>
                    <button onclick="app.toggleTheme()" class="p-2 rounded-lg hover:bg-stone-100 dark:hover:bg-darkcard text-stone-400 transition cursor-pointer"><i data-lucide="moon" class="w-5 h-5 block dark:hidden"></i><i data-lucide="sun" class="w-5 h-5 hidden dark:block"></i></button>
                </div>
            </header>

            <div id="main-scroll" class="flex-1 overflow-y-auto px-6 pb-32 md:pb-10 md:px-8 scroll-smooth w-full">
                
                <div class="grid grid-cols-12 gap-4 mb-6 mt-4 fade-in">
                    <div class="col-span-12 md:col-span-8 bg-gradient-to-br from-nakula-600 to-nakula-800 text-white dark:from-nakula-700 dark:to-nakula-900 rounded-[2rem] relative overflow-hidden shadow-gnome flex items-center min-h-[100px] lg:min-h-[160px] group">
                        <div class="absolute -right-10 -top-10 w-40 h-40 bg-white/10 rounded-full blur-3xl animate-pulse-slow"></div>
                        <div class="absolute -left-10 -bottom-10 w-32 h-32 bg-black/10 rounded-full blur-2xl"></div>
                        <div id="school-slides-container" class="relative w-full h-full min-h-[100px] lg:min-h-[160px]"></div>
                    </div>

                    <div class="col-span-12 md:col-span-4 flex flex-col h-full">
                        
                        <div id="widget-akun-mobile" class="md:hidden bg-gnomecard dark:bg-darkcard border border-stone-100 dark:border-darkborder rounded-[2rem] p-5 flex flex-col justify-center relative overflow-hidden shadow-gnome dark:shadow-dark-soft min-h-[90px]">
                            <div class="absolute right-0 top-0 bottom-0 w-1/3 bg-gradient-to-l from-white/20 to-transparent pointer-events-none"></div>
                            <div id="mob-view-guest" class="relative z-10 w-full flex flex-row justify-between items-center h-full">
                                <div><p class="text-[9px] font-bold text-stone-400 uppercase tracking-wide mb-0.5">Selamat Datang</p><h3 class="font-extrabold text-stone-800 dark:text-white text-lg">Tamu</h3></div>
                                <button class="bg-stone-900 text-white dark:bg-white dark:text-darkbg px-5 py-2 rounded-xl text-xs font-bold shadow-sm relative z-20 cursor-pointer" onclick="app.openModal('profile-modal')">Masuk</button>
                            </div>
                            <div id="mob-view-user" class="relative z-10 w-full flex flex-row items-center gap-5 hidden h-full cursor-pointer relative z-20" onclick="app.openModal('profile-modal')">
                                <div class="relative shrink-0"><img id="mob-user-photo" src="" class="w-14 h-14 rounded-full border-2 border-white/40 object-cover shadow-sm bg-white/50"></div>
                                <div class="flex-1 min-w-0"><h3 id="mob-user-name" class="font-extrabold text-lg leading-tight truncate text-stone-800 dark:text-stone-100">User</h3><p id="mob-user-role" class="text-[11px] font-medium text-stone-600 dark:text-stone-400 mt-0.5 truncate">Guru • Instansi</p></div>
                            </div>
                        </div>

                        <div class="hidden md:flex bg-sky-50 dark:bg-sky-900/20 border border-sky-100 dark:border-sky-800 rounded-[2rem] p-6 h-full flex-col justify-center items-center shadow-gnome relative overflow-hidden min-h-[100px] text-center">
                            <i data-lucide="quote" class="w-6 h-6 text-sky-300 mb-2 opacity-50"></i>
                            <p id="quote-text" class="text-sm font-bold text-sky-800 dark:text-sky-100 leading-relaxed italic">"..."</p>
                            <p id="quote-author" class="text-xs text-sky-500 mt-1 font-medium">-</p>
                        </div>
                    </div>
                </div>

                <div id="widget-performa" class="hidden animate-fade-in mb-6">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-emerald-50 dark:bg-emerald-900/20 border border-emerald-100 dark:border-emerald-800 rounded-[2rem] p-5 shadow-gnome dark:shadow-dark-soft">
                            <div class="flex items-center gap-2 mb-3"><div id="icon-presensi-bg" class="w-8 h-8 rounded-full bg-white dark:bg-darkbg text-emerald-600 flex items-center justify-center shadow-sm"><i data-lucide="calendar-check" class="w-4 h-4"></i></div><span class="text-[10px] font-bold uppercase text-emerald-700 dark:text-emerald-400">Kehadiran</span></div>
                            <h3 id="score-presensi" class="text-2xl lg:text-3xl font-black text-stone-800 dark:text-white mb-2">0%</h3>
                            <div class="h-1.5 w-full bg-emerald-200 dark:bg-emerald-800 rounded-full overflow-hidden mb-2"><div id="bar-presensi" class="h-full bg-emerald-500 w-0 rounded-full transition-all duration-1000"></div></div>
                            <p id="desc-presensi" class="text-[10px] font-bold text-emerald-600 dark:text-emerald-300 truncate tracking-tight">Memuat...</p>
                        </div>
                        <div class="bg-sky-50 dark:bg-sky-900/20 border border-sky-100 dark:border-sky-800 rounded-[2rem] p-5 shadow-gnome dark:shadow-dark-soft">
                            <div class="flex items-center gap-2 mb-3"><div id="icon-tugas-bg" class="w-8 h-8 rounded-full bg-white dark:bg-darkbg text-sky-600 flex items-center justify-center shadow-sm"><i data-lucide="clipboard-list" class="w-4 h-4"></i></div><span class="text-[10px] font-bold uppercase text-sky-700 dark:text-sky-400">Tugas</span></div>
                            <h3 id="score-tugas" class="text-2xl lg:text-3xl font-black text-stone-800 dark:text-white mb-2">0%</h3>
                            <div class="h-1.5 w-full bg-sky-200 dark:bg-sky-800 rounded-full overflow-hidden mb-2"><div id="bar-tugas" class="h-full bg-sky-500 w-0 rounded-full transition-all duration-1000"></div></div>
                            <p id="desc-tugas" class="text-[10px] font-bold text-sky-600 dark:text-sky-300 truncate tracking-tight">Memuat...</p>
                        </div>
                    </div>
                </div>
                
                <div id="announcement-area" class="col-span-12 hidden"></div>

                <div class="md:hidden">
                    <div class="flex items-center justify-between px-2 mb-4">
                        <h3 class="font-bold text-stone-800 dark:text-stone-200 text-sm flex items-center gap-2"><i data-lucide="grid" class="w-4 h-4 text-nakula-600"></i> Layanan Digital</h3>
                        <button onclick="app.toggleTheme()" class="w-9 h-9 rounded-full bg-white dark:bg-darkcard flex items-center justify-center text-stone-400 border border-stone-100 dark:border-darkborder cursor-pointer relative z-20"><i data-lucide="moon" class="w-4 h-4 block dark:hidden"></i><i data-lucide="sun" class="w-4 h-4 hidden dark:block"></i></button>
                    </div>
                    <div id="mobile-menu-container" class="grid grid-cols-2 gap-4 pb-10">
                        <div class="col-span-2 h-32 bg-stone-200 dark:bg-darkcard rounded-[2rem] animate-pulse"></div>
                    </div>
                </div>

                <div class="hidden md:block pb-10">
                    <div class="flex items-center justify-between px-2 mb-4">
                        <h3 class="font-bold text-xl text-stone-800 dark:text-white flex items-center gap-2">
                            <i data-lucide="calendar-days" class="text-nakula-600"></i> Agenda Kegiatan Tahun Ini
                        </h3>
                    </div>
                    <div class="bg-white/50 dark:bg-darkcard/30 backdrop-blur-sm rounded-[2.5rem] p-8 border border-stone-100 dark:border-stone-800 max-h-[600px] overflow-y-auto custom-scroll">
                        <div id="desktop-agenda-list" class="space-y-0">
                            <div class="animate-pulse space-y-4"><div class="h-10 bg-stone-200 rounded-lg"></div></div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <div id="dock-container" class="md:hidden fixed bottom-6 left-1/2 -translate-x-1/2 z-40 bg-stone-900 dark:bg-darkcard text-white dark:text-stone-200 p-1.5 rounded-[1.8rem] shadow-gnome dark:shadow-dark-soft border border-stone-700/50 dark:border-darkborder flex items-center gap-1 transition-all hidden"></div>
    </main>

    <div id="loading-overlay" class="fixed inset-0 z-[100] bg-white/80 dark:bg-black/80 backdrop-blur-md hidden flex-col items-center justify-center text-center"><div class="loader-ring"><div></div><div></div><div></div><div></div></div><img src="https://raw.githubusercontent.com/iwan4943/nakulaku/refs/heads/main/nakula.png" class="w-12 h-12 rounded-xl shadow-lg mb-4 animate-pulse"><p class="text-sm font-bold text-stone-800 dark:text-white tracking-widest uppercase">Menyegarkan Data...</p></div>
    <div id="dialog-modal" class="fixed inset-0 z-[90] hidden flex items-center justify-center p-6"><div class="absolute inset-0 bg-stone-900/30 dark:bg-black/60 backdrop-blur-sm transition-opacity opacity-0 modal-overlay" onclick="app.closeModal('dialog-modal')"></div><div class="bg-white/90 dark:bg-darkcard/90 backdrop-blur-xl w-full max-w-xs rounded-[2.5rem] p-8 text-center transform scale-75 opacity-0 modal-content shadow-glass border border-white/20 dark:border-white/5 transition-all duration-300"><div id="dialog-icon-container" class="mb-5 mx-auto w-20 h-20 rounded-full flex items-center justify-center shadow-lg relative"><div class="absolute inset-0 rounded-full bg-current opacity-20 animate-ping"></div><div id="dialog-icon" class="relative z-10 w-full h-full flex items-center justify-center rounded-full bg-white dark:bg-darkbg text-2xl"></div></div><h3 id="dialog-title" class="font-black text-2xl mb-2 text-stone-800 dark:text-white tracking-tight">Info</h3><p id="dialog-msg" class="text-sm text-stone-500 dark:text-stone-400 mb-8 leading-relaxed font-medium">Pesan...</p><div id="dialog-actions"></div></div></div>
    
    <div id="profile-modal" class="fixed inset-0 z-50 hidden flex items-end md:items-center justify-center p-0 md:p-4"><div class="absolute inset-0 bg-stone-900/20 dark:bg-black/50 transition-opacity opacity-0 modal-overlay" onclick="app.closeModal('profile-modal')"></div><div class="bg-white dark:bg-darkcard w-full md:max-w-sm rounded-t-[2.5rem] md:rounded-[2.5rem] p-8 shadow-2xl transform translate-y-full md:translate-y-0 scale-95 opacity-0 modal-content transition-all z-10 border-t dark:border-darkborder md:border-none"><div class="w-12 h-1.5 bg-stone-200 dark:bg-darkbg rounded-full mx-auto mb-8 md:hidden"></div><div class="flex items-center gap-5 mb-8"><div class="relative group"><img id="modal-photo" src="https://raw.githubusercontent.com/iwan4943/nakulaku/refs/heads/main/nakula.png" class="w-20 h-20 rounded-full object-cover bg-stone-50 dark:bg-darkbg border-4 border-white dark:border-darkborder shadow-lg"><label class="absolute bottom-0 right-0 bg-stone-900 text-white p-1.5 rounded-full cursor-pointer hover:bg-nakula-600 transition shadow-md"><i data-lucide="camera" class="w-3.5 h-3.5"></i><input type="file" id="upload-photo" hidden accept="image/*" onchange="app.handlePhotoUpload(this)"></label></div><div><h3 class="text-xl font-bold text-stone-800 dark:text-white leading-tight">Profil<br>Pengguna</h3><p id="modal-status" class="text-xs font-bold text-stone-400 mt-1 uppercase tracking-wider">Belum Terhubung</p></div></div><div class="space-y-4 mb-8"><div class="bg-stone-50 dark:bg-darkbg px-5 py-3.5 rounded-2xl border border-stone-100 dark:border-darkborder focus-within:border-nakula-500 transition-colors"><label class="text-[10px] font-bold text-stone-400 uppercase block mb-1">Email</label><input type="email" id="sync-email" class="w-full bg-transparent text-sm font-bold text-stone-800 dark:text-white outline-none placeholder:text-stone-300"></div><div class="bg-stone-50 dark:bg-darkbg px-5 py-3.5 rounded-2xl border border-stone-100 dark:border-darkborder focus-within:border-nakula-500 transition-colors"><label class="text-[10px] font-bold text-stone-400 uppercase block mb-1">PIN Akses</label><input type="text" id="sync-pin" class="w-full bg-transparent text-sm font-bold text-stone-800 dark:text-white outline-none placeholder:text-stone-300"></div></div><button onclick="app.syncData()" id="btn-sync" class="w-full bg-nakula-600 text-white font-bold py-4 rounded-2xl shadow-lg active:scale-95 transition cursor-pointer">Sinkronisasi Data</button><button type="button" onclick="app.confirmLogout()" class="w-full py-4 text-xs font-bold text-red-500 mt-2 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-xl transition cursor-pointer">Keluar / Reset Akun</button></div></div>
    <div id="submenu-modal" class="fixed inset-0 z-50 hidden flex items-end md:items-center justify-center p-0 md:p-4"><div class="absolute inset-0 bg-stone-900/20 dark:bg-black/50 backdrop-blur-sm modal-overlay opacity-0" onclick="app.closeModal('submenu-modal')"></div><div class="bg-white dark:bg-darkcard w-full md:max-w-md rounded-t-[2.5rem] md:rounded-[2.5rem] p-0 shadow-2xl transform translate-y-full md:translate-y-0 scale-95 opacity-0 modal-content transition-all z-10 max-h-[85vh] flex flex-col border-t dark:border-darkborder md:border-none"><div class="p-8 border-b border-stone-100 dark:border-darkborder"><h3 id="submenu-title" class="text-2xl font-bold text-stone-800 dark:text-white">Detail Menu</h3></div><div id="submenu-list" class="p-6 overflow-y-auto space-y-3"></div><div class="p-6 border-t border-stone-100 dark:border-darkborder"><button onclick="app.closeModal('submenu-modal')" class="w-full py-4 bg-stone-100 dark:bg-darkbg rounded-2xl text-sm font-bold text-stone-600 dark:text-stone-300 hover:bg-stone-200 transition cursor-pointer">Tutup</button></div></div></div>
    <div id="feedback-modal" class="fixed inset-0 z-50 hidden flex items-end md:items-center justify-center p-0 md:p-4"><div class="absolute inset-0 bg-stone-900/20 dark:bg-black/50 backdrop-blur-sm modal-overlay opacity-0" onclick="app.closeModal('feedback-modal')"></div><div class="bg-white dark:bg-darkcard w-full md:w-auto md:max-w-md rounded-t-[2.5rem] rounded-b-none md:rounded-[2rem] shadow-2xl relative z-10 overflow-hidden transform translate-y-full md:translate-y-0 scale-95 opacity-0 modal-content transition-all duration-300 border-t dark:border-darkborder md:border-none"><div class="p-6 border-b border-stone-100 dark:border-darkborder flex justify-between items-center"><div><h3 class="text-lg font-bold text-stone-800 dark:text-white">Bantuan</h3></div><button onclick="app.closeModal('feedback-modal')" class="p-2 bg-stone-100 dark:bg-darkbg rounded-full"><i data-lucide="x" class="w-5 h-5 dark:text-stone-300"></i></button></div><div class="p-6"><form onsubmit="app.submitFeedback(event)" class="space-y-4"><textarea name="pesan" required rows="3" class="w-full bg-stone-50 dark:bg-darkbg border border-stone-200 dark:border-darkborder rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-nakula-500 outline-none resize-none dark:text-white" placeholder="Pesan Anda..."></textarea><div class="flex items-center justify-between pt-2"><label class="flex items-center gap-2 cursor-pointer select-none"><input type="checkbox" id="anonim-check" name="isAnonim" class="w-4 h-4 rounded border-stone-300" onchange="app.toggleAnonim()"><span class="text-sm text-stone-500 font-medium">Anonim</span></label><button type="submit" id="btn-feedback-submit" class="bg-stone-900 dark:bg-nakula-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg active:scale-95 transition flex items-center gap-2 text-sm cursor-pointer"><span>Kirim</span><i data-lucide="send" class="w-4 h-4"></i></button></div></form></div></div></div>
    <div id="exit-toast">Tekan sekali lagi untuk keluar</div>

    <script>
        const app = {
            apiURL: "https://script.google.com/macros/s/AKfycbzgyeCMcnsLzBMkVreP8mdw-ImRev9Q-hHn0eVpEBw6YYgD_JlOz8oXBFQ-6vtMPFAe/exec",
            menuMap: {}, backPressedTime: 0, schoolInterval: null, schools: [{ name: "NAKULAKU EKOSISTEM", jargon: '"Solid Bersinergi Menginspirasi"' }],
            
            init: function() {
                this.initTheme(); this.initSchoolRotator(); this.initClock();
                this.checkAutoLogin(); 
                const cached = localStorage.getItem('nakula_cache');
                if (cached) { try { this.render(JSON.parse(cached)); } catch(e){} }
                this.refreshData(false); this.setupBackButton(); this.setupInstallPrompt(); lucide.createIcons();
            },

            // --- UTILITIES ---
            toggleTheme: function() { const isDark=document.documentElement.classList.toggle('dark'); localStorage.setItem('theme',isDark?'dark':'light'); this.updateStatusBar(isDark); },
            initTheme: function() { const saved=localStorage.getItem('theme'); const isDark=saved==='dark'||(!saved&&window.matchMedia('(prefers-color-scheme: dark)').matches); if(isDark)document.documentElement.classList.add('dark'); this.updateStatusBar(isDark); },
            updateStatusBar: function(isDark) { document.getElementById('theme-color-meta').setAttribute('content',isDark?'#1E1E1E':'#F6F5F4'); },
            initClock: function() { setInterval(() => { const now = new Date(); const days = ['Minggu','Senin','Selasa','Rabu','Kamis','Jumat','Sabtu']; const months = ['Jan','Feb','Mar','Apr','Mei','Jun','Jul','Ags','Sep','Okt','Nov','Des']; const tStr = now.toLocaleTimeString('id-ID',{hour:'2-digit',minute:'2-digit'}); const dStr = `${days[now.getDay()]}, ${now.getDate()} ${months[now.getMonth()]} ${now.getFullYear()}`; const elClock = document.getElementById('desktop-clock'); const elDate = document.getElementById('desktop-date'); if(elClock) elClock.innerText = tStr; if(elDate) elDate.innerText = dStr; }, 1000); },
            checkAutoLogin: function() { const p = JSON.parse(localStorage.getItem('nakula_profile') || '{}'); if(p.nama) { this.updateUIForUser(p); this.refreshUserPerformance(p.nama); } else { this.updateUIForGuest(); } },
            refreshUserPerformance: function(email) { fetch(`${this.apiURL}?action=refresh&email=${email}`).then(r=>r.json()).then(d=>{ if(d.status === 'success' && d.performa) { this.updatePerformanceWidget(d.performa); let p = JSON.parse(localStorage.getItem('nakula_profile') || '{}'); p.performa = d.performa; localStorage.setItem('nakula_profile', JSON.stringify(p)); } }).catch(e=>console.log("Sync bg failed", e)); },
            getScoreColor: function(score) { if(score >= 80) return { text: 'text-green-600', bar: 'bg-green-500' }; if(score >= 50) return { text: 'text-yellow-600', bar: 'bg-yellow-500' }; return { text: 'text-red-600', bar: 'bg-red-500' }; },
            
            updatePerformanceWidget: function(p) { 
                const pColor = this.getScoreColor(p.presensi); const tColor = this.getScoreColor(p.tugas);
                const elsP = [document.getElementById('score-presensi')]; const elsT = [document.getElementById('score-tugas')];
                elsP.forEach(el => { if(el) el.innerText = p.presensi + '%'; }); elsT.forEach(el => { if(el) el.innerText = p.tugas + '%'; });
                const barP = document.getElementById('bar-presensi'); if(barP) { barP.className = `h-full rounded-full transition-all duration-1000 ${pColor.bar}`; barP.style.width = p.presensi + '%'; }
                const barT = document.getElementById('bar-tugas'); if(barT) { barT.className = `h-full rounded-full transition-all duration-1000 ${tColor.bar}`; barT.style.width = p.tugas + '%'; }
                const descP = document.getElementById('desc-presensi'); if(descP) descP.innerText = p.det_presensi; const descT = document.getElementById('desc-tugas'); if(descT) descT.innerText = p.det_tugas;
                const iconP = document.getElementById('icon-presensi-bg'); if(iconP) iconP.className = `w-8 h-8 rounded-full bg-white dark:bg-darkbg flex items-center justify-center shadow-sm ${pColor.text}`; const iconT = document.getElementById('icon-tugas-bg'); if(iconT) iconT.className = `w-8 h-8 rounded-full bg-white dark:bg-darkbg flex items-center justify-center shadow-sm ${tColor.text}`;
            },

            getRoleBg: function(role) { const r = (role || '').toLowerCase(); if(r.includes('kepala')) return 'bg-gradient-to-br from-indigo-100 to-purple-200 dark:from-indigo-900/30 dark:to-purple-900/30'; if(r.includes('pjok')) return 'bg-gradient-to-br from-orange-100 to-red-200 dark:from-orange-900/30 dark:to-red-900/30'; if(r.includes('agama')) return 'bg-gradient-to-br from-emerald-100 to-teal-200 dark:from-emerald-900/30 dark:to-teal-900/30'; if(r.includes('kelas')) return 'bg-gradient-to-br from-blue-100 to-cyan-200 dark:from-blue-900/30 dark:to-cyan-900/30'; return 'bg-gradient-to-br from-slate-200 to-zinc-300 dark:from-slate-800 dark:to-zinc-800'; },
            
            updateUIForUser: function(p) {
                // Mobile
                document.getElementById('mob-view-guest').classList.add('hidden'); document.getElementById('mob-view-user').classList.remove('hidden'); document.getElementById('mob-view-user').classList.add('flex');
                document.getElementById('mob-user-name').innerText = p.realName ? p.realName.split(' ')[0] : 'User'; 
                document.getElementById('mob-user-role').innerText = `${p.role || '-'} • ${p.instansi || '-'}`;
                if(p.photo) document.getElementById('mob-user-photo').src = p.photo;
                const widgetMobile = document.getElementById('widget-akun-mobile'); if(widgetMobile) widgetMobile.className = `md:hidden col-span-12 border border-transparent rounded-[2rem] p-5 flex flex-col justify-center relative overflow-hidden shadow-gnome hover:shadow-md min-h-[90px] ${this.getRoleBg(p.role)}`;
                // Desktop
                document.getElementById('desk-view-guest').classList.add('hidden'); document.getElementById('desk-view-user').classList.remove('hidden');
                const deskProfileContainer = document.getElementById('desktop-profile-container'); deskProfileContainer.className = `rounded-[2rem] p-6 text-center shadow-gnome dark:shadow-dark-soft border border-white/20 dark:border-white/5 relative overflow-hidden group ${this.getRoleBg(p.role)}`;
                document.getElementById('desk-user-name').innerText = p.realName; document.getElementById('desk-user-role').innerText = `${p.role || '-'} • ${p.instansi || '-'}`;
                if(p.photo) document.getElementById('desk-user-photo').src = p.photo;
                document.getElementById('sync-email').value = p.nama; 
                const widget = document.getElementById('widget-performa'); widget.classList.remove('hidden'); if(p.performa) this.updatePerformanceWidget(p.performa);
            },
            
            updateUIForGuest: function() {
                // Mobile
                document.getElementById('mob-view-guest').classList.remove('hidden'); document.getElementById('mob-view-user').classList.add('hidden'); document.getElementById('mob-view-user').classList.remove('flex');
                const widgetMobile = document.getElementById('widget-akun-mobile'); widgetMobile.className = "md:hidden col-span-12 bg-gnomecard dark:bg-darkcard border border-stone-100 dark:border-darkborder rounded-[2rem] p-5 flex flex-col justify-center relative overflow-hidden shadow-gnome dark:shadow-dark-soft min-h-[90px]";
                // Desktop
                document.getElementById('desk-view-guest').classList.remove('hidden'); document.getElementById('desk-view-user').classList.add('hidden');
                const deskProfileContainer = document.getElementById('desktop-profile-container'); deskProfileContainer.className = "bg-gradient-to-br from-slate-100 to-zinc-200 dark:from-slate-800 dark:to-zinc-800 rounded-[2rem] p-6 text-center shadow-gnome dark:shadow-dark-soft border border-white/20 dark:border-white/5 relative overflow-hidden group";
                document.getElementById('widget-performa').classList.add('hidden');
            },

            initSchoolRotator: function() { if (this.schoolInterval) clearInterval(this.schoolInterval); let currentIdx = 0; const container = document.getElementById('school-slides-container'); const createSlide = (school, isActive) => { const div = document.createElement('div'); div.className = `school-slide ${isActive ? 'active' : ''}`; const logoHtml = (school.logo && school.logo.trim() !== "") ? `<img src="${school.logo}" class="w-full h-full object-contain p-1">` : `<i data-lucide="school" class="w-6 h-6 text-white"></i>`; div.innerHTML = `<div class="w-14 h-14 rounded-2xl bg-white/20 backdrop-blur-md flex items-center justify-center border border-white/20 shrink-0 shadow-lg">${logoHtml}</div><div class="flex-1 min-w-0 text-left"><h2 class="text-lg md:text-xl font-bold leading-tight mb-0.5 line-clamp-1 text-white shadow-sm">${school.name}</h2><p class="text-[11px] md:text-xs text-white/90 font-medium italic line-clamp-1 opacity-90">"${school.jargon || 'Solid Bersinergi'}"</p></div>`; return div; }; container.innerHTML = ''; if (this.schools.length > 0) { container.appendChild(createSlide(this.schools[0], true)); lucide.createIcons(); } this.schoolInterval = setInterval(() => { const nextIdx = (currentIdx + 1) % this.schools.length; const nextSchool = this.schools[nextIdx]; const newSlide = createSlide(nextSchool, false); container.appendChild(newSlide); lucide.createIcons(); const oldSlide = container.children[0]; requestAnimationFrame(() => { oldSlide.classList.remove('active'); oldSlide.classList.add('exit'); newSlide.classList.add('active'); }); setTimeout(() => { if(oldSlide && oldSlide.parentNode) oldSlide.remove(); }, 1200); currentIdx = nextIdx; }, 7000); },
            
            renderAgenda: function(agendaList) {
                const container = document.getElementById('desktop-agenda-list');
                if(!container) return;
                if(!agendaList || agendaList.length === 0) { container.innerHTML = `<div class="p-6 text-center text-stone-400"><i data-lucide="calendar-off" class="w-8 h-8 mx-auto mb-2 opacity-50"></i>Belum ada agenda</div>`; lucide.createIcons(); return; }
                let html = '';
                agendaList.forEach(item => {
                    html += `<div class="timeline-item group"><div class="timeline-dot transition-transform group-hover:scale-125"></div><div class="flex items-start justify-between group-hover:bg-stone-50 dark:group-hover:bg-stone-800/50 p-2 rounded-lg transition-colors -mt-2"><div><span class="text-[10px] font-bold text-nakula-600 uppercase tracking-widest">${item.tanggal}</span><h4 class="text-sm font-bold text-stone-800 dark:text-white leading-tight">${item.kegiatan}</h4></div>${item.ket ? `<div class="text-[10px] text-stone-400 text-right max-w-[100px] truncate">${item.ket}</div>` : ''}</div></div>`;
                });
                container.innerHTML = html;
            },

            refreshData: function(manual) {
                const overlay = document.getElementById('loading-overlay'); if(manual) { overlay.classList.remove('hidden'); overlay.classList.add('flex'); }
                const container = document.getElementById('mobile-menu-container');
                const dockContainer = document.getElementById('dock-container');
                if(dockContainer) dockContainer.innerHTML = '';
                if(!localStorage.getItem('nakula_cache') || manual) { if(!container.children.length) container.innerHTML = `<div class="col-span-2 h-32 bg-stone-200 dark:bg-darkcard rounded-[2rem] animate-pulse"></div>`; }
                const p = JSON.parse(localStorage.getItem('nakula_profile') || '{}');
                const promises = [fetch(`${this.apiURL}?action=content&t=${Date.now()}`).then(r => r.json())];
                if(p.nama) promises.push(fetch(`${this.apiURL}?action=refresh&email=${p.nama}`).then(r => r.json()));
                Promise.all(promises).then(results => {
                    const content = results[0]; localStorage.setItem('nakula_cache', JSON.stringify(content)); this.render(content);
                    if(results[1] && results[1].status === 'success' && results[1].performa) { this.updatePerformanceWidget(results[1].performa); p.performa = results[1].performa; localStorage.setItem('nakula_profile', JSON.stringify(p)); }
                    if(manual) { setTimeout(() => { overlay.classList.add('hidden'); overlay.classList.remove('flex'); this.showAlert('success', 'Selesai', 'Data berhasil diperbarui'); }, 800); }
                }).catch(e => { if(manual) { overlay.classList.add('hidden'); overlay.classList.remove('flex'); this.showAlert('error', 'Gagal', 'Periksa koneksi internet Anda'); } });
            },
            
            syncData: function() { const email = document.getElementById('sync-email').value; const pin = document.getElementById('sync-pin').value; const btn = document.getElementById('btn-sync'); if(!email || !pin) return this.showAlert('error','Gagal','Isi Email dan PIN'); const oldTxt = btn.innerHTML; btn.innerHTML = 'Memproses...'; fetch(`${this.apiURL}?action=sync&email=${email}&pin=${pin}`).then(r => r.json()).then(d => { if(d.status === 'success') { const oldP = JSON.parse(localStorage.getItem('nakula_profile') || '{}'); const profile = { nama: email, realName: d.nama, role: d.jabatan, instansi: d.instansi, photo: oldP.photo || d.foto || "https://raw.githubusercontent.com/iwan4943/nakulaku/refs/heads/main/nakula.png", performa: d.performa }; localStorage.setItem('nakula_profile', JSON.stringify(profile)); localStorage.setItem('nakula_role', d.jabatan); this.updateUIForUser(profile); this.closeModal('profile-modal'); this.showAlert('success', 'Berhasil', `Selamat datang, ${d.nama}`); } else { this.showAlert('error', 'Gagal', d.message); } }).catch(() => this.showAlert('error','Error','Koneksi bermasalah')).finally(() => btn.innerHTML = oldTxt); },
            confirmLogout: function() { if(confirm("Apakah Anda yakin ingin keluar?")) { localStorage.removeItem('nakula_profile'); localStorage.removeItem('nakula_role'); localStorage.removeItem('nakula_cache'); location.reload(); } },
            submitFeedback: function(e) { e.preventDefault(); const btn=document.getElementById('btn-feedback-submit'); const oldTxt=btn.innerHTML; btn.innerHTML='<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Mengirim...'; btn.disabled=true; lucide.createIcons(); const fd=new FormData(e.target); const obj=Object.fromEntries(fd.entries()); obj.isAnonim=document.getElementById('anonim-check').checked; const sendRequest=fetch(this.apiURL,{method:'POST',mode:'no-cors',headers:{'Content-Type':'application/json'},body:JSON.stringify(obj)}); const fakeDelay=new Promise(r=>setTimeout(r,1500)); Promise.race([sendRequest,fakeDelay]).then(()=>{ this.closeModal('feedback-modal'); this.showAlert('success','Terkirim','Terima kasih atas masukan Anda!'); e.target.reset(); this.setRating(5); }).catch(err=>{ console.error(err); this.showAlert('error','Gagal','Terjadi kesalahan jaringan'); }).finally(()=>{ btn.innerHTML=oldTxt; btn.disabled=false; }); },
            scrollToTop: function() { document.getElementById('main-scroll').scrollTo(0,0); },
            openModal: function(id) { const el = document.getElementById(id); el.classList.remove('hidden'); setTimeout(() => { el.querySelector('.modal-overlay').classList.remove('opacity-0'); el.querySelector('.modal-content').classList.remove('opacity-0', 'scale-95', 'translate-y-full'); el.querySelector('.modal-content').classList.add('scale-100', 'translate-y-0'); }, 10); },
            closeModal: function(id) { const el = document.getElementById(id); el.querySelector('.modal-overlay').classList.add('opacity-0'); const c = el.querySelector('.modal-content'); c.classList.remove('scale-100', 'opacity-100', 'animate-bounce-in'); c.classList.add('opacity-0', 'scale-95'); if(id.includes('submenu') || id.includes('profile')) c.classList.add('translate-y-full'); setTimeout(() => el.classList.add('hidden'), 300); },
            setupInstallPrompt: function() { window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); this.deferredPrompt = e; }); },
            setupBackButton: function() { window.onpopstate = () => { const open = document.querySelectorAll('.fixed:not(.hidden)'); if(open.length) { open.forEach(el => this.closeModal(el.id)); return; } const now = Date.now(); if(now - this.backPressedTime < 2000) { history.back(); } else { this.backPressedTime = now; this.showToast("Tekan lagi untuk keluar"); history.pushState(null, null, ""); } }; },
            toggleAnonim: function() { const isAnon=document.getElementById('anonim-check').checked; const identity=document.getElementById('feedback-identity'); if(isAnon){ identity.classList.add('opacity-50','pointer-events-none'); }else{ identity.classList.remove('opacity-50','pointer-events-none'); } },
            setRating: function(v) { document.getElementById('rating-input').value=v; const buttons=document.getElementById('star-rating-group').querySelectorAll('button'); buttons.forEach((btn,index)=>{ const icon=btn.querySelector('svg')||btn.querySelector('i'); if(icon){ if(index<v){ icon.classList.add('text-yellow-400','fill-yellow-400'); icon.classList.remove('text-stone-300'); }else{ icon.classList.remove('text-yellow-400','fill-yellow-400'); icon.classList.add('text-stone-300'); } } }); },
            showAlert: function(type, title, msg) { const modal = document.getElementById('dialog-modal'); const iconContainer = document.getElementById('dialog-icon'); const iconBg = document.getElementById('dialog-icon-container'); let colorClass = type === 'error' ? 'text-red-500' : (type === 'success' ? 'text-green-500' : 'text-blue-500'); let iconName = type === 'error' ? 'alert-triangle' : (type === 'success' ? 'check' : 'info'); iconContainer.innerHTML = `<i data-lucide="${iconName}" class="w-10 h-10 ${colorClass}"></i>`; iconBg.className = `mb-5 mx-auto w-20 h-20 rounded-full flex items-center justify-center shadow-lg relative ${colorClass.replace('text','bg')}/10`; document.getElementById('dialog-title').innerText = title; document.getElementById('dialog-msg').innerText = msg; document.getElementById('dialog-actions').innerHTML = `<button onclick="app.closeModal('dialog-modal')" class="w-full py-3.5 bg-stone-900 text-white rounded-[1.5rem] font-bold text-sm shadow-xl hover:scale-[1.02] active:scale-95 transition-all cursor-pointer">Mengerti</button>`; lucide.createIcons(); this.openModal('dialog-modal'); const content = modal.querySelector('.modal-content'); content.classList.remove('scale-75', 'opacity-0'); content.classList.add('scale-100', 'opacity-100', 'animate-bounce-in'); },
            handleLink: function(url) { if (!url) return; if (url.startsWith('#')) { if (url === '#top') this.scrollToTop(); else if (url === '#menu') this.openModal('submenu-modal'); else if (url === '#profile') this.openModal('profile-modal'); else if (url === '#theme') this.toggleTheme(); else if (url === '#refresh') this.refreshData(true); else if (url === '#install') this.showInstallPrompt(); } else { window.open(url, '_blank'); } },
            openSubmenu: function(parentTitle) { const list = this.menuMap[parentTitle.toLowerCase()] || []; const container = document.getElementById('submenu-list'); document.getElementById('submenu-title').innerText = parentTitle; container.innerHTML = list.map(m => `<div onclick="window.open('${m.url}','_blank')" class="flex items-center gap-5 p-5 rounded-[2rem] bg-stone-50 dark:bg-darkbg active:bg-stone-200 transition cursor-pointer border border-stone-100 dark:border-darkborder relative z-10"><div class="w-10 h-10 rounded-2xl bg-white dark:bg-darkcard flex items-center justify-center text-nakula-600 shadow-sm"><i data-lucide="${m.icon||'link'}" class="w-5 h-5"></i></div><div class="flex-1"><h5 class="font-bold text-sm text-stone-700 dark:text-white">${m.judul}</h5><p class="text-[10px] text-stone-400 font-medium">${m.deskripsi||''}</p></div><i data-lucide="chevron-right" class="w-4 h-4 text-stone-300"></i></div>`).join(''); lucide.createIcons(); this.openModal('submenu-modal'); },

            render: function(data) {
                const menuList = data.menu || []; const info = data.info || {};
                if (data.schools && data.schools.length > 0) { this.schools = data.schools; this.initSchoolRotator(); }
                if (data.agenda) { this.renderAgenda(data.agenda); }
                const annArea = document.getElementById('announcement-area');
                
                // POPUP INFO
                if (info.status === 'POPUP') { 
                    this.showAlert('info', 'Pengumuman', info.pesan);
                    annArea.classList.add('hidden');
                } else if (info.status === 'ON') { 
                    annArea.innerHTML = `<div class="col-span-12 bg-nakula-50 text-nakula-800 dark:bg-darkcard dark:text-stone-200 p-5 rounded-[2rem] flex gap-4 text-xs shadow-soft dark:shadow-dark-soft border border-nakula-100 dark:border-stone-700"><i data-lucide="bell" class="w-5 h-5 shrink-0 text-nakula-600"></i><span class="leading-relaxed font-bold">${info.pesan}</span></div>`; annArea.classList.remove('hidden'); 
                } else { annArea.classList.add('hidden'); }
                
                // QUOTES
                const quoteText = document.getElementById('quote-text');
                const quoteAuth = document.getElementById('quote-author');
                if(quoteText && info.quote) quoteText.innerText = info.quote;
                if(quoteAuth && info.author) quoteAuth.innerText = info.author;

                this.menuMap = {}; 
                const mobContainer = document.getElementById('mobile-menu-container');
                const deskContainer = document.getElementById('desktop-sidebar-menu');
                let mobHtml = ''; let deskHtml = '';
                const getRole = (localStorage.getItem('nakula_role') || '').toLowerCase();
                
                menuList.forEach(m => { const p = (m.parent||'').toLowerCase().trim(); if(p) { if(!this.menuMap[p]) this.menuMap[p] = []; this.menuMap[p].push(m); } });

                menuList.forEach((item, index) => {
                    const isParent = !item.parent;
                    const isDock = (item.posisi || 'home').toLowerCase() === 'dock';
                    const device = (item.posisi || 'all').toLowerCase();
                    const showMobile = device === 'all' || device === 'mobile';
                    const showDesktop = device === 'all' || device === 'desktop';
                    
                    if(isParent && !isDock) {
                        if(item.role && item.role.toLowerCase() !== 'all' && !getRole.includes(item.role.toLowerCase())) return;
                        const hasChild = this.menuMap[item.judul.toLowerCase()];
                        const action = hasChild ? `onclick="app.openSubmenu('${item.judul}')"` : (item.url ? `onclick="app.handleLink('${item.url}')"` : `onclick="app.showAlert('info','Info','Fitur ini segera hadir')"`);
                        
                        if(showMobile) {
                            const isLarge = (item.ukuran || '').toString().toLowerCase().trim() === 'wide';
                            const colClass = isLarge ? 'col-span-2' : 'col-span-1';
                            const heightClass = isLarge ? 'h-32' : 'h-32';
                            const bgClass = item.warna ? `bg-${item.warna}-50 dark:bg-${item.warna}-900/20` : 'bg-gnomecard dark:bg-darkcard';
                            const textClass = item.warna ? `text-${item.warna}-700 dark:text-${item.warna}-300` : 'text-stone-700 dark:text-stone-200';
                            mobHtml += `<div ${action} class="${colClass} ${heightClass} ${bgClass} bento-card rounded-[2.5rem] p-6 relative overflow-hidden cursor-pointer shadow-gnome dark:shadow-dark-soft hover:shadow-lg dark:hover:shadow-white/5 border border-stone-100 dark:border-darkborder group relative z-10"><div class="relative z-20 flex flex-col h-full justify-center items-center text-center gap-2"><div class="w-12 h-12 rounded-[1.2rem] bg-stone-50 dark:bg-darkbg flex items-center justify-center shadow-sm ${textClass} border border-stone-200 dark:border-darkborder shrink-0"><i data-lucide="${item.icon||'box'}" class="w-6 h-6 stroke-[1.5]"></i></div><div><h4 class="font-bold text-sm leading-tight ${textClass} mb-0.5 line-clamp-1">${item.judul}</h4>${isLarge ? `<p class="text-[10px] text-stone-400 font-bold uppercase tracking-wide line-clamp-1">${item.deskripsi||'Akses layanan'}</p>` : ''}</div></div><i data-lucide="${item.icon||'box'}" class="icon-watermark w-28 h-28 text-stone-300 dark:text-stone-700 z-0"></i>${hasChild ? `<div class="absolute top-4 right-4 text-stone-300 z-20"><i data-lucide="arrow-up-right" class="w-4 h-4"></i></div>` : ''}</div>`;
                        }
                        if(showDesktop) {
                            const bgClassDesk = item.warna ? `bg-${item.warna}-100 dark:bg-${item.warna}-900/30` : 'bg-stone-100 dark:bg-stone-800';
                            const textClassDesk = item.warna ? `text-${item.warna}-700 dark:text-${item.warna}-300` : 'text-stone-700 dark:text-stone-300';
                            deskHtml += `<button ${action} class="w-full p-4 rounded-2xl bg-white dark:bg-darkcard border border-stone-100 dark:border-stone-800 hover:border-nakula-200 dark:hover:border-stone-600 transition flex items-center gap-3 text-left group shadow-sm cursor-pointer relative z-10"><div class="w-10 h-10 rounded-xl ${bgClassDesk} flex items-center justify-center ${textClassDesk}"><i data-lucide="${item.icon||'box'}" class="w-5 h-5"></i></div><div class="flex-1 min-w-0"><h5 class="font-bold text-sm text-stone-800 dark:text-white truncate">${item.judul}</h5><p class="text-[10px] text-stone-400 truncate">${item.deskripsi||'Akses layanan'}</p></div><i data-lucide="chevron-right" class="w-4 h-4 text-stone-300 group-hover:translate-x-1 transition-transform"></i></button>`;
                        }
                    }
                    if(isDock) {
                        const dockContainer = document.getElementById('dock-container');
                        if(dockContainer) {
                            if(dockContainer.innerHTML === '') dockContainer.classList.remove('hidden');
                            dockContainer.innerHTML += `<button onclick="app.handleLink('${item.url}')" class="p-3.5 rounded-xl hover:bg-white/10 active:scale-90 transition flex flex-col items-center gap-1 group cursor-pointer relative z-50"><i data-lucide="${item.icon||'circle'}" class="w-6 h-6 group-hover:text-stone-300 transition-colors"></i></button>`;
                        }
                    }
                });
                
                if(mobContainer) mobContainer.innerHTML = mobHtml || '<div class="col-span-2 text-center py-10 text-stone-400 text-xs">Menu tidak tersedia</div>';
                if(deskContainer) deskContainer.innerHTML = deskHtml;
                lucide.createIcons();
            }
        };

        document.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>
