<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Presensi Gugus Nakula</title>

    <!-- FONTS -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- BOOTSTRAP 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- FONT AWESOME -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- LEAFLET CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- SWEETALERT2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root {
            --primary-color: #B3261E;
            --primary-bg: #FFF8F7;
            --surface-color: #FFFFFF;
            --nav-height: 70px;
        }

        body {
            background-color: #F0F2F5;
            font-family: 'Roboto', sans-serif;
            color: #1f1f1f;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* MOBILE FRAME SIMULATION FOR DESKTOP */
        .app-container {
            max-width: 480px;
            min-height: 100vh;
            margin: 0 auto;
            background-color: var(--primary-bg);
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
            position: relative;
            padding-bottom: var(--nav-height);
            overflow: hidden;
        }

        .fw-google { font-family: 'Google Sans', sans-serif; }

        /* LOADING OVERLAY */
        #loadingOverlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(5px);
            z-index: 9999;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        /* LOGIN PAGE */
        #login-page {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(180deg, #FFFFFF 0%, #FFDAD6 100%);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }
        
        .login-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border-radius: 28px;
            padding: 40px 24px;
            width: 100%;
            box-shadow: 0 10px 40px rgba(179, 38, 30, 0.15);
            border: 1px solid rgba(255,255,255,0.6);
        }

        .pin-input {
            border: none;
            border-bottom: 2px solid #ccc;
            border-radius: 0;
            background: transparent;
            font-size: 2rem;
            letter-spacing: 0.5em;
            text-align: center;
            color: var(--primary-color);
            transition: 0.3s;
        }
        .pin-input:focus {
            box-shadow: none;
            border-bottom-color: var(--primary-color);
            outline: none;
        }

        /* HEADER */
        .app-header {
            background: #fff;
            padding: 20px 24px 15px;
            border-radius: 0 0 32px 32px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.03);
            margin-bottom: 16px;
        }

        .user-avatar {
            width: 48px; height: 48px;
            background: var(--primary-color);
            color: white;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 1.2rem;
            box-shadow: 0 4px 8px rgba(179, 38, 30, 0.2);
        }

        .status-chip {
            font-size: 0.75rem;
            padding: 4px 12px;
            border-radius: 20px;
            background: #FCEAE9;
            color: #410E0B;
            font-weight: 500;
            border: 1px solid #FFDAD6;
        }

        /* CARDS & CONTENT */
        .content-area { padding: 0 16px; animation: fadeIn 0.4s ease; }
        .card-custom {
            border: none;
            border-radius: 24px;
            background: #fff;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.02);
            transition: transform 0.2s;
        }
        
        .form-label-custom {
            font-size: 0.85rem;
            font-weight: 700;
            color: #666;
            margin-left: 0.5rem;
            margin-bottom: 0.4rem;
        }

        /* FORM ELEMENTS */
        .form-control-custom {
            background: #F8F9FA;
            border: 1px solid #eee;
            border-radius: 16px;
            padding: 14px 16px;
            font-size: 0.95rem;
            transition: 0.3s;
        }
        .form-control-custom:focus {
            background: #fff;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(179, 38, 30, 0.1);
        }

        /* BUTTONS */
        .btn-primary-custom {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50px;
            padding: 14px;
            font-weight: 600;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 12px rgba(179, 38, 30, 0.3);
            transition: 0.2s;
        }
        .btn-primary-custom:active, .btn-primary-custom:hover {
            background-color: #9c1c16;
            color: white;
            transform: translateY(1px);
        }

        /* CAMERA & MAP */
        #camera-wrapper {
            position: relative;
            border-radius: 20px;
            overflow: hidden;
            background: #000;
            height: 380px;
            display: none;
        }
        #camera-wrapper video {
            width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1);
        }
        .shutter-btn {
            width: 70px; height: 70px;
            background: white;
            border-radius: 50%;
            position: absolute; bottom: 20px; left: 50%;
            transform: translateX(-50%);
            border: 4px solid rgba(255,255,255,0.3);
            outline: 3px solid var(--primary-color);
            cursor: pointer;
            transition: 0.2s;
        }
        .shutter-btn:active { transform: translateX(-50%) scale(0.9); }

        #map {
            height: 180px; width: 100%;
            border-radius: 16px;
            margin-top: 10px;
            z-index: 1;
        }

        /* LIST ITEMS */
        .history-card {
            background: white;
            padding: 16px;
            border-radius: 20px;
            margin-bottom: 10px;
            border: 1px solid #f0f0f0;
            display: flex; flex-direction: column; gap: 8px;
            position: relative;
            overflow: hidden;
        }
        .history-card::before {
            content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 6px;
            background: #eee;
        }
        .history-card.status-Hadir::before { background: #137333; }
        .history-card.status-Telat::before { background: #B06000; }
        .history-card.status-Luar::before { background: #C5221F; }
        .history-card.status-Izin::before { background: #1967D2; }

        .badge-status { font-size: 0.7rem; padding: 5px 10px; border-radius: 8px; }
        .bg-hadir { background: #E6F4EA; color: #137333; }
        .bg-telat { background: #FEF7E0; color: #B06000; }
        .bg-absen { background: #FCE8E6; color: #C5221F; }
        .bg-izin { background: #E8F0FE; color: #1967D2; }

        /* BOTTOM NAV */
        .bottom-nav {
            position: absolute;
            bottom: 0; left: 0; width: 100%;
            height: var(--nav-height);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid #eee;
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 1000;
            padding-bottom: 10px; /* Safe area */
            box-shadow: 0 -4px 20px rgba(0,0,0,0.02);
        }
        .nav-item {
            text-align: center;
            color: #999;
            font-size: 0.7rem;
            flex: 1;
            cursor: pointer;
            transition: 0.3s;
            position: relative;
        }
        .nav-icon {
            font-size: 1.2rem;
            margin-bottom: 4px;
            display: block;
            width: 40px;
            height: 28px;
            line-height: 28px;
            border-radius: 14px;
            margin: 0 auto 4px auto;
            transition: 0.3s;
        }
        .nav-item.active .nav-icon {
            background: #FFDAD6;
            color: #410E0B;
        }
        .nav-item.active span {
            color: #410E0B;
            font-weight: 700;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>

<div class="app-container">
    <!-- LOADING -->
    <div id="loadingOverlay">
        <div class="spinner-border text-danger mb-3" role="status" style="width: 3rem; height: 3rem;"></div>
        <div class="fw-bold text-dark">Memproses Data...</div>
    </div>

    <!-- LOGIN SCREEN -->
    <div id="login-page">
        <div class="login-card text-center">
            <div class="mb-4">
                <span class="fa-stack fa-2x">
                  <i class="fas fa-circle fa-stack-2x text-danger opacity-25"></i>
                  <i class="fas fa-school fa-stack-1x text-danger"></i>
                </span>
            </div>
            <h3 class="fw-google fw-bold mb-1">Gugus Nakula</h3>
            <p class="text-muted small mb-5">Sistem Presensi Digital</p>
            
            <div class="mb-4 text-start px-2">
                <label class="form-label-custom">MASUKKAN PIN</label>
                <input type="password" id="inputPin" class="form-control pin-input" placeholder="••••••" inputmode="numeric">
            </div>
            
            <button onclick="doLogin()" class="btn btn-primary-custom w-100 btn-lg fs-6">
                MASUK APLIKASI <i class="fas fa-arrow-right ms-2"></i>
            </button>
        </div>
    </div>

    <!-- MAIN APP SCREEN -->
    <div id="app-page" style="display: none;">
        <!-- Header -->
        <div class="app-header">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="d-flex align-items-center gap-3">
                    <div class="user-avatar" id="avatarInitial">U</div>
                    <div>
                        <div class="small text-muted" id="dispJabatan">Guru Kelas</div>
                        <h5 class="fw-google fw-bold m-0 text-truncate" style="max-width: 180px;" id="dispNama">User Name</h5>
                    </div>
                </div>
                <button onclick="doLogout()" class="btn btn-light rounded-circle text-danger shadow-sm border-0" style="width:40px;height:40px;">
                    <i class="fas fa-power-off"></i>
                </button>
            </div>
            
            <div class="d-flex flex-wrap gap-2">
                <span class="status-chip bg-danger text-white border-0" id="dispUnit"><i class="fas fa-building me-1"></i> Unit</span>
                <span class="status-chip"><i class="fas fa-clock me-1"></i> <span id="labelJamMulai">06:00</span> - <span id="labelJamTutup">14:00</span></span>
            </div>
            
            <div id="infoBar" class="alert alert-warning border-0 bg-warning bg-opacity-10 text-warning-emphasis d-flex align-items-center p-2 rounded-4 mt-3 mb-0" style="display:none !important;">
                <i class="fas fa-bullhorn me-2 fs-5"></i>
                <marquee id="textInfo" class="fw-medium small" scrollamount="5">Selamat Datang</marquee>
            </div>
        </div>

        <!-- VIEW: ABSENSI (HOME) -->
        <div id="view-home" class="content-area">
            <!-- Lokasi Card -->
            <div class="card-custom">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="fw-google fw-bold text-danger m-0"><i class="fas fa-map-marked-alt me-2"></i>Lokasi Presensi</h6>
                    <span id="badgeJarak" class="badge rounded-pill bg-light text-secondary border">Mencari GPS...</span>
                </div>
                <div id="map"></div>
                <div class="d-flex justify-content-between align-items-end mt-2">
                    <div>
                        <div class="small text-muted mb-0">Target: <strong id="dispLokasiTarget">...</strong></div>
                        <div class="small text-muted" style="font-size: 0.7rem;" id="lokasiText">Menunggu koordinat...</div>
                    </div>
                    <button onclick="startGPS()" class="btn btn-sm btn-light text-danger rounded-circle shadow-sm border">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>

            <!-- Kamera & Form -->
            <div class="card-custom">
                <h6 class="fw-google fw-bold text-danger mb-3"><i class="fas fa-camera me-2"></i>Bukti Kehadiran</h6>
                
                <!-- Camera UI -->
                <div id="btn-open-camera" onclick="startCamera()" class="text-center py-5 bg-light rounded-4 border border-dashed mb-3" style="cursor: pointer;">
                    <div class="bg-white p-3 rounded-circle shadow-sm d-inline-block mb-2">
                        <i class="fas fa-camera fa-2x text-danger"></i>
                    </div>
                    <div class="fw-bold text-secondary">Ketuk untuk Foto</div>
                </div>

                <div id="camera-wrapper" class="mb-3">
                    <video id="video" autoplay playsinline></video>
                    <div class="shutter-btn" onclick="takeSnapshot()"></div>
                </div>

                <div id="result-wrapper" class="mb-3" style="display:none;">
                    <img id="photo-preview" class="w-100 rounded-4 shadow-sm mb-2" style="max-height: 300px; object-fit: cover;">
                    <button onclick="retakePhoto()" class="btn btn-light w-100 rounded-pill fw-bold text-secondary border">
                        <i class="fas fa-redo me-2"></i> Foto Ulang
                    </button>
                </div>

                <!-- Input Form -->
                <div class="mb-3">
                    <label class="form-label-custom">Catatan Kegiatan</label>
                    <textarea id="inputMateri" class="form-control form-control-custom" rows="3" placeholder="Ringkasan aktivitas hari ini..." style="resize: none;"></textarea>
                </div>

                <!-- Hidden Inputs -->
                <input type="hidden" id="h_lat"><input type="hidden" id="h_long">
                <input type="hidden" id="h_target"><input type="hidden" id="h_foto">

                <button onclick="kirimPresensi()" class="btn btn-primary-custom w-100">
                    <i class="fas fa-paper-plane me-2"></i> KIRIM ABSEN
                </button>
            </div>
        </div>

        <!-- VIEW: IZIN -->
        <div id="view-izin" class="content-area" style="display:none;">
            <div class="card-custom">
                <div class="text-center mb-4">
                    <div class="bg-primary bg-opacity-10 p-3 rounded-circle d-inline-block mb-2">
                        <i class="fas fa-envelope-open-text fa-2x text-danger"></i>
                    </div>
                    <h5 class="fw-bold">Pengajuan Izin</h5>
                    <p class="text-muted small">Formulir ketidakhadiran kerja</p>
                </div>
                
                <form id="formIzin">
                    <div class="mb-3">
                        <label class="form-label-custom">Kategori Izin</label>
                        <select id="izin_jenis" class="form-select form-control-custom">
                            <option value="Sakit">Sakit</option>
                            <option value="Izin Pribadi">Izin Pribadi</option>
                            <option value="Dinas Luar">Dinas Luar</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="form-label-custom">Keterangan Detail</label>
                        <textarea id="izin_alasan" class="form-control form-control-custom" rows="4" placeholder="Jelaskan alasan izin secara singkat..."></textarea>
                    </div>
                    <button type="button" onclick="kirimIzin()" class="btn btn-primary-custom w-100">
                        AJUKAN PERMOHONAN
                    </button>
                </form>
            </div>
        </div>

        <!-- VIEW: RIWAYAT -->
        <div id="view-riwayat" class="content-area" style="display:none;">
            <div class="row g-2 mb-3">
                <div class="col-6">
                    <div class="card-custom p-3 text-center bg-danger text-white mb-0 h-100 d-flex flex-column justify-content-center">
                        <small class="opacity-75">Hadir Bulan Ini</small>
                        <h2 class="fw-bold m-0" id="statHadir">0</h2>
                    </div>
                </div>
                <div class="col-6">
                    <div class="card-custom p-3 text-center mb-0 h-100 border d-flex flex-column justify-content-center">
                        <small class="text-muted">Persentase</small>
                        <h2 class="fw-bold text-danger m-0" id="statPersen">0%</h2>
                    </div>
                </div>
            </div>
            
            <div class="d-flex justify-content-between align-items-center mb-3 px-2">
                <h6 class="fw-bold m-0">Aktivitas Terakhir</h6>
                <button onclick="loadRiwayat()" class="btn btn-sm btn-light rounded-pill px-3 fw-bold text-secondary border">
                    <i class="fas fa-sync me-1"></i> Refresh
                </button>
            </div>
            
            <div id="listRiwayatContainer"></div>
        </div>

        <!-- VIEW: MONITORING (ADMIN) -->
        <div id="view-monitoring" class="content-area" style="display:none;">
            <div class="card-custom bg-dark text-white mb-3">
                <div class="d-flex align-items-center">
                    <div class="bg-white bg-opacity-25 p-3 rounded-circle me-3">
                        <i class="fas fa-users fa-lg"></i>
                    </div>
                    <div>
                        <h6 class="fw-bold m-0">Monitoring Guru</h6>
                        <small class="opacity-75">Pantau kehadiran real-time</small>
                    </div>
                </div>
            </div>

            <div class="d-flex justify-content-between align-items-center mb-3 px-2">
                <h6 class="fw-bold m-0">Data Hari Ini</h6>
                <button onclick="loadMonitoring()" class="btn btn-sm btn-outline-secondary rounded-pill px-3">Refresh</button>
            </div>

            <div id="listMonitoringContainer"></div>
        </div>

        <!-- VIEW: SETTINGS (ADMIN) -->
        <div id="view-setting" class="content-area" style="display:none;">
            <div class="card-custom">
                <h6 class="fw-bold text-danger mb-4"><i class="fas fa-sliders-h me-2"></i>Pengaturan Sistem</h6>
                
                <div class="mb-3">
                    <label class="form-label-custom">Target Lokasi Sekolah</label>
                    <select id="set_lokasi" class="form-select form-control-custom"></select>
                </div>
                
                <div class="mb-3">
                    <label class="form-label-custom">Info Berjalan (Marquee)</label>
                    <textarea id="set_info" class="form-control form-control-custom" rows="2"></textarea>
                </div>
                
                <div class="row g-2 mb-4">
                    <div class="col-4">
                        <label class="small text-center d-block text-muted">Buka</label>
                        <input type="time" id="set_mulai" class="form-control form-control-custom text-center px-1">
                    </div>
                    <div class="col-4">
                        <label class="small text-center d-block text-muted">Tutup</label>
                        <input type="time" id="set_selesai" class="form-control form-control-custom text-center px-1">
                    </div>
                    <div class="col-4">
                        <label class="small text-center d-block text-danger fw-bold">Batas</label>
                        <input type="time" id="set_batas" class="form-control form-control-custom text-center px-1 border-danger">
                    </div>
                </div>
                
                <button onclick="simpanSettings()" class="btn btn-primary-custom w-100">
                    SIMPAN KONFIGURASI
                </button>
            </div>
        </div>

        <div style="height: 20px;"></div> <!-- Spacer -->
    </div>

    <!-- BOTTOM NAVIGATION -->
    <div id="bottomNav" class="bottom-nav" style="display: none;">
        <div class="nav-item active" onclick="switchView('home', this)">
            <div class="nav-icon"><i class="fas fa-fingerprint"></i></div>
            <span>Absen</span>
        </div>
        <div class="nav-item" onclick="switchView('izin', this)">
            <div class="nav-icon"><i class="fas fa-file-signature"></i></div>
            <span>Izin</span>
        </div>
        <div class="nav-item" onclick="switchView('riwayat', this)">
            <div class="nav-icon"><i class="fas fa-history"></i></div>
            <span>Riwayat</span>
        </div>
        <div class="nav-item" id="navMonitor" style="display:none;" onclick="switchView('monitoring', this)">
            <div class="nav-icon"><i class="fas fa-users-cog"></i></div>
            <span>Monitor</span>
        </div>
        <div class="nav-item" id="navSetting" style="display:none;" onclick="switchView('setting', this)">
            <div class="nav-icon"><i class="fas fa-cog"></i></div>
            <span>Admin</span>
        </div>
    </div>
</div>

<!-- HIDDEN CANVAS -->
<canvas id="canvas" style="display:none;"></canvas>

<!-- SCRIPTS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    /* --- CONFIGURATION --- */
    const API_URL = "https://script.google.com/macros/s/AKfycbynar0CfOd9KnenW7RF8_AU4bhe9craI3nxqNWHFMgJJ6j4VZEYowk69Z9-WsjgJeMa/exec";
    
    /* --- STATE --- */
    let userData = null;
    let targetLokasi = null;
    let userLat = 0, userLong = 0;
    let map = null, marker = null, circle = null;
    let streamKamera = null;

    /* --- INITIALIZATION --- */
    window.onload = function() {
        const saved = localStorage.getItem('gugusUser_v2');
        if (saved) {
            try {
                userData = JSON.parse(saved);
                initApp();
            } catch (e) {
                localStorage.removeItem('gugusUser_v2');
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        } else {
            document.getElementById('loadingOverlay').style.display = 'none';
        }
    };

    /* --- API HELPER --- */
    async function callAPI(action, payload = {}) {
        payload.action = action;
        // console.log("Calling API:", action, payload); // Debug
        try {
            const response = await fetch(API_URL, { 
                method: "POST", 
                body: JSON.stringify(payload) 
            });
            return await response.json();
        } catch (error) {
            console.error(error);
            Swal.fire({
                icon: 'error',
                title: 'Koneksi Error',
                text: 'Gagal terhubung ke server. Cek internet Anda.',
                confirmButtonColor: '#B3261E'
            });
            return null;
        }
    }

    /* --- AUTH --- */
    async function doLogin() {
        const pin = document.getElementById('inputPin').value;
        if (!pin) return Swal.fire('Error', 'Masukkan PIN Anda', 'warning');
        
        toggleLoading(true);
        const res = await callAPI('login', { pin: pin });
        toggleLoading(false);

        if (res && res.status === 'SUKSES') {
            userData = res;
            localStorage.setItem('gugusUser_v2', JSON.stringify(userData));
            initApp(res.targetLokasi);
            Swal.fire({
                icon: 'success',
                title: 'Login Berhasil',
                text: 'Selamat datang ' + res.nama,
                timer: 1500,
                showConfirmButton: false
            });
        } else {
            Swal.fire('Gagal', 'PIN tidak ditemukan atau salah.', 'error');
        }
    }

    function doLogout() {
        Swal.fire({
            title: 'Keluar?',
            text: "Anda harus login kembali nanti.",
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#B3261E',
            confirmButtonText: 'Ya, Keluar'
        }).then((result) => {
            if (result.isConfirmed) {
                localStorage.removeItem('gugusUser_v2');
                location.reload();
            }
        });
    }

    /* --- MAIN APP LOGIC --- */
    async function initApp(targetBaru) {
        // UI Updates
        document.getElementById('login-page').style.display = 'none';
        document.getElementById('app-page').style.display = 'block';
        document.getElementById('bottomNav').style.display = 'flex';
        
        // Populate User Info
        document.getElementById('dispNama').innerText = userData.nama;
        document.getElementById('dispJabatan').innerText = userData.jabatan || 'Guru';
        document.getElementById('dispUnit').innerHTML = `<i class="fas fa-building me-1"></i> ${userData.unitKerja}`;
        document.getElementById('avatarInitial').innerText = userData.nama.charAt(0).toUpperCase();

        // Admin Checks
        const isAdmin = userData.isAdmin;
        const isKepala = userData.jabatan && userData.jabatan.toLowerCase().includes('kepala');
        
        if (isAdmin || isKepala) document.getElementById('navMonitor').style.display = 'block';
        if (isAdmin) document.getElementById('navSetting').style.display = 'block';

        // Load Target Location
        if (targetBaru) {
            setupTarget(targetBaru);
        } else {
            const loc = await callAPI('getLokasi');
            if (loc) setupTarget(loc);
        }
    }

    function setupTarget(res) {
        targetLokasi = res;
        document.getElementById('h_target').value = res.nama;
        document.getElementById('dispLokasiTarget').innerText = res.nama;
        document.getElementById('labelJamMulai').innerText = res.jamMulai;
        document.getElementById('labelJamTutup').innerText = res.jamSelesai;
        
        if (res.info && res.info !== "-") {
            document.getElementById('infoBar').style.setProperty('display', 'flex', 'important');
            document.getElementById('textInfo').innerText = res.info;
        }
        
        // Start GPS automatically
        setTimeout(startGPS, 1000);
    }

    /* --- NAVIGATION --- */
    function switchView(viewName, element) {
        // Stop Camera if moving away from home
        if (streamKamera) stopCamera();

        // Toggle Views
        document.querySelectorAll('.content-area').forEach(el => el.style.display = 'none');
        document.getElementById(`view-${viewName}`).style.display = 'block';

        // Update Nav Active State
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        if (element) element.classList.add('active');

        // View Specific Loaders
        if (viewName === 'riwayat') loadRiwayat();
        if (viewName === 'monitoring') loadMonitoring();
        if (viewName === 'setting') loadSettings();
        
        // Map Resize fix
        if (viewName === 'home' && map) setTimeout(() => map.invalidateSize(), 300);
    }

    /* --- FEATURES: GPS --- */
    function startGPS() {
        if (!navigator.geolocation) return Swal.fire('Error', 'GPS tidak didukung browser ini.', 'error');
        
        document.getElementById('badgeJarak').innerHTML = '<span class="spinner-border spinner-border-sm"></span> Mencari...';
        
        navigator.geolocation.watchPosition(
            (pos) => {
                userLat = pos.coords.latitude;
                userLong = pos.coords.longitude;
                
                // Update Hidden Inputs
                document.getElementById('h_lat').value = userLat;
                document.getElementById('h_long').value = userLong;
                document.getElementById('lokasiText').innerText = `${userLat.toFixed(5)}, ${userLong.toFixed(5)}`;
                
                updateMapDisplay();
            },
            (err) => {
                document.getElementById('badgeJarak').className = 'badge bg-danger';
                document.getElementById('badgeJarak').innerText = 'GPS Error';
            },
            { enableHighAccuracy: true }
        );
    }

    function updateMapDisplay() {
        if (!targetLokasi) return;

        const dist = hitungJarak(userLat, userLong, targetLokasi.lat, targetLokasi.long);
        const isRadius = dist <= targetLokasi.radius;
        
        const badge = document.getElementById('badgeJarak');
        if (isRadius) {
            badge.className = 'badge rounded-pill bg-success';
            badge.innerHTML = `<i class="fas fa-check-circle me-1"></i> Di Zona (${Math.round(dist)}m)`;
        } else {
            badge.className = 'badge rounded-pill bg-danger';
            badge.innerHTML = `<i class="fas fa-exclamation-triangle me-1"></i> Luar Zona (${Math.round(dist)}m)`;
        }

        // Map Render
        if (!map) {
            map = L.map('map', { zoomControl: false }).setView([userLat, userLong], 16);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            marker = L.marker([userLat, userLong]).addTo(map);
            if (targetLokasi.lat) {
                circle = L.circle([targetLokasi.lat, targetLokasi.long], {
                    color: '#B3261E',
                    fillColor: '#B3261E',
                    fillOpacity: 0.15,
                    radius: targetLokasi.radius
                }).addTo(map);
            }
        } else {
            marker.setLatLng([userLat, userLong]);
            map.panTo([userLat, userLong]);
        }
    }

    function hitungJarak(lat1, lon1, lat2, lon2) {
        const R = 6371e3; 
        const φ1 = lat1 * Math.PI/180;
        const φ2 = lat2 * Math.PI/180;
        const Δφ = (lat2-lat1) * Math.PI/180;
        const Δλ = (lon2-lon1) * Math.PI/180;
        const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) + Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ/2) * Math.sin(Δλ/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    }

    /* --- FEATURES: CAMERA --- */
    function startCamera() {
        document.getElementById('btn-open-camera').style.display = 'none';
        document.getElementById('camera-wrapper').style.display = 'block';
        
        // Standard WebRTC
        navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: false })
            .then(stream => {
                streamKamera = stream;
                document.getElementById('video').srcObject = stream;
            })
            .catch(err => {
                console.error(err);
                Swal.fire('Error', 'Gagal akses kamera. Pastikan izin diberikan.', 'error');
                document.getElementById('btn-open-camera').style.display = 'block';
                document.getElementById('camera-wrapper').style.display = 'none';
            });
    }

    function takeSnapshot() {
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        
        // Ensure video dimensions are available
        if (video.videoWidth === 0) return;

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        
        // Draw image (no mirror for data consistency)
        canvas.getContext('2d').drawImage(video, 0, 0);
        
        const dataURL = canvas.toDataURL('image/jpeg', 0.6); // Compression 0.6
        document.getElementById('h_foto').value = dataURL;
        document.getElementById('photo-preview').src = dataURL;
        
        stopCamera();
        
        document.getElementById('camera-wrapper').style.display = 'none';
        document.getElementById('result-wrapper').style.display = 'block';
    }

    function retakePhoto() {
        document.getElementById('result-wrapper').style.display = 'none';
        document.getElementById('h_foto').value = '';
        startCamera();
    }

    function stopCamera() {
        if (streamKamera) {
            streamKamera.getTracks().forEach(t => t.stop());
            streamKamera = null;
        }
    }

    /* --- ACTIONS: SUBMIT --- */
    async function kirimPresensi() {
        const foto = document.getElementById('h_foto').value;
        const materi = document.getElementById('inputMateri').value;
        const lat = document.getElementById('h_lat').value;

        if (!lat || lat == "0") return Swal.fire('Tunggu GPS', 'Lokasi belum ditemukan. Tunggu sebentar.', 'warning');
        if (!foto) return Swal.fire('Foto Wajib', 'Harap ambil foto bukti kehadiran.', 'warning');
        if (!materi) return Swal.fire('Isi Catatan', 'Mohon isi catatan kegiatan.', 'warning');
        
        toggleLoading(true);
        
        // Mapped to Google Apps Script `processForm` payload keys
        const payload = {
            nama_hidden: userData.nama,
            email_hidden: userData.email,
            unit_hidden: userData.unitKerja,
            jabatan_hidden: userData.jabatan,
            lat: lat,
            long: document.getElementById('h_long').value,
            materi: materi,
            lokasi_kegiatan_target: document.getElementById('h_target').value,
            foto_base64: foto
        };
        
        const r = await callAPI('absen', payload);
        toggleLoading(false);
        
        // Check response string from GAS (usually returns "SUKSES: ..." or "GAGAL: ...")
        if (r && typeof r === 'string' && r.includes("SUKSES")) {
            Swal.fire({
                icon: 'success',
                title: 'Berhasil!',
                text: r,
                confirmButtonColor: '#198754'
            });
            resetHomeForm();
            loadRiwayat(); // refresh history if available
        } else {
            Swal.fire('Gagal', r || 'Terjadi kesalahan sistem.', 'error');
        }
    }

    function resetHomeForm() {
        document.getElementById('inputMateri').value = "";
        document.getElementById('h_foto').value = "";
        document.getElementById('result-wrapper').style.display = 'none';
        document.getElementById('btn-open-camera').style.display = 'block';
    }

    async function kirimIzin() {
        const alasan = document.getElementById('izin_alasan').value;
        if (!alasan) return Swal.fire('Wajib', 'Isi keterangan izin.', 'warning');

        toggleLoading(true);
        // Mapped to Google Apps Script `processIzin` payload keys
        const payload = {
            nama_hidden: userData.nama,
            email_hidden: userData.email,
            unit_hidden: userData.unitKerja,
            jabatan_hidden: userData.jabatan,
            jenis_izin: document.getElementById('izin_jenis').value,
            alasan_izin: alasan
        };

        const r = await callAPI('izin', payload);
        toggleLoading(false);

        if (r && typeof r === 'string' && r.includes("SUKSES")) {
            Swal.fire('Terkirim', 'Permohonan izin diajukan.', 'success');
            document.getElementById('formIzin').reset();
        } else {
            Swal.fire('Error', r || 'Gagal mengajukan izin.', 'error');
        }
    }

    /* --- DATA LOADERS --- */
    async function loadRiwayat() {
        toggleLoading(true);
        const list = await callAPI('riwayat', { nama: userData.nama });
        toggleLoading(false);
        
        const container = document.getElementById('listRiwayatContainer');
        if (!list || list.length === 0) {
            container.innerHTML = '<div class="text-center py-5 text-muted small"><i class="fas fa-history fa-2x mb-2 opacity-25"></i><br>Belum ada data riwayat.</div>';
            return;
        }

        let hadirCount = 0;
        let html = '';
        list.forEach(item => {
            let statusClass = 'status-Default';
            let badgeClass = 'bg-secondary';
            
            if (item.status.includes('Tepat')) { statusClass = 'status-Hadir'; badgeClass = 'bg-hadir'; hadirCount++; }
            else if (item.status.includes('Terlambat')) { statusClass = 'status-Telat'; badgeClass = 'bg-telat'; hadirCount++; }
            else if (item.status.includes('Luar')) { statusClass = 'status-Luar'; badgeClass = 'bg-absen'; hadirCount++; }
            else if (item.status.includes('Izin') || item.status.includes('Sakit')) { statusClass = 'status-Izin'; badgeClass = 'bg-izin'; }

            html += `
            <div class="history-card ${statusClass}">
                <div class="d-flex justify-content-between">
                    <span class="fw-bold small">${item.tanggal}</span>
                    <span class="badge ${badgeClass} text-dark border badge-status">${item.status}</span>
                </div>
                <div class="d-flex align-items-center gap-2 mt-1">
                    <i class="fas fa-clock text-muted small"></i>
                    <span class="small text-muted flex-grow-1">${item.jam}</span>
                    ${item.foto && item.foto.length > 10 ? `<button onclick="viewImage('${item.foto}')" class="btn btn-sm btn-outline-secondary rounded-pill px-3 py-0" style="font-size:0.7rem;">Bukti</button>` : ''}
                </div>
            </div>`;
        });

        container.innerHTML = html;
        document.getElementById('statHadir').innerText = hadirCount;
        // Asumsi hari kerja efektif 25 hari
        const persen = Math.min(100, Math.round((hadirCount / 25) * 100));
        document.getElementById('statPersen').innerText = persen + '%';
    }

    async function loadMonitoring() {
        toggleLoading(true);
        // Assuming doPost maps `sekolah` to `namaSekolahInput` for `getMonitoringSekolah`
        const data = await callAPI('monitoring', { sekolah: userData.unitKerja });
        toggleLoading(false);

        const container = document.getElementById('listMonitoringContainer');
        if (!data) return;
        
        const all = [...data.listSudah, ...data.listBelum];
        if (all.length === 0) {
            container.innerHTML = '<div class="text-center py-4 text-muted">Tidak ada data.</div>';
            return;
        }

        let html = '';
        all.forEach(g => {
            let badge = 'bg-light text-muted';
            let actions = '';
            let opacity = '1';
            
            if (g.status === 'Belum Hadir') {
                badge = 'bg-danger bg-opacity-10 text-danger';
                opacity = '0.8';
            }
            else if (g.status.includes('Tepat')) badge = 'bg-success bg-opacity-10 text-success';
            else if (g.status.includes('Izin') || g.status.includes('Sakit')) {
                badge = 'bg-primary bg-opacity-10 text-primary';
                if (g.status.includes('Menunggu')) {
                    actions = `
                    <div class="mt-2 pt-2 border-top d-flex gap-2 justify-content-end">
                        <button onclick="updateIzin('${g.nama}', 'Disetujui')" class="btn btn-sm btn-success flex-grow-1"><i class="fas fa-check"></i> Terima</button>
                        <button onclick="updateIzin('${g.nama}', 'Ditolak')" class="btn btn-sm btn-danger flex-grow-1"><i class="fas fa-times"></i> Tolak</button>
                    </div>`;
                }
            }

            html += `
            <div class="card-custom p-3 mb-2" style="opacity:${opacity}">
                <div class="d-flex justify-content-between align-items-start mb-1">
                    <h6 class="fw-bold m-0 text-truncate" style="max-width: 60%; font-size: 0.9rem;">${g.nama}</h6>
                    <span class="badge ${badge} border rounded-pill fw-normal" style="font-size:0.65rem;">${g.status}</span>
                </div>
                <div class="small text-muted mb-1"><i class="far fa-clock me-1"></i> ${g.jam}</div>
                ${g.alasan ? `<div class="alert alert-light border p-2 mb-1 small text-dark fst-italic py-1 px-2" style="font-size:0.8rem;"><i class="fas fa-quote-left me-1 text-secondary"></i> ${g.alasan}</div>` : ''}
                ${g.foto && g.foto.length > 10 ? `<button onclick="viewImage('${g.foto}')" class="btn btn-sm btn-light w-100 border rounded-pill mt-2 py-1" style="font-size:0.8rem;">Lihat Foto</button>` : ''}
                ${actions}
            </div>`;
        });
        container.innerHTML = html;
    }

    /* --- ADMIN SETTINGS --- */
    async function loadSettings() {
        toggleLoading(true);
        const d = await callAPI('getSettings');
        toggleLoading(false);
        
        if (d) {
            const sel = document.getElementById('set_lokasi');
            sel.innerHTML = '';
            if (d.listSekolah && d.listSekolah.length > 0) {
                d.listSekolah.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s; opt.innerText = s;
                    if (s === d.nama) opt.selected = true; // d.nama from getTargetLokasi or d.namaLokasi from getSettingData
                    sel.appendChild(opt);
                });
            } else {
                 const opt = document.createElement('option');
                 opt.value = d.nama; opt.innerText = d.nama;
                 sel.appendChild(opt);
            }
            
            document.getElementById('set_info').value = d.info;
            document.getElementById('set_mulai').value = d.jamMulai;
            document.getElementById('set_selesai').value = d.jamSelesai;
            document.getElementById('set_batas').value = d.jamBatas;
        }
    }

    function simpanSettings() {
        Swal.fire({
            title: 'Simpan?',
            text: "Perubahan akan berdampak pada semua user.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#B3261E'
        }).then(async (res) => {
            if (res.isConfirmed) {
                toggleLoading(true);
                const payload = {
                    set_lokasi: document.getElementById('set_lokasi').value,
                    set_info: document.getElementById('set_info').value,
                    set_mulai: document.getElementById('set_mulai').value,
                    set_selesai: document.getElementById('set_selesai').value,
                    set_batas: document.getElementById('set_batas').value
                };
                const status = await callAPI('saveSettings', payload);
                toggleLoading(false);
                if (status === "SUKSES") {
                    Swal.fire('Tersimpan', '', 'success');
                    // Refresh local target if admin is user
                    callAPI('getLokasi').then(loc => setupTarget(loc));
                } else {
                    Swal.fire('Gagal', status, 'error');
                }
            }
        });
    }

    async function updateIzin(nama, status) {
        toggleLoading(true);
        const res = await callAPI('updateIzin', { nama: nama, status: status });
        toggleLoading(false);
        if (res === 'SUKSES') {
            loadMonitoring();
            Swal.fire('Berhasil', `Izin ${status}`, 'success');
        } else {
            Swal.fire('Gagal', res, 'error');
        }
    }

    /* --- UTILS --- */
    function toggleLoading(show) {
        document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
    }

    function viewImage(url) {
        Swal.fire({
            imageUrl: url,
            imageWidth: 400,
            imageAlt: 'Bukti',
            showConfirmButton: false,
            showCloseButton: true,
            confirmButtonText: 'Tutup'
        });
    }
</script>

</body>
</html>
