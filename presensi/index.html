<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Presensi Mobile</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    /* CSS STYLE UTAMA */
    :root {
      --md-primary: #B3261E; --md-on-primary: #FFFFFF;
      --md-primary-container: #FFDAD6; --md-surface: #FFF8F7;
      --md-text-main: #201A1A; --md-text-sub: #534341;
      --shape-card: 24px; --shape-pill: 50px;
    }
    
    body { background-color: var(--md-surface); font-family: 'Roboto', sans-serif; padding-bottom: 120px; color: var(--md-text-main); overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
    h1, h2, h3, h4, h5, .fw-google { font-family: 'Google Sans', sans-serif; }
    
    /* LOGIN */
    #login-page { height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(180deg, var(--md-surface) 0%, var(--md-primary-container) 100%); position: fixed; top: 0; left: 0; width: 100%; z-index: 2000; }
    .login-card { width: 85%; max-width: 360px; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border-radius: 28px; padding: 40px 24px; box-shadow: 0 10px 30px rgba(179, 38, 30, 0.1); border: 1px solid white; }
    .form-control-pin { background: var(--md-surface); border: none; border-bottom: 2px solid #857372; border-radius: 12px 12px 0 0; font-size: 1.8rem; letter-spacing: 12px; color: var(--md-primary); text-align: center; }

    /* HEADER APP */
    #app-page { display: none; }
    .header-app { background-color: var(--md-surface); padding: 20px 24px 10px 24px; border-radius: 0 0 32px 32px; }
    .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .profile-section h5 { font-size: 1.4rem; font-weight: 500; margin: 0; }
    .profile-section .jabatan { font-size: 0.9rem; color: var(--md-text-sub); margin-top: 2px; }
    .btn-logout-header { background: var(--md-primary-container); border:none; width: 42px; height: 42px; border-radius: 14px; display: flex; align-items: center; justify-content: center; color: #410002; }
    
    /* CHIPS INFO */
    .chip-info { font-size: 0.75rem; font-weight: 500; padding: 6px 14px; border-radius: 16px; display: inline-flex; align-items: center; gap: 6px; }
    .chip-unit { background: var(--md-primary); color: white; }
    .chip-time { background: #FCEAE9; color: var(--md-text-sub); border: 1px solid #eee; }
    #infoBar { background: #FFF2F1; border: 1px solid #FFDAD6; color: #410E0B; border-radius: 16px; padding: 10px 16px; margin-top: 16px; font-size: 0.85rem; display:none; }

    /* CARDS */
    .card-menu { border: none; border-radius: var(--shape-card); box-shadow: 0 2px 12px rgba(0,0,0,0.03); margin-bottom: 16px; background: white; padding: 16px; }
    .label-header { font-family: 'Google Sans'; font-weight: 600; font-size: 0.9rem; color: var(--md-primary); margin-bottom: 12px; display: block; }
    .form-control, .form-select { background-color: #FCEAE9; border: 1px solid transparent; border-radius: 12px; padding: 12px 16px; }
    .btn-google { background-color: var(--md-primary); color: white; border: none; border-radius: var(--shape-pill); font-family: 'Google Sans'; font-weight: 500; height: 50px; width: 100%; }

    /* MAPS & CAMERA */
    #mapContainer { display: none; margin-top: 10px; }
    #map { height: 180px; width: 100%; border-radius: 20px; border: 2px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    
    .modal-camera { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 5000; display: none; flex-direction: column; }
    .camera-view { flex: 1; position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center; }
    #video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
    .camera-controls { height: 120px; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; position: relative; }
    .btn-shutter { width: 70px; height: 70px; background: white; border-radius: 50%; border: 4px solid rgba(255,255,255,0.3); outline: 3px solid var(--md-primary); cursor: pointer; }
    .btn-close-camera { position: absolute; top: 20px; right: 20px; color: white; background: rgba(0,0,0,0.5); padding: 8px 16px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.3); z-index: 5001; }
    #result-container { display: none; margin-top: 10px; }
    #photo-preview { width: 100%; height: 250px; object-fit: cover; border-radius: 16px; margin-bottom: 10px; border: 1px solid #eee; }

    /* LIST MONITORING ITEMS */
    .history-item { padding: 16px; margin-bottom: 12px; background: #FFFFFF; border-radius: 20px; border: 1px solid #F0F0F0; }
    .badge-status { font-family: 'Google Sans'; font-size: 0.75rem; padding: 6px 12px; border-radius: 8px; font-weight: 600; }
    
    /* WARNA BADGE */
    .bg-hadir { background: #C4EED0; color: #074E23; } 
    .bg-telat { background: #FFEFBF; color: #765600; } 
    .bg-luar { background: #FFDAD6; color: #410E0B; } 
    .bg-izin { background: #D3E3FD; color: #041E49; } 
    .bg-belum { background: #FFDAD6; color: #410E0B; }
    
    /* TOMBOL BUKTI & ACC */
    .btn-view-foto-pill { background: #FCEAE9; color: #534341; border: none; padding: 6px 14px; border-radius: 50px; font-size: 0.75rem; display: inline-flex; align-items: center; font-weight: 500; text-decoration: none; transition: 0.2s; margin-right: 5px; }
    
    /* STYLE KHUSUS TOMBOL ACC/TOLAK */
    .action-btn { width: 40px; height: 40px; border-radius: 50%; display: flex; justify-content: center; align-items: center; border: none; font-size: 1rem; margin-left: 8px; transition: transform 0.1s; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .action-btn:active { transform: scale(0.9); }
    .btn-acc { background: #C4EED0; color: #074E23; } 
    .btn-rej { background: #FFDAD6; color: #410E0B; }

    /* NAVIGASI BAWAH */
    .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: #FFFFFF; height: 80px; padding: 0 16px 10px 16px; z-index: 1000; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #F0F0F0; box-shadow: 0 -4px 20px rgba(0,0,0,0.02); }
    .nav-item-c { text-align: center; color: var(--md-text-sub); cursor: pointer; flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px; padding-top: 12px; }
    .nav-icon-container { width: 64px; height: 32px; border-radius: 16px; display: flex; align-items: center; justify-content: center; transition: 0.3s; margin-bottom: 2px; }
    .nav-item-c.active .nav-icon-container { background-color: var(--md-primary-container); width: 50px; }
    .nav-item-c.active i { color: #410E0B; }
    
    .loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,248,246,0.9); backdrop-filter:blur(5px); z-index: 9999; display: flex; flex-direction: column; justify-content:center; align-items:center; display:none; }
    .submit-wrapper { position: fixed; bottom: 80px; left: 0; width: 100%; padding: 12px 24px; background: rgba(255,255,255,0.95); backdrop-filter: blur(8px); border-top: 1px solid #eee; z-index: 990; display: flex; }
  </style>
</head>
<body>

  <div id="loadingOverlay" class="loading-overlay">
    <div class="spinner-border text-danger mb-3" style="width: 3rem; height: 3rem;" role="status"></div>
    <div class="fw-google" style="color:var(--md-primary);">Memproses...</div>
  </div>

  <div id="login-page">
    <div class="login-card text-center">
      <div class="bg-danger bg-opacity-10 rounded-circle d-inline-flex p-3 mb-3"><i class="fas fa-school fa-2x text-danger"></i></div>
      <h2 class="fw-google mb-1">Gugus Nakula</h2>
      <p class="text-secondary small mb-4">Sistem Presensi Terintegrasi</p>
      <div class="mb-5 text-start">
        <label class="small fw-bold ms-1 mb-2 text-danger">MASUKKAN PIN</label>
        <input type="password" id="inputPin" class="form-control form-control-pin" placeholder="• • • • • •" inputmode="numeric">
      </div>
      <button onclick="doLogin()" class="btn btn-google shadow-none">MASUK <i class="fas fa-arrow-right ms-2"></i></button>
    </div>
  </div>

  <div id="app-page">
    
    <div class="header-app">
      <div class="header-top">
        <div class="profile-section">
          <div class="jabatan" id="dispJabatan">Guru</div>
          <h5 id="dispNama">Nama Guru</h5>
        </div>
        <button onclick="doLogout()" class="btn-logout-header"><i class="fas fa-power-off"></i></button>
      </div>
      <div class="d-flex gap-2 flex-wrap">
          <span id="dispUnit" class="chip-info chip-unit">Unit Kerja</span>
          <div class="chip-info chip-time">
             <span id="labelJamMulai">06:00</span><span style="opacity:0.3">|</span><span id="labelJamTutup">14:00</span>
          </div>
      </div>
      <div id="infoBar"><i class="fas fa-bullhorn me-2 text-danger"></i><marquee id="textInfo">Selamat Datang</marquee></div>
    </div>

    <div class="container pt-3 pb-5 mb-5 px-3">
      
      <div id="view-home" class="view-section">
          <div class="card card-menu py-3">
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <div class="bg-danger bg-opacity-10 p-2 rounded-circle me-3 text-danger"><i class="fas fa-map-marker-alt"></i></div>
                    <div>
                        <span class="d-block fw-bold" style="font-size:0.9rem;">Lokasi Anda</span>
                        <div id="lokasiStatusText" class="small text-muted" style="font-size:0.75rem;">Mencari...</div>
                    </div>
                </div>
                <span id="badgeJarak" class="badge bg-light text-secondary rounded-pill border">Cek GPS...</span>
            </div>
            <div class="text-end mt-1"><button class="btn btn-sm btn-link text-decoration-none text-muted" onclick="toggleMap()"><i class="fas fa-chevron-down me-1"></i>Peta</button></div>
            <div id="mapContainer">
                <div id="map"></div>
                <div class="d-flex justify-content-between align-items-center mt-2">
                    <div class="small text-secondary"><i class="fas fa-crosshairs me-1"></i>Target: <strong id="dispLokasiTarget">...</strong></div>
                    <button type="button" onclick="startGPS()" class="btn btn-sm btn-light text-danger rounded-circle shadow-sm"><i class="fas fa-sync-alt"></i></button>
                </div>
            </div>
          </div>

          <div class="card card-menu">
             <div class="d-flex justify-content-between align-items-center mb-3"><span class="label-header mb-0"><i class="fas fa-camera me-2"></i>Bukti Kehadiran</span></div>
             <div id="camera-btn-start" onclick="openCameraModal()" class="text-center py-4 bg-light rounded-3 border border-1 border-dashed" style="cursor:pointer; border-color: #d0d0d0 !important;">
                <div class="bg-white p-3 rounded-circle shadow-sm d-inline-block mb-2"><i class="fas fa-camera fa-2x text-danger"></i></div>
                <div class="small fw-bold text-secondary">Ketuk untuk Buka Kamera</div>
             </div>
             <div id="result-container">
                <img id="photo-preview" class="shadow-sm">
                <button type="button" class="btn btn-light text-danger w-100 fw-bold py-2 rounded-pill border" onclick="openCameraModal()"><i class="fas fa-redo me-2"></i>Foto Ulang</button>
             </div>
             <input type="hidden" id="foto_base64" name="foto_base64">
          </div>

          <div class="card card-menu mb-4">
            <span class="label-header">Catatan Kegiatan</span>
            <textarea name="materi" class="form-control bg-light border-0" rows="2" placeholder="Ringkasan kegiatan..." required></textarea>
            <input type="hidden" id="p_nama"><input type="hidden" id="p_email"><input type="hidden" id="p_unit"><input type="hidden" id="p_jabatan">
            <input type="hidden" id="lat"><input type="hidden" id="long"><input type="hidden" id="lokasi_target_nama">
          </div>
          
          <div class="submit-wrapper">
              <button type="button" onclick="kirimPresensi()" class="btn btn-google shadow-sm"><i class="fas fa-paper-plane me-2"></i> KIRIM PRESENSI</button>
          </div>
      </div>

      <div id="view-izin" class="view-section" style="display:none;">
         <div class="card card-menu">
            <h5 class="fw-google fw-bold text-danger mb-1">Pengajuan Izin</h5>
            <p class="text-muted small mb-4">Pilih kategori yang sesuai.</p>
            <form id="formIzin">
               <div class="mb-3">
                 <label class="label-header small text-muted">Kategori Izin</label>
                 <select name="jenis_izin" id="selectJenisIzin" class="form-select py-3"><option value="">-- Memuat Opsi... --</option></select>
               </div>
               <div class="mb-4">
                 <label class="label-header small text-muted">Keterangan Detail</label>
                 <textarea name="alasan_izin" class="form-control p-3" rows="4" placeholder="Jelaskan alasan detail..."></textarea>
               </div>
               <button type="button" onclick="kirimIzin()" class="btn btn-google w-100 fw-bold py-3">AJUKAN PERMOHONAN</button>
            </form>
         </div>
      </div>

      <div id="view-riwayat" class="view-section" style="display:none;">
         <div class="d-flex justify-content-between align-items-center mb-3">
             <h6 class="fw-bold m-0 text-dark">Riwayat Saya</h6>
         </div>
         
         <div class="card card-menu p-3 mb-3">
            <div class="row g-2">
                <div class="col-5">
                    <select id="riw_bulan" class="form-select form-select-sm">
                        <option value="">Bulan...</option>
                        <option value="1">Januari</option><option value="2">Februari</option>
                        <option value="3">Maret</option><option value="4">April</option>
                        <option value="5">Mei</option><option value="6">Juni</option>
                        <option value="7">Juli</option><option value="8">Agustus</option>
                        <option value="9">September</option><option value="10">Oktober</option>
                        <option value="11">November</option><option value="12">Desember</option>
                    </select>
                </div>
                <div class="col-4">
                    <input type="number" id="riw_tahun" class="form-control form-control-sm" placeholder="Tahun">
                </div>
                <div class="col-3">
                    <button class="btn btn-sm btn-danger w-100" onclick="loadRiwayat()"><i class="fas fa-search"></i></button>
                </div>
            </div>
         </div>
         
         <div id="listRiwayatContainer"></div>
      </div>
      
      <div id="view-monitoring" class="view-section" style="display:none;">
         <div class="d-flex justify-content-between align-items-center mb-3">
             <h6 class="fw-bold m-0 text-dark">Monitoring Guru</h6>
             <button class="btn btn-sm btn-light text-danger rounded-pill fw-bold" onclick="loadMonitoring()">Refresh</button>
         </div>
         <div id="listMonitoringContainer"></div>
      </div>

      <div id="view-setting" class="view-section" style="display:none;">
         <div class="card card-menu">
            <h5 class="fw-bold text-danger mb-4">Pengaturan Sistem</h5>
            <div class="mb-3"><label class="label-header">Lokasi Target</label><select id="set_lokasi" class="form-select"></select></div>
            <div class="mb-3"><label class="label-header">Info Running Text</label><textarea id="set_info" class="form-control" rows="2"></textarea></div>
            <div class="row g-2 mb-3">
                <div class="col-4"><label>Mulai</label><input type="time" id="set_mulai" class="form-control"></div>
                <div class="col-4"><label>Selesai</label><input type="time" id="set_selesai" class="form-control"></div>
                <div class="col-4"><label>Batas</label><input type="time" id="set_batas" class="form-control border-danger"></div>
            </div>
            <button onclick="simpanSettings()" class="btn btn-google w-100">SIMPAN</button>
         </div>
      </div>
    </div>
  </div>

  <div class="bottom-nav" id="bottomNav" style="display:none;">
     <div class="nav-item-c active" onclick="switchView('home', this)"><div class="nav-icon-container"><i class="fas fa-home"></i></div><span>Absen</span></div>
     <div class="nav-item-c" onclick="switchView('izin', this)"><div class="nav-icon-container"><i class="fas fa-envelope-open-text"></i></div><span>Izin</span></div>
     <div class="nav-item-c" onclick="switchView('riwayat', this)"><div class="nav-icon-container"><i class="fas fa-history"></i></div><span>Riwayat</span></div>
     <div class="nav-item-c" id="navMonitor" style="display:none;" onclick="switchView('monitoring', this)"><div class="nav-icon-container"><i class="fas fa-users"></i></div><span>Monitor</span></div>
     <div class="nav-item-c" id="navSetting" style="display:none;" onclick="switchView('setting', this)"><div class="nav-icon-container"><i class="fas fa-sliders-h"></i></div><span>Admin</span></div>
  </div>

  <div id="cameraModal" class="modal-camera">
      <button class="btn-close-camera" onclick="closeCameraModal()"><i class="fas fa-times me-2"></i>Tutup</button>
      <div class="camera-view"><video id="video" autoplay playsinline></video></div>
      <div class="camera-controls"><div class="btn-shutter" onclick="takeSnapshot()"></div></div>
  </div>
  <canvas id="canvas" style="display:none;"></canvas>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <script>
    // --- WAJIB: DEPLOY ULANG DAN GANTI URL INI ---
    const API_URL = "https://script.google.com/macros/s/AKfycbweTTiW0sPe1SAnJZlUK4KCiiks4cDhc420PWmvf1IOJ7mIKGUhudz42SpAJ1KZP4__cg/exec"; 

    var userData = null; var targetLokasi = null;
    var userLat = 0, userLong = 0; var map, marker, streamKamera;

    async function callAPI(action, data = {}) {
        data.action = action;
        try {
            const response = await fetch(API_URL, { 
                method: "POST", 
                redirect: "follow", 
                headers: { "Content-Type": "text/plain;charset=utf-8" },
                body: JSON.stringify(data) 
            });
            return await response.json();
        } catch (error) { 
            console.error("Fetch Error:", error); 
            Swal.fire('Error', 'Koneksi gagal.', 'error'); 
            return null; 
        }
    }

    window.onload = function() {
      var savedUser = localStorage.getItem('gugusUser');
      if (savedUser) { userData = JSON.parse(savedUser); initApp(); }
    };

    async function doLogin() {
      var pin = document.getElementById('inputPin').value;
      if (!pin) return Swal.fire('Error', 'PIN Kosong', 'error');
      document.getElementById('loadingOverlay').style.display = 'flex';
      const res = await callAPI('login', { pin: pin });
      document.getElementById('loadingOverlay').style.display = 'none';
      if (res && res.status === 'SUKSES') {
          userData = res;
          localStorage.setItem('gugusUser', JSON.stringify(userData));
          initApp(res.targetLokasi);
      } else { Swal.fire('Gagal', 'PIN Salah / Tidak Ditemukan', 'error'); }
    }

    async function initApp(targetBaru) {
       document.getElementById('login-page').style.display = 'none';
       document.getElementById('app-page').style.display = 'block';
       document.getElementById('bottomNav').style.display = 'flex';
       
       document.getElementById('dispNama').innerText = userData.nama;
       document.getElementById('dispUnit').innerText = userData.unitKerja;
       document.getElementById('dispJabatan').innerText = userData.jabatan || "Guru";

       if(userData.isAdmin || (userData.jabatan && userData.jabatan.toString().toLowerCase().includes("kepala"))) {
           document.getElementById('navMonitor').style.display = 'flex';
       }
       if(userData.isAdmin) { document.getElementById('navSetting').style.display = 'flex'; }

       document.getElementById('p_nama').value = userData.nama;
       document.getElementById('p_email').value = userData.email;
       document.getElementById('p_unit').value = userData.unitKerja;
       document.getElementById('p_jabatan').value = userData.jabatan;

       if(targetBaru) setupTarget(targetBaru);
       else { const loc = await callAPI('getLokasi'); if(loc) setupTarget(loc); }
    }

    function setupTarget(res) {
       targetLokasi = res;
       document.getElementById('lokasi_target_nama').value = res.nama;
       document.getElementById('dispLokasiTarget').innerText = res.nama;
       document.getElementById('labelJamMulai').innerText = res.jamMulai;
       document.getElementById('labelJamTutup').innerText = res.jamSelesai;
       if(res.info && res.info !== "-") {
          document.getElementById('infoBar').style.display = 'block';
          document.getElementById('textInfo').innerText = res.info;
       }
       var sel = document.getElementById('selectJenisIzin');
       if (res.listOpsiIzin && res.listOpsiIzin.length > 0) {
           sel.innerHTML = '<option value="">-- Pilih Kategori --</option>';
           res.listOpsiIzin.forEach(opsi => { var opt = document.createElement('option'); opt.value = opsi; opt.innerText = opsi; sel.appendChild(opt); });
       } else {
           sel.innerHTML = '<option value="">-- Pilih Kategori --</option><option>Izin Pribadi</option><option>Sakit</option><option>Dinas Luar</option>';
       }
       startGPS();
    }

    function switchView(viewName, el) {
       if(streamKamera) closeCameraModal();
       document.querySelectorAll('.view-section').forEach(v => v.style.display = 'none');
       document.getElementById('view-' + viewName).style.display = 'block';
       document.querySelectorAll('.nav-item-c').forEach(n => n.classList.remove('active'));
       if(el) el.classList.add('active');
       
       if(viewName === 'home') document.querySelector('.submit-wrapper').style.display = 'flex';
       else document.querySelector('.submit-wrapper').style.display = 'none';

       if(viewName === 'riwayat') loadRiwayat();
       if(viewName === 'monitoring') loadMonitoring();
       if(viewName === 'setting') loadSettings();
    }

    function toggleMap() {
        var c = document.getElementById('mapContainer');
        c.style.display = (c.style.display === 'none' || c.style.display === '') ? 'block' : 'none';
        if(c.style.display === 'block' && map) map.invalidateSize();
    }
    function startGPS() { if (navigator.geolocation) navigator.geolocation.watchPosition(updatePos, null, {enableHighAccuracy:true}); }
    function updatePos(pos) {
       userLat = pos.coords.latitude; userLong = pos.coords.longitude;
       document.getElementById('lat').value = userLat; document.getElementById('long').value = userLong;
       document.getElementById('lokasiStatusText').innerText = userLat.toFixed(5) + ", " + userLong.toFixed(5);
       if(!targetLokasi) return;
       var dist = hitungJarak(userLat, userLong, targetLokasi.lat, targetLokasi.long);
       if (dist <= targetLokasi.radius) {
          document.getElementById('badgeJarak').className = "badge bg-success rounded-pill"; 
          document.getElementById('badgeJarak').innerHTML = "<i class='fas fa-check-circle me-1'></i>Aman";
       } else {
          document.getElementById('badgeJarak').className = "badge bg-danger rounded-pill"; 
          document.getElementById('badgeJarak').innerHTML = "Luar Radius ("+Math.round(dist)+"m)";
       }
       if (!map) { 
           map = L.map('map', {zoomControl:false}).setView([userLat, userLong], 15); 
           L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map); 
           marker = L.marker([userLat, userLong]).addTo(map); 
           if(targetLokasi.lat) L.circle([targetLokasi.lat, targetLokasi.long], {color:'red', radius:targetLokasi.radius}).addTo(map); 
       } else { marker.setLatLng([userLat, userLong]); map.setView([userLat, userLong]); }
    }
    function hitungJarak(lat1, lon1, lat2, lon2) { 
        var R = 6371e3; var p = Math.PI/180;
        var a = 0.5 - Math.cos((lat2-lat1)*p)/2 + Math.cos(lat1*p)*Math.cos(lat2*p) * (1-Math.cos((lon2-lon1)*p))/2;
        return 2 * R * Math.asin(Math.sqrt(a));
    }

    function openCameraModal() {
        document.getElementById('cameraModal').style.display = 'flex';
        navigator.mediaDevices.getUserMedia({video:{facingMode:"user"}}).then(s => { 
            streamKamera = s; document.getElementById('video').srcObject = s; 
        }).catch(e => { Swal.fire('Error', 'Kamera tidak dapat diakses', 'error'); closeCameraModal(); });
    }
    function closeCameraModal() {
        if(streamKamera) { streamKamera.getTracks().forEach(t => t.stop()); streamKamera = null; }
        document.getElementById('cameraModal').style.display='none'; 
    }
    
    // UPDATE: TOAST 3 DETIK & TOMBOL OK
    function takeSnapshot() { 
        var v = document.getElementById('video'); 
        var c = document.getElementById('canvas'); 
        if (v.videoWidth === 0 || v.videoHeight === 0) {
            return Swal.fire('Gagal', 'Tunggu kamera loading sebentar...', 'warning');
        }
        c.width = v.videoWidth; c.height = v.videoHeight; 
        c.getContext('2d').drawImage(v, 0, 0); 
        var d = c.toDataURL('image/jpeg', 0.7); 
        document.getElementById('foto_base64').value = d; 
        document.getElementById('photo-preview').src = d; 
        
        closeCameraModal();
        document.getElementById('camera-btn-start').style.display = 'none'; 
        document.getElementById('result-container').style.display = 'block'; 

        Swal.fire({
            icon: 'success', title: 'Foto Tersimpan!', text: 'Silakan lanjut isi catatan & kirim.',
            timer: 3000, showConfirmButton: true
        });
    }

    // UPDATE: RELOAD HANYA SETELAH KLIK OK
    async function kirimPresensi() {
       if(!document.getElementById('foto_base64').value) return Swal.fire('Foto Wajib', 'Ambil foto selfie dulu.', 'warning');
       document.getElementById('loadingOverlay').style.display = 'flex';
       
       var payload = { 
           nama: document.getElementById('p_nama').value, email: document.getElementById('p_email').value, 
           unit: document.getElementById('p_unit').value, jabatan: document.getElementById('p_jabatan').value, 
           lat: document.getElementById('lat').value, long: document.getElementById('long').value, 
           materi: document.querySelector('[name="materi"]').value, lokasi_target: document.getElementById('lokasi_target_nama').value, 
           foto: document.getElementById('foto_base64').value 
       };
       const r = await callAPI('absen', payload);
       document.getElementById('loadingOverlay').style.display = 'none';
       
       Swal.fire({
           title: r.includes("SUKSES") ? "Berhasil" : "Gagal", text: r, icon: r.includes("SUKSES") ? "success" : "error",
           confirmButtonText: "OK", allowOutsideClick: false
       }).then((result) => {
           if (result.isConfirmed && r.includes("SUKSES")) location.reload();
       });
    }

    async function kirimIzin() {
       var j = document.getElementById('selectJenisIzin').value;
       if(!j) return Swal.fire('Pilih Kategori', 'Harap pilih jenis izin.', 'warning');
       document.getElementById('loadingOverlay').style.display = 'flex';
       var payload = { 
           nama: userData.nama, email: userData.email, unit: userData.unitKerja, jabatan: userData.jabatan,
           jenis: j, alasan: document.querySelector('[name="alasan_izin"]').value 
       };
       const r = await callAPI('izin', payload);
       document.getElementById('loadingOverlay').style.display = 'none';
       Swal.fire(r.includes("SUKSES")?"Terkirim":"Gagal", r, r.includes("SUKSES")?"success":"error");
       if(r.includes("SUKSES")) { document.getElementById('formIzin').reset(); switchView('home'); }
    }

    // UPDATE: FILTER BULAN & TAHUN
    async function loadRiwayat() {
       document.getElementById('loadingOverlay').style.display = 'flex';
       var bln = document.getElementById('riw_bulan').value;
       var thn = document.getElementById('riw_tahun').value;
       if(!thn) { thn = new Date().getFullYear(); document.getElementById('riw_tahun').value = thn; }

       const list = await callAPI('riwayat', { nama: userData.nama, bulan: bln, tahun: thn });
       document.getElementById('loadingOverlay').style.display = 'none';
       var html = "";
       if(list && list.length > 0) {
          list.forEach(i => {
             var cls = i.status.includes("Tepat")?"bg-hadir":i.status.includes("Terlambat")?"bg-telat":i.status.includes("Luar")?"bg-luar":"bg-izin";
             var btnFoto = ""; if(i.foto && i.foto.includes("http")) btnFoto = `<button class="btn-view-foto-pill" onclick="lihatFoto(event, '${i.foto}')"><i class="fas fa-image me-1"></i>Bukti</button>`;
             html += `<div class="history-item"><div class="d-flex justify-content-between mb-2"><span class="fw-bold small">${i.tanggal}</span><span class="badge badge-status ${cls}">${i.status}</span></div><div class="d-flex justify-content-between align-items-center"><div class="small text-muted"><i class="fas fa-clock me-1"></i> ${i.jam} - ${i.lokasi}</div>${btnFoto}</div></div>`;
          });
       } else { html = "<div class='text-center py-5 text-muted'>Tidak ada data pada periode ini.</div>"; }
       document.getElementById('listRiwayatContainer').innerHTML = html;
    }

    async function loadMonitoring() {
        document.getElementById('loadingOverlay').style.display = 'flex';
        const d = await callAPI('monitoring', { sekolah: userData.unitKerja });
        if(d) renderMonitoring(d);
    }

    function renderMonitoring(data) {
        document.getElementById('loadingOverlay').style.display = 'none';
        var html = ""; var allGuru = data.listSudah.concat(data.listBelum);
        if(allGuru.length === 0) { document.getElementById('listMonitoringContainer').innerHTML = "<div class='text-center py-5 text-muted'>Tidak ada data.</div>"; return; }
        
        allGuru.forEach(g => {
            var badgeClass = "bg-secondary"; var actionButtons = ""; var btnBukti = ""; var safeNama = g.nama.replace(/'/g, "\\'");
            
            if(g.status === "Belum Hadir") badgeClass = "bg-belum";
            else if(g.status.includes("Tepat")) badgeClass = "bg-hadir";
            else if(g.status.includes("Terlambat")) badgeClass = "bg-telat";
            else if(g.status.includes("Luar")) badgeClass = "bg-luar";
            else if(g.status.includes("Izin") || g.status.includes("Sakit")) { 
                badgeClass = "bg-izin"; 
                if(g.status.includes("Menunggu")) { 
                    actionButtons = `
                    <div class="mt-2 d-flex justify-content-end border-top pt-2">
                        <small class="me-auto text-muted d-flex align-items-center fst-italic">Setujui izin ini?</small>
                        <button type="button" class="action-btn btn-acc me-2" onclick="prosesIzin('${safeNama}', 'Disetujui')"><i class="fas fa-check"></i></button>
                        <button type="button" class="action-btn btn-rej" onclick="prosesIzin('${safeNama}', 'Ditolak')"><i class="fas fa-times"></i></button>
                    </div>`; 
                }
            }
            if(g.maps && g.maps.includes("http")) btnBukti += `<a href="${g.maps}" target="_blank" class="btn-view-foto-pill me-1" style="text-decoration:none;"><i class="fas fa-map-marker-alt text-danger"></i></a>`; 
            if(g.foto && g.foto.includes("http")) btnBukti += `<button type="button" class="btn-view-foto-pill" onclick="lihatFoto(event, '${g.foto}')"><i class="fas fa-image text-primary"></i></button>`; 

            html += `
            <div class="history-item">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <span class="fw-bold text-dark text-truncate" style="max-width:55%; font-family:'Google Sans'">${g.nama}</span>
                    <span class="badge badge-status ${badgeClass}">${g.status}</span>
                </div>
                <div class="d-flex align-items-center mt-2">
                    <div class="small text-muted flex-grow-1" style="line-height:1.4;">
                        <i class="fas fa-clock me-1 text-secondary opacity-50"></i> ${g.jam} 
                        ${g.alasan ? '<br><span class="text-warning"><i class="fas fa-comment-alt me-1"></i> ' + g.alasan + '</span>' : ''}
                    </div>
                    <div class="d-flex align-items-center">${btnBukti}</div>
                </div>
                ${actionButtons}
            </div>`;
        });
        document.getElementById('listMonitoringContainer').innerHTML = html;
    }

    function prosesIzin(namaGuru, newStatus) {
        Swal.fire({ title: 'Konfirmasi', text: newStatus + ' izin ' + namaGuru + '?', icon: 'question', showCancelButton: true, confirmButtonColor: '#B3261E', confirmButtonText: 'Ya' }).then(async (result) => {
            if (result.isConfirmed) {
                document.getElementById('loadingOverlay').style.display = 'flex';
                const res = await callAPI('updateIzin', { nama: namaGuru, status: newStatus });
                document.getElementById('loadingOverlay').style.display = 'none';
                if(res.includes('SUKSES')) { await loadMonitoring(); Swal.fire('Selesai','Data diperbarui','success'); } else { Swal.fire('Gagal', res, 'error'); }
            }
        });
    }

    function lihatFoto(e, url) { if(e) { e.stopPropagation(); e.preventDefault(); } Swal.fire({ imageUrl: url, imageAlt: 'Foto Bukti', showConfirmButton: false, showCloseButton: true, background: '#fff', imageHeight: 'auto', imageWidth: '100%', customClass: {popup: 'rounded-4', image: 'rounded-4 shadow-sm'} }); }

    async function loadSettings() {
        const d = await callAPI('getSettings');
        if(d) {
             var sel = document.getElementById('set_lokasi'); sel.innerHTML = "";
             d.listSekolah.forEach(s => { var opt = document.createElement('option'); opt.value = s; opt.innerText = s; if(s === d.namaLokasi) opt.selected = true; sel.appendChild(opt); });
             document.getElementById('set_info').value = d.info; 
             document.getElementById('set_mulai').value = d.jamMulai; 
             document.getElementById('set_selesai').value = d.jamSelesai; 
             document.getElementById('set_batas').value = d.jamBatas;
        }
    }
    
    function simpanSettings() {
        var f = { set_lokasi: document.getElementById('set_lokasi').value, set_info: document.getElementById('set_info').value, set_mulai: document.getElementById('set_mulai').value, set_selesai: document.getElementById('set_selesai').value, set_batas: document.getElementById('set_batas').value };
        callAPI('saveSettings', f).then(r => Swal.fire('Info', r, 'info'));
    }

    function doLogout() { localStorage.removeItem('gugusUser'); location.reload(); }
  </script>
</body>
</html>
