<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Desk Presensi - Gugus Nakula</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* Warna Dasar (Sama dengan Mobile) */
            --md-primary: #B3261E; 
            --md-on-primary: #FFFFFF;
            --md-primary-container: #FFDAD6;
            --md-on-primary-container: #410002;
            --md-surface: #FFF8F7;
            --md-surface-container: #FCEAE9;
            --md-text-main: #201A1A;
            --md-text-sub: #534341;
            
            --sidebar-width: 280px;
            --sidebar-bg: #410E0B; /* Versi Gelap dari Primary agar kontras */
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--md-surface);
            color: var(--md-text-main);
            overflow-x: hidden;
        }

        h1, h2, h3, h4, h5, .fw-google {
            font-family: 'Google Sans', sans-serif;
        }

        /* --- LOGIN SCREEN --- */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(180deg, var(--md-surface) 0%, var(--md-primary-container) 100%);
            z-index: 9999;
            display: flex; align-items: center; justify-content: center;
        }
        .login-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 28px;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(179, 38, 30, 0.15);
            border: 1px solid #fff;
            width: 400px;
            text-align: center;
        }
        .pin-input {
            border: none; border-bottom: 2px solid var(--md-text-sub);
            background: transparent; font-size: 2rem; letter-spacing: 12px;
            color: var(--md-primary); font-weight: bold; text-align: center;
            width: 100%; outline: none; transition: 0.3s;
        }
        .pin-input:focus { border-color: var(--md-primary); }

        /* --- SIDEBAR --- */
        .sidebar {
            height: 100vh; width: var(--sidebar-width);
            position: fixed; top: 0; left: 0;
            background-color: var(--sidebar-bg);
            color: #FFDAD6;
            display: flex; flex-direction: column;
            z-index: 1000;
            box-shadow: 4px 0 20px rgba(0,0,0,0.1);
        }
        .sidebar-header {
            padding: 30px 25px;
            background: rgba(0,0,0,0.1);
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .user-panel {
            padding: 25px;
            background: rgba(255,255,255,0.02);
            display: flex; align-items: center; gap: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .user-avatar {
            width: 50px; height: 50px;
            background: var(--md-primary-container);
            color: var(--md-on-primary-container);
            border-radius: 16px;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 1.2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        /* MENU ITEMS */
        .nav-label {
            font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1.5px;
            color: rgba(255,218,214, 0.5); margin: 25px 25px 10px 25px; font-weight: 700;
        }
        .nav-link {
            color: rgba(255,255,255,0.85);
            padding: 14px 25px; font-size: 0.95rem; font-weight: 500;
            display: flex; align-items: center;
            transition: 0.2s; border-radius: 0 50px 50px 0; margin-right: 15px;
        }
        .nav-link:hover { background: rgba(255,255,255,0.1); color: #fff; }
        .nav-link.active {
            background: var(--md-primary-container);
            color: var(--md-on-primary-container);
            font-weight: 700;
        }
        .nav-link i { width: 28px; font-size: 1.1rem; }

        /* --- MAIN CONTENT --- */
        .main-content {
            margin-left: var(--sidebar-width);
            padding: 35px;
            min-height: 100vh;
        }

        /* --- CARDS & WIDGETS --- */
        .card-stat {
            background: #FFFFFF; border: none;
            border-radius: 24px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.03);
            transition: transform 0.2s;
            height: 100%;
        }
        .card-stat:hover { transform: translateY(-5px); }
        
        .icon-box {
            width: 56px; height: 56px; border-radius: 18px;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem; margin-right: 16px;
        }
        .ib-primary { background: var(--md-surface-container); color: var(--md-primary); }
        .ib-success { background: #C4EED0; color: #074E23; }
        .ib-warn { background: #FFEFBF; color: #765600; }
        .ib-danger { background: #FFDAD6; color: #410E0B; }

        /* Table Card */
        .card-table {
            background: #FFFFFF; border-radius: 28px;
            border: none; box-shadow: 0 4px 20px rgba(0,0,0,0.03);
            overflow: hidden;
        }
        .card-header-custom {
            padding: 25px; background: #fff;
            border-bottom: 1px solid #f0f0f0;
            display: flex; justify-content: space-between; align-items: center;
        }
        
        /* Dropdown Filter Komunitas */
        .com-filter {
            background: #fff; border: 1px solid var(--md-primary-container);
            padding: 8px 20px; border-radius: 50px;
            display: flex; align-items: center; gap: 10px;
            box-shadow: 0 2px 10px rgba(179, 38, 30, 0.05);
            transition: 0.3s;
        }
        .com-filter:hover { border-color: var(--md-primary); }
        .com-filter select {
            border: none; outline: none; background: transparent;
            font-family: 'Google Sans'; font-weight: 600;
            color: var(--md-primary); cursor: pointer; min-width: 220px;
        }

        /* Buttons */
        .btn-primary-md {
            background: var(--md-primary); color: #fff;
            border-radius: 50px; padding: 10px 24px; border: none;
            font-family: 'Google Sans'; font-weight: 500;
            transition: 0.2s;
        }
        .btn-primary-md:hover { background: #9c1c16; color:#fff; transform: scale(1.02); }
        
        .hide { display: none !important; }
        
        /* DataTables Custom */
        .dataTables_wrapper .dataTables_length select { border-radius: 8px; padding: 5px; }
        .dataTables_wrapper .dataTables_filter input { border-radius: 20px; padding: 5px 15px; border: 1px solid #ddd; }
        table.dataTable thead th { background-color: var(--md-surface-container); color: var(--md-text-main); border-bottom: none; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-card">
            <div class="bg-danger bg-opacity-10 rounded-circle d-inline-flex p-4 mb-4">
                <i class="fas fa-desktop fa-3x" style="color: var(--md-primary);"></i>
            </div>
            <h2 class="fw-google fw-bold mb-1" style="color: var(--md-text-main);">Desk Presensi</h2>
            <p style="color: var(--md-text-sub);" class="mb-5">Portal Gugus Nakula</p>
            
            <div class="text-start mb-4 px-3">
                <label class="small fw-bold ms-1 mb-2" style="color:var(--md-primary); letter-spacing:1px;">MASUKKAN PIN</label>
                <input type="password" id="inputPin" class="pin-input" placeholder="• • • • • •">
            </div>
            
            <button onclick="doLogin()" class="btn-primary-md w-100 py-3 shadow-sm">
                MASUK <i class="fas fa-arrow-right ms-2"></i>
            </button>
        </div>
    </div>

    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header d-flex align-items-center gap-3">
            <div style="width: 8px; height: 35px; background: #FFDAD6; border-radius: 4px;"></div>
            <div>
                <h4 class="fw-google m-0 fw-bold">Desk Presensi</h4>
                <small style="opacity:0.7;">Ver 1.0 Admin</small>
            </div>
        </div>
        
        <div class="user-panel">
            <div class="user-avatar" id="avatarInitials">GN</div>
            <div style="line-height: 1.3; overflow: hidden;">
                <div class="fw-bold text-white text-truncate" id="sidebarName" style="max-width: 150px;">Memuat...</div>
                <div class="small text-truncate" id="sidebarRole" style="color: #FFDAD6; opacity:0.8; max-width: 150px;">...</div>
            </div>
        </div>
        
        <div id="menuContainer" style="flex: 1; overflow-y: auto; padding-top: 10px;">
            </div>

        <div class="p-4">
            <button onclick="doLogout()" class="btn btn-outline-light w-100 rounded-pill py-2" style="border-color: rgba(255,255,255,0.3); color: #FFDAD6;">
                <i class="fas fa-sign-out-alt me-2"></i> Keluar
            </button>
        </div>
    </nav>

    <div class="main-content">
        <div class="d-flex justify-content-between align-items-end mb-5">
            <div>
                <h6 class="text-uppercase fw-bold mb-1" style="color: var(--md-primary); letter-spacing: 1px;">Overview</h6>
                <h2 class="fw-google fw-bold m-0" id="pageTitle" style="color: var(--md-text-main);">Dashboard</h2>
            </div>

            <div id="wrapperFilterSekolah" class="hide">
                <div class="com-filter">
                    <i class="fas fa-building" style="color: var(--md-primary);"></i>
                    <select id="selectSekolah" onchange="gantiSekolah()">
                        <option value="">Memuat Data...</option>
                    </select>
                </div>
            </div>

            <div class="text-end d-none d-md-block">
                <h2 class="fw-google fw-bold m-0" id="clockTime" style="color: var(--md-text-main);">00:00</h2>
                <small style="color: var(--md-text-sub);" id="currentDate">...</small>
            </div>
        </div>

        <div id="view-admin-dashboard" class="view-section hide">
            <div class="d-flex align-items-center mb-4 px-2">
                <div class="badge rounded-pill px-3 py-2 me-2" style="background: var(--md-primary-container); color: var(--md-on-primary-container);">
                    <i class="fas fa-info-circle me-1"></i> Status
                </div>
                <span style="color: var(--md-text-sub);">Menampilkan data untuk: <strong id="labelSekolahAktif" style="color: var(--md-primary);">...</strong></span>
            </div>

            <div class="row g-4 mb-4">
                <div class="col-md-3">
                    <div class="card-stat">
                        <div class="d-flex align-items-center">
                            <div class="icon-box ib-primary"><i class="fas fa-users"></i></div>
                            <div><small class="text-muted fw-bold">Total Pegawai</small><h3 class="fw-bold m-0 mt-1" id="statTotal">0</h3></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card-stat">
                        <div class="d-flex align-items-center">
                            <div class="icon-box ib-success"><i class="fas fa-check"></i></div>
                            <div><small class="text-muted fw-bold">Hadir</small><h3 class="fw-bold m-0 mt-1" id="statHadir">0</h3></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card-stat">
                        <div class="d-flex align-items-center">
                            <div class="icon-box ib-warn"><i class="fas fa-clock"></i></div>
                            <div><small class="text-muted fw-bold">Terlambat</small><h3 class="fw-bold m-0 mt-1" id="statTelat">0</h3></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card-stat">
                        <div class="d-flex align-items-center">
                            <div class="icon-box ib-danger"><i class="fas fa-times"></i></div>
                            <div><small class="text-muted fw-bold">Belum Hadir</small><h3 class="fw-bold m-0 mt-1" id="statBelum">0</h3></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card-table">
                <div class="card-header-custom">
                    <h5 class="fw-bold m-0" style="color: var(--md-text-main);"><i class="fas fa-list-alt me-2" style="color: var(--md-primary);"></i>Rekapitulasi Realtime</h5>
                    <button class="btn btn-sm btn-light rounded-pill px-3 fw-bold border" onclick="refreshDataAdmin()" style="color: var(--md-text-sub);">
                        <i class="fas fa-sync-alt me-1"></i> Refresh
                    </button>
                </div>
                <div class="p-3">
                    <table id="tableAdmin" class="table table-hover align-middle w-100" style="border-color: #eee;">
                        <thead><tr><th>Nama Pegawai</th><th>Status</th><th>Jam</th><th>Keterangan</th><th>Foto</th><th>Aksi</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="view-guru-dashboard" class="view-section hide">
             <div class="row mb-4">
                 <div class="col-md-8">
                     <div class="card-stat text-white d-flex flex-column justify-content-center" style="background: linear-gradient(135deg, #B3261E 0%, #601410 100%); border:none; min-height: 200px;">
                        <h2 class="fw-light">Halo, <span id="dashGuruName" class="fw-bold">...</span></h2>
                        <p class="opacity-75 mb-4" id="dashGuruJab">...</p>
                        <div class="d-flex gap-4 mt-auto">
                            <div><small class="opacity-50">Unit Kerja</small><div class="fw-bold" id="dashGuruUnit">-</div></div>
                        </div>
                     </div>
                 </div>
                 <div class="col-md-4">
                     <div class="card-stat">
                         <h6 class="fw-bold text-muted mb-3">Menu Cepat</h6>
                         <button class="btn btn-light w-100 text-start mb-2 py-2 text-muted" onclick="Swal.fire('Info','Gunakan HP untuk Absen','info')"><i class="fas fa-camera me-2 text-danger"></i> Absen Masuk</button>
                         <button class="btn btn-light w-100 text-start py-2 text-muted" onclick="Swal.fire('Info','Gunakan HP untuk Izin','info')"><i class="fas fa-envelope me-2 text-primary"></i> Ajukan Izin</button>
                     </div>
                 </div>
             </div>

            <div class="card-table">
                <div class="card-header-custom">
                    <h5 class="fw-bold m-0"><i class="fas fa-history me-2 text-danger"></i>Riwayat Saya</h5>
                </div>
                <div class="p-3">
                    <table id="tableGuru" class="table table-striped w-100">
                        <thead><tr><th>Tanggal</th><th>Jam</th><th>Status</th><th>Lokasi</th></tr></thead>
                        <tbody id="tbodyGuru"></tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        // URL WEB APP GAS (Backend)
        const API_URL = "https://script.google.com/macros/s/AKfycbweTTiW0sPe1SAnJZlUK4KCiiks4cDhc420PWmvf1IOJ7mIKGUhudz42SpAJ1KZP4__cg/exec"; 
        
        let userData = null;
        let dataTableInstance = null;
        let sekolahAktif = ""; 

        // Clock Update
        setInterval(() => {
            const now = new Date();
            document.getElementById('clockTime').innerText = now.toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'});
            document.getElementById('currentDate').innerText = now.toLocaleDateString('id-ID', {weekday:'long', day:'numeric', month:'long', year:'numeric'});
        }, 1000);

        $(document).ready(function() {
            const saved = sessionStorage.getItem('desk_presensi_user');
            if (saved) { userData = JSON.parse(saved); $('#login-screen').hide(); initDashboard(); }
            $('#inputPin').keypress(function (e) { if (e.which == 13) doLogin(); });
        });

        // --- AUTHENTICATION ---
        async function doLogin() {
            const pin = $('#inputPin').val();
            if (!pin) return Swal.fire({title:'PIN Kosong', icon:'warning', confirmButtonColor:'#B3261E'});
            
            Swal.fire({ title: 'Memeriksa...', didOpen: () => Swal.showLoading() });
            
            try {
                const response = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'login', pin: pin }) });
                const res = await response.json();
                Swal.close();

                if (res.status === 'SUKSES') {
                    userData = res;
                    sessionStorage.setItem('desk_presensi_user', JSON.stringify(res));
                    $('#login-screen').fadeOut();
                    initDashboard();
                } else {
                    Swal.fire({title:'Akses Ditolak', text:'PIN Salah / Tidak Ditemukan', icon:'error', confirmButtonColor:'#B3261E'});
                }
            } catch (e) { Swal.fire('Error', 'Gagal koneksi server', 'error'); }
        }

        function doLogout() {
            Swal.fire({ title: 'Keluar?', icon: 'warning', showCancelButton: true, confirmButtonColor: '#B3261E', confirmButtonText: 'Ya' }).then((r) => {
                if (r.isConfirmed) { sessionStorage.removeItem('desk_presensi_user'); location.reload(); }
            });
        }

        // --- DASHBOARD LOGIC (HIERARKI ADMIN) ---
        async function initDashboard() {
            $('#sidebarName').text(userData.nama);
            $('#sidebarRole').text(userData.jabatan || 'User');
            $('#avatarInitials').text(userData.nama.substring(0,2).toUpperCase());
            if(userData.unitKerja) $('#dashGuruUnit').text(userData.unitKerja);

            let menuHtml = '';
            
            // 1. CEK SUPER ADMIN (ADMIN KOMUNITAS) -> Kolom G = "ADMIN"
            const isCommunityAdmin = userData.isAdmin; 

            // 2. CEK ADMIN SEKOLAH (KS) -> Jabatan mengandung "Kepala"
            const isSchoolAdmin = userData.jabatan && userData.jabatan.toLowerCase().includes('kepala');

            if (isCommunityAdmin) {
                menuHtml += `
                    <div class="nav-label">Admin Komunitas</div>
                    <a class="nav-link" id="link-mon" onclick="switchView('admin-dashboard', this, 'Monitoring Gugus')"><i class="fas fa-globe"></i> Monitoring Gugus</a>
                    <a class="nav-link" onclick="downloadLaporanPDF()"><i class="fas fa-file-pdf"></i> Download Laporan</a>
                `;
                $('#wrapperFilterSekolah').removeClass('hide');
                await loadListSekolah();
                
            } else if (isSchoolAdmin) {
                menuHtml += `
                    <div class="nav-label">Admin Sekolah</div>
                    <a class="nav-link" id="link-mon" onclick="switchView('admin-dashboard', this, 'Monitoring Sekolah')"><i class="fas fa-school"></i> Monitoring Sekolah</a>
                    <a class="nav-link" onclick="downloadLaporanPDF()"><i class="fas fa-file-pdf"></i> Download Laporan</a>
                `;
                $('#wrapperFilterSekolah').addClass('hide');
                sekolahAktif = userData.unitKerja;
                $('#labelSekolahAktif').text(sekolahAktif);
            }

            // MENU PRIBADI
            menuHtml += `
                <div class="nav-label">Pribadi</div>
                <a class="nav-link" id="link-me" onclick="switchView('guru-dashboard', this, 'Dashboard Saya')"><i class="fas fa-user-circle"></i> Data Saya</a>
            `;

            $('#menuContainer').html(menuHtml);

            // Default View
            if (isCommunityAdmin || isSchoolAdmin) {
                switchView('admin-dashboard', document.getElementById('link-mon'), isCommunityAdmin ? 'Monitoring Gugus' : 'Monitoring Sekolah');
                $('#link-mon').addClass('active');
            } else {
                switchView('guru-dashboard', document.getElementById('link-me'), 'Dashboard Saya');
                $('#link-me').addClass('active');
            }
        }

        // --- HELPER FUNCTIONS ---
        async function loadListSekolah() {
            try {
                const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'listSekolah' }) });
                const data = await res.json(); 
                let opts = '<option value="" disabled>-- Pilih Sekolah --</option>';
                data.forEach(s => { opts += `<option value="${Array.isArray(s)?s[0]:s}">${Array.isArray(s)?s[0]:s}</option>`; });
                $('#selectSekolah').html(opts);
                
                if(data.length > 0) {
                    const first = Array.isArray(data[0]) ? data[0][0] : data[0];
                    $('#selectSekolah').val(first);
                    sekolahAktif = first;
                    $('#labelSekolahAktif').text(first);
                }
            } catch(e) {}
        }

        function gantiSekolah() {
            sekolahAktif = $('#selectSekolah').val();
            $('#labelSekolahAktif').text(sekolahAktif);
            refreshDataAdmin(); 
        }

        function switchView(viewName, el, title) {
            $('.view-section').addClass('hide');
            if(el) { $('.nav-link').removeClass('active'); $(el).addClass('active'); }
            if(title) $('#pageTitle').text(title);
            $('#view-' + viewName).removeClass('hide');
            if (viewName === 'admin-dashboard') refreshDataAdmin();
            if (viewName === 'guru-dashboard') loadDataGuru();
        }

        async function refreshDataAdmin() {
            if(!sekolahAktif) return;
            if ($.fn.DataTable.isDataTable('#tableAdmin')) $('#tableAdmin').DataTable().clear().draw();
            
            try {
                const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'monitoring', sekolah: sekolahAktif }) });
                const data = await res.json();

                $('#statTotal').text(data.listSudah.length + data.listBelum.length);
                $('#statHadir').text(data.listSudah.filter(x => x.status.includes('Hadir') || x.status.includes('Tepat')).length);
                $('#statTelat').text(data.listSudah.filter(x => x.status.includes('Terlambat')).length);
                $('#statBelum').text(data.listBelum.length);

                renderTableAdmin([...data.listSudah, ...data.listBelum]);
            } catch (e) { console.error(e); }
        }

        function renderTableAdmin(dataSet) {
            if (dataTableInstance) dataTableInstance.destroy();
            dataTableInstance = $('#tableAdmin').DataTable({
                data: dataSet, pageLength: 10,
                language: { search: "Cari:", lengthMenu: "_MENU_", info: "_START_ - _END_ / _TOTAL_" },
                columns: [
                    { data: 'nama', render: d => `<span class="fw-bold text-dark">${d}</span>` },
                    { data: 'status', render: d => getBadgeStatus(d) },
                    { data: 'jam' },
                    { data: null, render: r => r.alasan ? `<small class="text-muted fst-italic">${r.alasan}</small>` : '-' },
                    { data: 'foto', render: (d,t,r) => d && d.includes('http') ? `<button class="btn btn-sm btn-outline-primary rounded-pill px-3" onclick="lihatFoto('${d}','${r.nama}')"><i class="fas fa-eye"></i></button>` : '-' },
                    { data: null, render: (d,t,r) => r.status && r.status.includes('Menunggu') ? `<div class="btn-group btn-group-sm"><button class="btn btn-success" onclick="acc('${r.nama}','Disetujui')"><i class="fas fa-check"></i></button><button class="btn btn-danger" onclick="acc('${r.nama}','Ditolak')"><i class="fas fa-times"></i></button></div>` : '' }
                ]
            });
        }

        async function loadDataGuru() {
            $('#dashGuruName').text(userData.nama); $('#dashGuruJab').text(userData.jabatan);
            const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'riwayat', nama: userData.nama }) });
            const list = await res.json();
            let html = list.map(i => `<tr><td>${i.tanggal}</td><td class="fw-bold">${i.jam}</td><td>${getBadgeStatus(i.status)}</td><td>${i.lokasi||'-'}</td></tr>`).join('');
            $('#tbodyGuru').html(html || '<tr><td colspan="4" class="text-center text-muted">Belum ada riwayat.</td></tr>');
        }

        function getBadgeStatus(s) {
            let c = 'secondary', i = '';
            if (s.includes('Tepat')) { c='success'; i='check-circle'; }
            else if (s.includes('Terlambat')) { c='warning text-dark'; i='exclamation-circle'; }
            else if (s.includes('Sakit')||s.includes('Izin')) { c='info text-dark'; i='envelope-open'; }
            else if (s.includes('Luar')) { c='danger'; i='map-marker-alt'; }
            return `<span class="badge bg-${c} rounded-pill fw-normal px-3"><i class="fas fa-${i} me-1"></i> ${s}</span>`;
        }

        function lihatFoto(u,n) { Swal.fire({ title:n, imageUrl:u, showConfirmButton:false, showCloseButton:true, width:500, customClass:{image:'rounded-4'} }); }
        
        async function acc(n,s) {
            const c = await Swal.fire({ title:'Konfirmasi', text:`Ubah status ${n} jadi ${s}?`, showCancelButton:true, confirmButtonColor:'#B3261E' });
            if(c.isConfirmed) {
                await fetch(API_URL, { method:'POST', body:JSON.stringify({ action:'updateIzin', nama:n, status:s }) });
                refreshDataAdmin(); Swal.fire('Sukses','Data diperbarui','success');
            }
        }

        function downloadLaporanPDF() {
            let valSekolah = sekolahAktif;
            Swal.fire({
                title: 'Download Laporan',
                html: `Sekolah: <b>${valSekolah}</b><br><br>Tahun:<br><input id="pdfTahun" class="swal2-input" value="${new Date().getFullYear()}">`,
                showCancelButton: true, confirmButtonColor: '#B3261E', confirmButtonText: 'Download'
            }).then(async (res) => {
                if(res.isConfirmed) {
                    Swal.showLoading();
                    const t = document.getElementById('pdfTahun').value;
                    const r = await fetch(API_URL, { method:'POST', body:JSON.stringify({ action:'pdf', sekolah:valSekolah, tahun:t }) });
                    const j = await r.json();
                    if(j.url || (typeof j==='string' && j.includes('http'))) window.open(j.url || j, '_blank');
                    else Swal.fire('Gagal', JSON.stringify(j), 'error');
                }
            });
        }
    </script>
</body>
</html>
