<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    body { font-family: 'Google Sans', sans-serif; background-color: #FFF8F7; display: flex; }
    .sidebar { width: 250px; background: white; height: 100vh; position: fixed; padding: 20px; border-right: 1px solid #eee; z-index: 100; }
    .main-content { margin-left: 250px; padding: 30px; width: 100%; }
    .nav-link { color: #555; padding: 12px 16px; border-radius: 12px; margin-bottom: 5px; text-decoration: none; display: flex; align-items: center; gap: 12px; }
    .nav-link.active { background: #FCEAE9; color: #B3261E; font-weight: 500; }
    .card-dash { border: none; border-radius: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.02); background: white; padding: 20px; margin-bottom: 20px; }
    @media (max-width: 768px) { .sidebar { display:none; } .main-content { margin-left: 0; } }
  </style>
</head>
<body>

  <div class="sidebar">
     <div class="mb-4 text-danger fw-bold fs-5"><i class="fas fa-shield-alt me-2"></i>ADMIN PANEL</div>
     <nav>
        <a href="#" onclick="switchPage('dashboard', this)" class="nav-link active"><i class="fas fa-chart-pie"></i>Dashboard</a>
        <a href="#" onclick="switchPage('monitoring', this)" class="nav-link"><i class="fas fa-eye"></i>Monitoring</a>
        <a href="#" onclick="switchPage('laporan', this)" class="nav-link"><i class="fas fa-file-alt"></i>Laporan</a>
        <a href="#" onclick="switchPage('award', this)" class="nav-link"><i class="fas fa-trophy"></i>Award</a>
        <a href="#" onclick="switchPage('settings', this)" class="nav-link"><i class="fas fa-cog"></i>Pengaturan</a>
        <a href="index.html" class="nav-link text-danger mt-4"><i class="fas fa-sign-out-alt"></i>Keluar</a>
     </nav>
  </div>

  <div class="main-content">
     <div id="pg-dashboard" class="page-section">
        <h4 class="fw-bold mb-4">Dashboard</h4>
        <div class="row g-3">
            <div class="col-md-8"><div class="card-dash"><canvas id="chartKehadiran"></canvas></div></div>
            <div class="col-md-4">
                <div class="card-dash text-center py-5">
                     <h2 class="fw-bold text-success display-4" id="dashHadir">0</h2><p class="text-muted">Sudah Hadir</p>
                     <hr>
                     <h2 class="fw-bold text-danger display-4" id="dashBelum">0</h2><p class="text-muted">Belum Hadir</p>
                </div>
            </div>
        </div>
     </div>

     <div id="pg-monitoring" class="page-section" style="display:none;">
        <h4 class="fw-bold mb-3">Monitoring Live</h4>
        <div class="card-dash table-responsive">
            <table class="table table-hover">
                <thead><tr><th>Nama</th><th>Jam</th><th>Status</th><th>Bukti</th><th>Ket</th><th>Aksi</th></tr></thead>
                <tbody id="tblMonitor"></tbody>
            </table>
        </div>
     </div>

     <div id="pg-laporan" class="page-section" style="display:none;">
        <h4 class="fw-bold mb-3">Rekapitulasi</h4>
        <div class="card-dash">
            <div class="row g-2 mb-3">
                <div class="col-md-4"><select id="lapSekolah" class="form-select"></select></div>
                <div class="col-md-2"><select id="lapTahun" class="form-select"><option value="2026">2026</option></select></div>
                <div class="col-md-2"><button class="btn btn-primary w-100" onclick="loadLaporan()">Tampilkan</button></div>
            </div>
            <table class="table table-bordered"><thead><tr class="table-light"><th>No</th><th>Nama</th><th>Tepat</th><th>Telat</th><th>Luar</th><th>Total</th></tr></thead><tbody id="tblLaporan"></tbody></table>
        </div>
     </div>
     
     <div id="pg-award" class="page-section" style="display:none;">
         <h4 class="fw-bold mb-3">Ranking Poin</h4>
         <div class="card-dash"><table class="table table-striped"><thead><tr><th>Rank</th><th>Sekolah</th><th>Guru</th><th>Poin</th><th>Skor</th></tr></thead><tbody id="tblAward"></tbody></table></div>
     </div>

     <div id="pg-settings" class="page-section" style="display:none;">
         <h4 class="fw-bold mb-3">Pengaturan</h4>
         <div class="card-dash">
             <div class="mb-3"><label>Lokasi Pusat</label><select id="set_lokasi" class="form-select"></select></div>
             <div class="mb-3"><label>Info Teks</label><textarea id="set_info" class="form-control"></textarea></div>
             <div class="row g-2 mb-3"><div class="col-4"><input type="time" id="set_mulai" class="form-control"></div><div class="col-4"><input type="time" id="set_selesai" class="form-control"></div><div class="col-4"><input type="time" id="set_batas" class="form-control border-danger"></div></div>
             <button onclick="simpanSettings()" class="btn btn-primary w-100">Simpan</button>
         </div>
     </div>
  </div>

  <script>
    // --- GANTI URL INI DENGAN URL DEPLOY TERBARU ---
    const API_URL = "https://script.google.com/macros/s/AKfycbweTTiW0sPe1SAnJZlUK4KCiiks4cDhc420PWmvf1IOJ7mIKGUhudz42SpAJ1KZP4__cg/exec";

    var u = JSON.parse(localStorage.getItem('gugusUser'));
    if(!u || !u.isAdmin) location.href='index.html';
    
    async function callAPI(action, data = {}) {
        data.action = action;
        try { let r = await fetch(API_URL, {method:'POST', body:JSON.stringify(data)}); return await r.json(); } catch(e) { return null; }
    }

    function switchPage(page, el) {
        document.querySelectorAll('.page-section').forEach(p => p.style.display='none');
        document.getElementById('pg-'+page).style.display='block';
        document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
        if(el) el.classList.add('active');
        if(page === 'monitoring') loadMonitoring();
        if(page === 'laporan') loadListSekolah();
        if(page === 'award') loadAward();
        if(page === 'settings') loadSettings();
    }
    
    loadDashboard();

    async function loadDashboard() {
        const d = await callAPI('monitoring', {sekolah: u.unitKerja}); 
        if(d) {
            document.getElementById('dashHadir').innerText = d.listSudah.length;
            document.getElementById('dashBelum').innerText = d.listBelum.length;
            new Chart(document.getElementById('chartKehadiran'), { type: 'doughnut', data: { labels: ['Hadir', 'Belum'], datasets: [{ data: [d.listSudah.length, d.listBelum.length], backgroundColor: ['#198754', '#dc3545'] }] } });
        }
    }

    async function loadMonitoring() {
        const d = await callAPI('monitoring', {sekolah: u.unitKerja});
        let html = '';
        if(d) {
            d.listSudah.concat(d.listBelum).forEach(g => {
                let badge = g.status.includes('Tepat')?'bg-success':g.status.includes('Telat')?'bg-warning':g.status.includes('Luar')?'bg-danger':'bg-secondary';
                if(g.status.includes('Izin')) badge = 'bg-info';
                
                let bukti = '';
                if(g.maps && g.maps.includes('http')) bukti += `<a href="${g.maps}" target="_blank" class="btn btn-sm btn-outline-primary me-1"><i class="fas fa-map"></i></a>`;
                if(g.foto && g.foto.includes('http')) bukti += `<button onclick="lihatFoto('${g.foto}')" class="btn btn-sm btn-outline-danger"><i class="fas fa-camera"></i></button>`;
                
                let aksi = '';
                if(g.status.includes('Menunggu')) aksi = `<button class="btn btn-sm btn-success py-0" onclick="accIzin('${g.nama.replace(/'/g,"\\'")}','Disetujui')">✓</button> <button class="btn btn-sm btn-danger py-0" onclick="accIzin('${g.nama.replace(/'/g,"\\'")}','Ditolak')">✗</button>`;
                
                html += `<tr><td>${g.nama}</td><td>${g.jam}</td><td><span class="badge ${badge}">${g.status}</span></td><td>${bukti}</td><td>${g.alasan||'-'}</td><td>${aksi}</td></tr>`;
            });
        }
        document.getElementById('tblMonitor').innerHTML = html;
    }
    
    function accIzin(n, s) { callAPI('updateIzin', {nama:n, status:s}).then(()=>loadMonitoring()); }
    function lihatFoto(u) { Swal.fire({ imageUrl: u, showConfirmButton: false, width: 'auto' }); }

    async function loadListSekolah() {
        const d = await callAPI('listSekolah');
        let html = '<option value="SEMUA">-- Semua --</option>';
        if(d) d.forEach(s => html += `<option value="${s}">${s}</option>`);
        document.getElementById('lapSekolah').innerHTML = html; document.getElementById('lapSekolah').value = u.unitKerja;
    }
    async function loadLaporan() {
        const res = await callAPI('laporan', {sekolah: document.getElementById('lapSekolah').value, tahun: document.getElementById('lapTahun').value});
        let html = '';
        if(res && res.guru) res.guru.forEach((g, i) => html += `<tr><td>${i+1}</td><td>${g.nama}</td><td>${g.tepat}</td><td>${g.telat}</td><td>${g.luar}</td><td>${g.total}</td></tr>`);
        document.getElementById('tblLaporan').innerHTML = html;
    }
    async function loadAward() {
        const d = await callAPI('award', {tahun: 2026});
        let html = '';
        if(d) d.forEach((x,i) => html += `<tr><td>${i+1}</td><td>${x.sekolah}</td><td>${x.guru}</td><td>${x.poin}</td><td>${x.skorAkhir}</td></tr>`);
        document.getElementById('tblAward').innerHTML = html;
    }
    async function loadSettings() {
        const d = await callAPI('getSettings');
        if(d) {
             let sel = document.getElementById('set_lokasi'); sel.innerHTML = "";
             d.listSekolah.forEach(s => { let opt = document.createElement('option'); opt.value = s; opt.innerText = s; if(s === d.nama) opt.selected = true; sel.appendChild(opt); });
             document.getElementById('set_info').value = d.info; document.getElementById('set_mulai').value = d.jamMulai; document.getElementById('set_selesai').value = d.jamSelesai; document.getElementById('set_batas').value = d.jamBatas;
        }
    }
    function simpanSettings() {
        let f = { set_lokasi: document.getElementById('set_lokasi').value, set_info: document.getElementById('set_info').value, set_mulai: document.getElementById('set_mulai').value, set_selesai: document.getElementById('set_selesai').value, set_batas: document.getElementById('set_batas').value };
        callAPI('saveSettings', f).then(r => Swal.fire(r));
    }
  </script>
</body>
</html>
